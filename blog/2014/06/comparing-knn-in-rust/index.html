<!DOCTYPE HTML>
<html lang="en">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>  Comparing k-NN in Rust |  Huon on the internet</title>

  <link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Atom feed">
  <link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="RSS feed">
  
  <link rel="canonical" href="https://huonw.github.io/blog/2014/06/comparing-knn-in-rust/">

  <meta name="viewport" content="width=device-width; initial-scale=1.0;" />
  

  
  <meta name="description" content="Implementing a k-nearest neighbour algorithm in Rust, using the powerful concurrency tools for simple and safe parallelisation.
" />

  
  <meta name="twitter:card" content="summary" />
  
  <meta name="twitter:site" content="@huon_w" />
  <meta name="twitter:title" content="Comparing k-NN in Rust" />
  <meta name="twitter:description" content="Implementing a k-nearest neighbour algorithm in Rust, using the powerful concurrency tools for simple and safe parallelisation.
" />
  <meta name="twitter:url" content="https://huonw.github.io/blog/2014/06/comparing-knn-in-rust/">

  <!-- facebook -->
  <meta property="og:url" content="https://huonw.github.io/blog/2014/06/comparing-knn-in-rust/" />
  <meta property="og:title" content="Comparing k-NN in Rust" />
  <meta property="og:description" content="Implementing a k-nearest neighbour algorithm in Rust, using the powerful concurrency tools for simple and safe parallelisation.
" />
  
  <meta property="og:type" content="article" />
  
  
  
  <style>
    /*! modern-normalize v1.1.0 | MIT License | https://github.com/sindresorhus/modern-normalize */
*,::after,::before{box-sizing:border-box}html{line-height:1.15;-webkit-text-size-adjust:100%;-moz-tab-size:4;tab-size:4}body{margin:0;font-family:system-ui, -apple-system,'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji'}hr{height:0;color:inherit}abbr[title]{text-decoration:underline dotted}b,strong{font-weight:bolder}code,kbd,pre,samp{font-family:ui-monospace, SFMono-Regular, Consolas, 'Liberation Mono', Menlo, monospace;font-size:1em}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-0.25em}sup{top:-0.5em}table{text-indent:0;border-color:inherit}button,input,optgroup,select,textarea{font-family:inherit;font-size:100%;line-height:1.15;margin:0}button,select{text-transform:none}[type='button'],[type='reset'],[type='submit'],button{-webkit-appearance:button}::-moz-focus-inner{border-style:none;padding:0}:-moz-focusring{outline:1px dotted ButtonText}:-moz-ui-invalid{box-shadow:none}legend{padding:0}progress{vertical-align:baseline}::-webkit-inner-spin-button,::-webkit-outer-spin-button{height:auto}[type='search']{-webkit-appearance:textfield;outline-offset:-2px}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}summary{display:list-item}


    
      /* Borrowed from mojombo: https://github.com/mojombo/mojombo.github.com/blob/master/css/syntax.css */

.lineno { width: 2em; text-align:right; }
.highlight pre {
  white-space: pre;
}
.highlight .c { color: #777; font-style: italic; } /* Comment */
.highlight .err { color: #a61717; background-color: #e3d2d2 } /* Error */
.highlight .k { font-weight: bold } /* Keyword */
.highlight .o { font-weight: bold } /* Operator */
.highlight .cm { color: #999988; font-style: italic } /* Comment.Multiline */
.highlight .cp { color: #999999; font-weight: bold } /* Comment.Preproc */
.highlight .c1 { color: #999988; font-style: italic } /* Comment.Single */
.highlight .cs { color: #999999; font-weight: bold; font-style: italic } /* Comment.Special */
.highlight .gd { color: #000000; background-color: #ffdddd } /* Generic.Deleted */
.highlight .gd .x { color: #000000; background-color: #ffaaaa } /* Generic.Deleted.Specific */
.highlight .ge { font-style: italic } /* Generic.Emph */
.highlight .gr { color: #aa0000 } /* Generic.Error */
.highlight .gh { color: #999999 } /* Generic.Heading */
.highlight .gi { color: #000000; background-color: #ddffdd } /* Generic.Inserted */
.highlight .gi .x { color: #000000; background-color: #aaffaa } /* Generic.Inserted.Specific */
.highlight .go { color: #888888 } /* Generic.Output */
.highlight .gp { color: #555555 } /* Generic.Prompt */
.highlight .gs { font-weight: bold } /* Generic.Strong */
.highlight .gu { color: #aaaaaa } /* Generic.Subheading */
.highlight .gt { color: #aa0000 } /* Generic.Traceback */
.highlight .kc { font-weight: bold } /* Keyword.Constant */
.highlight .kd { font-weight: bold } /* Keyword.Declaration */
.highlight .kp { font-weight: bold } /* Keyword.Pseudo */
.highlight .kr { font-weight: bold } /* Keyword.Reserved */
.highlight .kt { color: #445588; font-weight: bold } /* Keyword.Type */
.highlight .m { color: #009999 } /* Literal.Number */
.highlight .s { color: #d14 } /* Literal.String */
.highlight .na { color: #008080 } /* Name.Attribute */
.highlight .nb { color: #0086B3 } /* Name.Builtin */
.highlight .nc { color: #445588; font-weight: bold } /* Name.Class */
.highlight .no { color: #008080 } /* Name.Constant */
.highlight .ni { color: #800080 } /* Name.Entity */
.highlight .ne { color: #990000; font-weight: bold } /* Name.Exception */
.highlight .nf { color: #990000; font-weight: bold } /* Name.Function */
.highlight .nn { color: #555555 } /* Name.Namespace */
.highlight .nt { color: #000080 } /* Name.Tag */
.highlight .nv { color: #008080 } /* Name.Variable */
.highlight .ow { font-weight: bold } /* Operator.Word */
.highlight .w { color: #bbbbbb } /* Text.Whitespace */
.highlight .mf { color: #009999 } /* Literal.Number.Float */
.highlight .mh { color: #009999 } /* Literal.Number.Hex */
.highlight .mi { color: #009999 } /* Literal.Number.Integer */
.highlight .mo { color: #009999 } /* Literal.Number.Oct */
.highlight .sb { color: #d14 } /* Literal.String.Backtick */
.highlight .sc { color: #d14 } /* Literal.String.Char */
.highlight .sd { color: #d14 } /* Literal.String.Doc */
.highlight .s2 { color: #d14 } /* Literal.String.Double */
.highlight .se { color: #d14 } /* Literal.String.Escape */
.highlight .sh { color: #d14 } /* Literal.String.Heredoc */
.highlight .si { color: #d14 } /* Literal.String.Interpol */
.highlight .sx { color: #d14 } /* Literal.String.Other */
.highlight .sr { color: #009926 } /* Literal.String.Regex */
.highlight .s1 { color: #d14 } /* Literal.String.Single */
.highlight .ss { color: #990073 } /* Literal.String.Symbol */
.highlight .bp { color: #999999 } /* Name.Builtin.Pseudo */
.highlight .vc { color: #008080 } /* Name.Variable.Class */
.highlight .vg { color: #008080 } /* Name.Variable.Global */
.highlight .vi { color: #008080 } /* Name.Variable.Instance */
.highlight .il { color: #009999 } /* Literal.Number.Integer.Long */


html {
    min-height:100%;
}

* {
  margin: 0;
}
* + * {
  margin-top: 0.75em;
}


body {
  padding:0px;
    counter-reset: footnotes;
    counter-reset: figure;
    margin:0px;
    font-size: 18px;
    background: white;
    color: #101010;

    font-variant: common-ligatures;
    -moz-font-feature-settings: "kern" on;
    -webkit-font-feature-settings: "kern" on;
    font-feature-settings: "kern" on;
}

#wrapper {
    margin: 0 auto;
    max-width: 630px;
    padding: 0.75em 15px;
    width: 100%;
    position:relative;
}

.lazily-filled {
  position: relative;
}
.lazily-filled > * {
  z-index: 0;
}
.lazily-filled::before {
  position: absolute;
  top: 0;
  left: 0;
  content: "";
  width: 100%;
  height: 100%;
  display: block;
  background-color: rgb(229, 236, 246);
  z-index: 1;
}
.lazily-filled::after {
  position: absolute;
  top: 50%;
  left: 50%;
  content: "";
  display: block;
  width: 128px;
  height: 128px;
  margin-left: -64px;
  margin-top: -64px;
  border-radius: 50%;
  border: 12px solid;
  border-color: white transparent;
  animation: spinner 5s linear;
  /* eventually stop animating when it's hidden */
  animation-iteration-count: 10;
  z-index: 2;
}
.lazily-filled::before, .lazily-filled::after {
  opacity: 0;
  transition: all 0.5s ease;
  pointer-events: none;
}
.lazily-filled:empty::before, .lazily-filled:empty::after {
  opacity: 1;
  animation-iteration-count: infinite;
  visibility: visible;
}
@keyframes spinner {
  0% {
    transform: rotate(0deg);
  }
  100% {
    transform: rotate(360deg);
  }
}

.plotly-plot * + * {
  margin-top: 0;
}

/* wonky safari */
.plotly text[style*="white-space: pre"] {
  white-space: nowrap !important;
}


/* lists */
li + li {
  margin-top: 0.5em;
}
ul, ol {
  padding-left: 1.5em;
}

table {
  margin-left: auto;
  margin-right: auto;
  border-collapse: collapse;
  text-align: left;
}

td, th {
  padding: 0.1em 0.75em;
}
@media (max-width: 500px) {
  td, th {
    padding-left: 0.375em;
    padding-right: 0.375em;
  }
}
tr:nth-child(even) {
  background: rgba(0, 0, 0, 5%);
}
thead {
  border-bottom: 1px solid grey;
  font-weight: bold;
}

header {
  margin-bottom: 1.5em;
}
header a:not(:hover) {
  text-decoration: none;
}
#blog-title {
  hyphens: none;
  font-variant: small-caps;
  font-size: 1.5em;
  font-weight: normal;
  text-align: center;
  line-height: 1em;
}
#info-list {
  list-style: none;
  padding: 0;
  display: flex;
  justify-content: center;
  flex-wrap: wrap;
}
#info-list li {
  margin: 0 1em;
}

#page-footer {
  border-top: 1px solid lightgrey;
  padding-top: 0.75em;
  color: grey;
  text-align: right;
}

.clear { clear: both; margin: 0; }


main {
    text-align:justify;
    -moz-hyphens: auto;
    -webkit-hyphens: auto;
    -ms-hyphens: auto;
    hyphens: auto;
    line-height: 1.5em;

    position: relative;
    z-index: 10;
}

a[href] {
    color: inherit;
    text-decoration: underline;
}

/*  The authorship info */
#info-intro {
    font-style: italic;
    text-align: center;
}

/* code */

code, pre {
  font-family: monospace;
  font-variant: none;
  -moz-hyphens: none;
  -webkit-hyphens: none;
  -ms-hyphens: none;
  hyphens: none;
}

pre {
  background: #f0f0f0;
}
code {
    background: #f7f7f7;
    padding: 0 0.1em;
    font-size: 0.9em;
    border-radius: 3px;
    border: 1px solid lightgrey;
}
pre code {
    background: none;
    padding: 0;
    -moz-hyphens: none;
    -webkit-hyphens: none;
    -ms-hyphens: none;
    hyphens: none;
    border-radius: 0;
    border-width: 0;
}
h1 code, h2 code, h3 code, h4 code {
  background: rgba(255,255,255,0.1);
}

.break-all {
  word-break: break-all;
}

/* quotes and similar */

blockquote {
    border: solid #eee;
    border-width: 0 1px;
    padding: 0 1.2em;
    color: #444;
    position: relative;
    margin-left: 0;
    margin-right: 0;
}

aside {
  padding: 0 1.2em;
  color: #444;
  position: relative;
}
aside[data-icon] {
  padding-left: 2.4em;
}
aside[data-icon]:before {
  content: attr(data-icon);
  position: absolute;
  left: 0;
  text-align: center;
  width: 2.4em;
}

/* images/figures */
img, figure svg {
  max-width: 100%;
  height: auto;
}
figure svg {
  width: 100%;
}
img:not(.inline-image), figure svg {
    display: block;
    margin: 0 auto;
    clear: both;
}

.image-positioner {
  max-width: 800px;
  margin-left: auto;
  margin-right: auto;
}

img[data-caption]:before {
    content: attr(data-caption);
}
figure {
  clear: both;
}
figure.image {
  width: 100vw;
  position: relative;
  left: 50%;
  right: 50%;
  margin-left: -50vw;
  margin-right: -50vw;

  min-width: 100%;
}
figcaption {
  margin: 0 auto;
  max-width: 570px;
  padding: 0 10px;
  text-align: center;
  font-style: italic;
  font-size: 0.9em;
}
figcaption p {
  display: inline;
}
figcaption::before {
  counter-increment: figure;
  content: "Figure " counter(figure) ". ";
}

.highlight table {
  font-size: 0.9em;
  padding: 0em;
  width: 100%;
  table-layout: fixed;
  overflow-y: hidden;
  display: block;
  position: relative;
  z-index: 1;
}
[data-lang] {
  position: relative;
  display: block;
}
[data-lang]::before {
  content: attr(data-lang);
  text-transform: capitalize;
  top: 0;
  right: 0;
  position: absolute;
  font-size: 1.5em;
  color: #f3f3f3;
  z-index: 1;
}

.highlight pre {
  background: transparent;
}
.gutter {
  padding: 0;
  border: solid #ccc;
  border-width: 0 1px 0 0;
  color: #ccc;
}
.lineno {
  width: 25px;
  padding-right: 5px;
}
.highlight td.code {
  overflow-x: auto;
  padding: 0;
  padding-left: 0.5em;
}


/* HEADINGS */

h1, h2 {
    font-variant: small-caps;
}

h1, h2, h3, h4 {
  -moz-hyphens: none;
  -webkit-hyphens: none;
  -ms-hyphens: none;
  hyphens: none;
  text-align: left;
}

h1 {
  font-size: 2.2em;
  text-align: center;
  line-height: 1em;
}
h2 {
  font-size: 1.7em;
}
h3 {
  font-size: 1.4em;
}
h4 {
  font-size: 1.2em;
}

/* crates.io badges */

.lib-info {
  float: right;
  width: 150px;
  text-align: center;
  margin: 0 1em;
}
.lib-badge {
  vertical-align: middle;
}
.centered-libs {
  text-align: center;
}
.centered-libs .lib-info {
  float: none;
}

/* external links */

#external-links {
  margin-top: 2.25em;
  text-align: center;
}
.external-label {
  font-weight: bold;
}
#external-links ul {
  list-style: none;
  display: inline-block;
  padding: 0;
  margin: 0;
}
#external-links li {
  list-style: none;
  display: inline;
}

/* "Footnotes" */

/* the div that holds them */
.footnotes {
    margin-top: 2.25em;
    padding-top: 1.5em;
    border-top: 1px solid rgb(240,240,240);
    font-size: 0.9em;
}
.footnotes ol {
  padding: 0;
}
.footnotes li {
    list-style-position: outside;
    margin-left: 30px;
    margin-right: 10px;
    color: #333;
}

.footnotes li:target, .footnotes li:hover {
    color: black;
    background-color: lightyellow;
}

.footnotes .reversefootnote {
    text-decoration: none;
}

/* extra info after a post */
#more {
  margin-top: 3em;
  padding-top: 1.5em;
  border-top: 1px solid lightgray;
}
#me-icon {
  max-width: 150px;
  height: 150px;
  background: url("/img/me.jpg");
  background-size: cover;
  margin-left: auto;
  margin-right: auto;
  border-radius: 30px;
}
#by-line {
  font-size: 0.8em;
}
#latest-list {
  padding: 0;
  list-style: none;
}
#latest-heading {
  text-align: center;
}
#latest-heading a:not(:hover) {
  text-decoration: none;
}
#latest-list a:hover h3 {
  text-decoration: underline;
}
#latest-list a {
  text-decoration: none;
}
.latest-post {
  padding: 0;
  font-size: 0.8em;
}
.latest-post > h3 {
  font-weight: bold;
}
.latest-post * {
  margin: 0;
}

/* post series */

.post-series {
  font-size: 0.8em;
  border: 1px solid lightgray;
  padding: 0.2em;
  cursor: pointer;
}

.post-series-title {
  font-weight: bold;
  font-size: 1.1em;
}
.post-series-list {
  padding-left: 1.5em;
  margin: 0;
}
.post-series .current {
  font-style: italic;
}

/* archive pages */
ul.post-list {
  list-style: none;
  padding: 0;
}

.post-post {
  margin: 0;
}

.post-post + .post-post {
  border-top: 1px dashed  #ddd;
  margin-top: 1em;
  padding-top: 1em;
}

a.post-heading {
  display: flex;
  align-items: baseline;
  text-decoration: none;
  gap: 1em;
}
.post-heading * {
  margin: 0;
}

.post-title {
  font-size: 1.2em;
  flex-grow: 1;
  text-decoration: underline;
}

.post-heading .post-date {
  font-style: italic;
  flex-shrink: 0;
}

.post-excerpt p {
  display: inline;
}

.post-more {
  font-style: italic;
  white-space: nowrap;
  float: right;
  margin: 0;
  font-size: smaller;
}

.post-list .footnote, .post-list .footnotes, .post-list p:empty {
  display: none
}

/* media queries */


@media only print {
    a {
      text-decoration: none !important;
    }
    header {
        display:none !important;
    }

    h1, h2, h3, h4 {
        padding-left: 0 !important;
    }

    #wrapper {
       max-width: none !important;
    }

    .no-print {
        display: none !important;
    }

    .footnotes .reversefootnote {
         display: none !important;
    }
    [data-lang]::before {
      content: "";
    }
}

    

    
  </style>
  
</head>

<body>
<div id="wrapper">
  <header>
    <h1 id="blog-title"><a href="/">Huon on the internet</a></h1>
    <nav>
      <ul id="info-list" class="no-print">
        <li><a href="/about">About</a></li>
        <li><a href="/blog">Blog</a></li>
        <li><a href="https://github.com/huonw">GitHub</a></li>
        <li><a href="https://twitter.com/huon_w">Twitter</a></li>
      </ul>
    </nav>
  </header>
  <main>
    <article>
      
        <h1 id="title"> Comparing k-NN in Rust</h1>
        
      
      
         <div id="info-intro">
           By <a href="/about">Huon Wilson</a>
           
             &mdash; <span class="date pub-date">10 Jun 2014</span>
           
           
         </div>
      
      <p>In my voyages around the internet, I came across <a href="http://philtomson.github.io/blog/2014/05/29/comparing-a-machine-learning-algorithm-implemented-in-f-number-and-ocaml/">a pair</a> of
<a href="http://philtomson.github.io/blog/2014/05/30/stop-the-presses-ocaml-wins/">blog posts</a> which compare the implementation of a
<em>k</em>-nearest neighbour (<em>k</em>-NN) classifier in F# and OCaml. I couldn’t
resist writing the code into <a href="http://rust-lang.org/">Rust</a> to see how it fared.</p>

<p>Rust is a memory-safe systems language under heavy development; this
code compiles with <a href="http://www.rust-lang.org/install.html">the latest nightly</a> (as of 2014-06-10 12:00 UTC),
specifically <code class="language-plaintext highlighter-rouge">rustc 0.11.0-pre-nightly (e55f64f 2014-06-09 01:11:58
-0700)</code>.</p>

<h2 id="code">Code</h2>

<p>The Rust code is a nearly-direct translation of the original F# code,
the only change was changing <code class="language-plaintext highlighter-rouge">distance</code> to compute the squared
distance, that is, <code class="language-plaintext highlighter-rouge">a*a + b*b + ...</code> (square root is strictly
increasing, yo).</p>

<p>For clarity, all errors are ignored (that’s the <code class="language-plaintext highlighter-rouge">.unwrap()</code> calls):
the input is assumed to be valid and IO is assumed to succeed. I wrote
<a href="/blog/2014/06/error-handling-in-rust-knn-case-study/">a follow-up post describing how one would handle errors</a>. Also,
I made no effort to remove/reduce/streamline allocations.</p>

<figure class="highlight"><pre><code class="language-rust" data-lang="rust"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
</pre></td><td class="code"><pre><span class="k">use</span> <span class="nn">std</span><span class="p">::</span><span class="nn">io</span><span class="p">::{</span><span class="n">File</span><span class="p">,</span> <span class="n">BufferedReader</span><span class="p">};</span>

<span class="k">struct</span> <span class="n">LabelPixel</span> <span class="p">{</span>
    <span class="n">label</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">pixels</span><span class="p">:</span> <span class="nb">Vec</span><span class="o">&lt;</span><span class="nb">int</span><span class="o">&gt;</span>
<span class="p">}</span>


<span class="k">fn</span> <span class="nf">slurp_file</span><span class="p">(</span><span class="n">file</span><span class="p">:</span> <span class="o">&amp;</span><span class="n">Path</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="nb">Vec</span><span class="o">&lt;</span><span class="n">LabelPixel</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="nn">BufferedReader</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span><span class="nn">File</span><span class="p">::</span><span class="nf">open</span><span class="p">(</span><span class="n">file</span><span class="p">)</span><span class="nf">.unwrap</span><span class="p">())</span>
        <span class="nf">.lines</span><span class="p">()</span>
        <span class="nf">.skip</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="nf">.map</span><span class="p">(|</span><span class="n">line</span><span class="p">|</span> <span class="p">{</span>
            <span class="k">let</span> <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="nf">.unwrap</span><span class="p">();</span>
            <span class="k">let</span> <span class="k">mut</span> <span class="n">iter</span> <span class="o">=</span> <span class="n">line</span><span class="nf">.as_slice</span><span class="p">()</span><span class="nf">.trim</span><span class="p">()</span>
                <span class="nf">.split</span><span class="p">(</span><span class="sc">','</span><span class="p">)</span>
                <span class="nf">.map</span><span class="p">(|</span><span class="n">x</span><span class="p">|</span> <span class="nf">from_str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="nf">.unwrap</span><span class="p">());</span>

            <span class="n">LabelPixel</span> <span class="p">{</span>
                <span class="n">label</span><span class="p">:</span> <span class="n">iter</span><span class="nf">.next</span><span class="p">()</span><span class="nf">.unwrap</span><span class="p">(),</span>
                <span class="n">pixels</span><span class="p">:</span> <span class="n">iter</span><span class="nf">.collect</span><span class="p">()</span>
            <span class="p">}</span>
        <span class="p">})</span>
        <span class="nf">.collect</span><span class="p">()</span>
<span class="p">}</span>

<span class="k">fn</span> <span class="nf">distance_sqr</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="o">&amp;</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">y</span><span class="p">:</span> <span class="o">&amp;</span><span class="p">[</span><span class="nb">int</span><span class="p">])</span> <span class="k">-&gt;</span> <span class="nb">int</span> <span class="p">{</span>
    <span class="c">// run through the two vectors, summing up the squares of the differences</span>
    <span class="n">x</span><span class="nf">.iter</span><span class="p">()</span>
        <span class="nf">.zip</span><span class="p">(</span><span class="n">y</span><span class="nf">.iter</span><span class="p">())</span>
        <span class="nf">.fold</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">|</span><span class="n">s</span><span class="p">,</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">a</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">b</span><span class="p">)|</span> <span class="n">s</span> <span class="o">+</span> <span class="p">(</span><span class="n">a</span> <span class="o">-</span> <span class="n">b</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">a</span> <span class="o">-</span> <span class="n">b</span><span class="p">))</span>
<span class="p">}</span>

<span class="k">fn</span> <span class="nf">classify</span><span class="p">(</span><span class="n">training</span><span class="p">:</span> <span class="o">&amp;</span><span class="p">[</span><span class="n">LabelPixel</span><span class="p">],</span> <span class="n">pixels</span><span class="p">:</span> <span class="o">&amp;</span><span class="p">[</span><span class="nb">int</span><span class="p">])</span> <span class="k">-&gt;</span> <span class="nb">int</span> <span class="p">{</span>
    <span class="n">training</span>
        <span class="nf">.iter</span><span class="p">()</span>
        <span class="c">// find element of `training` with the smallest distance_sqr to `pixel`</span>
        <span class="nf">.min_by</span><span class="p">(|</span><span class="n">p</span><span class="p">|</span> <span class="nf">distance_sqr</span><span class="p">(</span><span class="n">p</span><span class="py">.pixels</span><span class="nf">.as_slice</span><span class="p">(),</span> <span class="n">pixels</span><span class="p">))</span><span class="nf">.unwrap</span><span class="p">()</span>
        <span class="py">.label</span>
<span class="p">}</span>

<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">let</span> <span class="n">training_set</span> <span class="o">=</span> <span class="nf">slurp_file</span><span class="p">(</span><span class="o">&amp;</span><span class="nn">Path</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span><span class="s">"trainingsample.csv"</span><span class="p">));</span>
    <span class="k">let</span> <span class="n">validation_sample</span> <span class="o">=</span> <span class="nf">slurp_file</span><span class="p">(</span><span class="o">&amp;</span><span class="nn">Path</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span><span class="s">"validationsample.csv"</span><span class="p">));</span>

    <span class="k">let</span> <span class="n">num_correct</span> <span class="o">=</span> <span class="n">validation_sample</span><span class="nf">.iter</span><span class="p">()</span>
        <span class="nf">.filter</span><span class="p">(|</span><span class="n">x</span><span class="p">|</span> <span class="p">{</span>
            <span class="nf">classify</span><span class="p">(</span><span class="n">training_set</span><span class="nf">.as_slice</span><span class="p">(),</span> <span class="n">x</span><span class="py">.pixels</span><span class="nf">.as_slice</span><span class="p">())</span> <span class="o">==</span> <span class="n">x</span><span class="py">.label</span>
        <span class="p">})</span>
        <span class="nf">.count</span><span class="p">();</span>

    <span class="nd">println!</span><span class="p">(</span><span class="s">"Percentage correct: {}%"</span><span class="p">,</span>
             <span class="n">num_correct</span> <span class="k">as</span> <span class="nb">f64</span> <span class="o">/</span> <span class="n">validation_sample</span><span class="nf">.len</span><span class="p">()</span> <span class="k">as</span> <span class="nb">f64</span> <span class="o">*</span> <span class="mf">100.0</span><span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>(Prints <code class="language-plaintext highlighter-rouge">Percentage correct: 94.4%</code>, matching the OCaml.)</p>

<h2 id="hows-it-compare">How’s it compare?</h2>

<p>I don’t have an F# compiler, so I’ll only compare against the fastest
OCaml solution (from <a href="http://philtomson.github.io/blog/2014/05/30/stop-the-presses-ocaml-wins/">the follow-up post</a>), after making the
same modification to <code class="language-plaintext highlighter-rouge">distance</code>.</p>

<p>The Rust was compiled with <code class="language-plaintext highlighter-rouge">rustc -O</code>, and the OCaml with <code class="language-plaintext highlighter-rouge">ocamlopt
str.cmxa</code> (as recommended), using version 4.01.0. I ran each 3 times
(times in seconds) on <a href="https://github.com/c4fsharp/Dojo-Digits-Recognizer/tree/1eb4297a49dbd82a952c1523f5413519b8f1d62a/Dojo">these CSV files</a>.</p>

<table>
  <thead>
    <tr>
      <th style="text-align: right">Lang</th>
      <th style="text-align: right">1</th>
      <th style="text-align: right">2</th>
      <th style="text-align: right">3</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: right">Rust</td>
      <td style="text-align: right">3.56</td>
      <td style="text-align: right">3.46</td>
      <td style="text-align: right">3.86</td>
    </tr>
    <tr>
      <td style="text-align: right">OCaml</td>
      <td style="text-align: right">13.9</td>
      <td style="text-align: right">14.7</td>
      <td style="text-align: right">14.1</td>
    </tr>
  </tbody>
</table>

<p>So the Rust code is about 3.5–4× faster than the
OCaml.</p>

<p>It’s worth noting that the Rust code is entirely safe and built
directly (and mostly minimally) using the abstractions provided by the
standard library. The speed is mainly due to the magic of
<a href="http://doc.rust-lang.org/master/std/iter/">Rust’s (lazy) iterators</a>
which provide very efficient sequential access to elements of
vectors/slices, as well as a variety of efficient
<a href="http://doc.rust-lang.org/master/guide-container.html#iterator-adaptors">adaptors</a>
implementing various useful algorithms. These may look high-level and
hard to optimise, but they are very transparent to the compiler,
resulting in fast machine code.</p>

<blockquote>
  <p><em>Updated 2014-06-11</em>: the Rust code is not as fast as it could be,
due to bugs like
<a href="https://github.com/mozilla/rust/issues/11751">#11751</a>, caused by
LLVM being unable to understand that <code class="language-plaintext highlighter-rouge">&amp;</code> pointers are never
null. benh wrote a <a href="https://gist.github.com/huonw/7b7473ac3981fead07ab">short slice-zip iterator</a> that may
make its way into the standard library: he even
<a href="https://news.ycombinator.com/item?id=7875969">used it</a> to make the
code 3 times faster.</p>
</blockquote>

<p>In comparison, the OCaml code has had to manually write a few
functions (for folding and for reading lines from a file), and
contains two possibly-concerning pieces of code:</p>

<figure class="highlight"><pre><code class="language-ocaml" data-lang="ocaml"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
</pre></td><td class="code"><pre><span class="k">let</span> <span class="n">v1</span> <span class="o">=</span> <span class="n">unsafe_get</span> <span class="n">a1</span> <span class="n">i</span> <span class="k">in</span>
<span class="k">let</span> <span class="n">v2</span> <span class="o">=</span> <span class="n">unsafe_get</span> <span class="n">a2</span> <span class="n">i</span> <span class="k">in</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>It might be interesting to compare against
<a href="http://leonardo-m.livejournal.com/111598.html">this D code</a>, but I
can’t get it to compile right.</p>

<h2 id="what-about-parallelism">What about parallelism?</h2>

<p>I’m glad you asked! Rust is designed to be good for concurrency, using
<a href="http://doc.rust-lang.org/master/std/kinds/trait.Share.html">the type system</a>
to guarantee that code is threadsafe. As I said before, Rust is under
heavy development, and currently lacks a data parallelism library (so
there’s no parallel-map to just call directly yet), but it’s easy
enough to use
<a href="http://doc.rust-lang.org/master/sync/struct.Future.html">the built-in futures</a>
for this.</p>

<p>The code can be made parallel simply by replacing the <code class="language-plaintext highlighter-rouge">main</code> function
with the following.</p>

<figure class="highlight"><pre><code class="language-rust" data-lang="rust"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
</pre></td><td class="code"><pre><span class="c">// how many chunks should the validation sample be divided into? (==</span>
<span class="c">// how many futures to create.)</span>
<span class="k">static</span> <span class="n">NUM_CHUNKS</span><span class="p">:</span> <span class="nb">uint</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>

<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">use</span> <span class="nn">sync</span><span class="p">::{</span><span class="nb">Arc</span><span class="p">,</span> <span class="n">Future</span><span class="p">};</span>
    <span class="k">use</span> <span class="nn">std</span><span class="p">::</span><span class="n">cmp</span><span class="p">;</span>

    <span class="c">// "atomic reference counted": guaranteed thread-safe shared</span>
    <span class="c">// memory. The type signature and API of `Arc` guarantees that</span>
    <span class="c">// concurrent access to the contents will be safe, due to the `Share`</span>
    <span class="c">// trait.</span>
    <span class="k">let</span> <span class="n">training_set</span> <span class="o">=</span> <span class="nn">Arc</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span><span class="nf">slurp_file</span><span class="p">(</span><span class="o">&amp;</span><span class="nn">Path</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span><span class="s">"trainingsample.csv"</span><span class="p">)));</span>
    <span class="k">let</span> <span class="n">validation_sample</span> <span class="o">=</span> <span class="nn">Arc</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span><span class="nf">slurp_file</span><span class="p">(</span><span class="o">&amp;</span><span class="nn">Path</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span><span class="s">"validationsample.csv"</span><span class="p">)));</span>

    <span class="k">let</span> <span class="n">chunk_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">validation_sample</span><span class="nf">.len</span><span class="p">()</span> <span class="o">+</span> <span class="n">NUM_CHUNKS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">NUM_CHUNKS</span><span class="p">;</span>

    <span class="k">let</span> <span class="k">mut</span> <span class="n">futures</span> <span class="o">=</span> <span class="nf">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">NUM_CHUNKS</span><span class="p">)</span><span class="nf">.map</span><span class="p">(|</span><span class="n">i</span><span class="p">|</span> <span class="p">{</span>
        <span class="c">// create new "copies" (just incrementing the reference</span>
        <span class="c">// counts) for our new future to handle.</span>
        <span class="k">let</span> <span class="n">ts</span> <span class="o">=</span> <span class="n">training_set</span><span class="nf">.clone</span><span class="p">();</span>
        <span class="k">let</span> <span class="n">vs</span> <span class="o">=</span> <span class="n">validation_sample</span><span class="nf">.clone</span><span class="p">();</span>

        <span class="nn">Future</span><span class="p">::</span><span class="nf">spawn</span><span class="p">(</span><span class="nf">proc</span><span class="p">()</span> <span class="p">{</span>
            <span class="c">// compute the region of the vector we are handling...</span>
            <span class="k">let</span> <span class="n">lo</span> <span class="o">=</span> <span class="n">i</span> <span class="o">*</span> <span class="n">chunk_size</span><span class="p">;</span>
            <span class="k">let</span> <span class="n">hi</span> <span class="o">=</span> <span class="nn">cmp</span><span class="p">::</span><span class="nf">min</span><span class="p">(</span><span class="n">lo</span> <span class="o">+</span> <span class="n">chunk_size</span><span class="p">,</span> <span class="n">vs</span><span class="nf">.len</span><span class="p">());</span>

            <span class="c">// ... and then handle that region.</span>
            <span class="n">vs</span><span class="nf">.slice</span><span class="p">(</span><span class="n">lo</span><span class="p">,</span> <span class="n">hi</span><span class="p">)</span>
                <span class="nf">.iter</span><span class="p">()</span>
                <span class="nf">.filter</span><span class="p">(|</span><span class="n">x</span><span class="p">|</span> <span class="p">{</span>
                    <span class="nf">classify</span><span class="p">(</span><span class="n">ts</span><span class="nf">.as_slice</span><span class="p">(),</span> <span class="n">x</span><span class="py">.pixels</span><span class="nf">.as_slice</span><span class="p">())</span> <span class="o">==</span> <span class="n">x</span><span class="py">.label</span>
                <span class="p">})</span>
                <span class="nf">.count</span><span class="p">()</span>
        <span class="p">})</span>
    <span class="p">})</span><span class="py">.collect</span><span class="p">::</span><span class="o">&lt;</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="n">Future</span><span class="o">&lt;</span><span class="nb">uint</span><span class="o">&gt;&gt;&gt;</span><span class="p">();</span>

    <span class="c">// run through the futures (waiting for each to complete) and sum the results</span>
    <span class="k">let</span> <span class="n">num_correct</span> <span class="o">=</span> <span class="n">futures</span><span class="nf">.mut_iter</span><span class="p">()</span><span class="nf">.map</span><span class="p">(|</span><span class="n">f</span><span class="p">|</span> <span class="n">f</span><span class="nf">.get</span><span class="p">())</span><span class="nf">.fold</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">|</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">|</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="p">);</span>

    <span class="nd">println!</span><span class="p">(</span><span class="s">"Percentage correct: {}%"</span><span class="p">,</span>
             <span class="n">num_correct</span> <span class="k">as</span> <span class="nb">f64</span> <span class="o">/</span> <span class="n">validation_sample</span><span class="nf">.len</span><span class="p">()</span> <span class="k">as</span> <span class="nb">f64</span> <span class="o">*</span> <span class="mf">100.0</span><span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>(Also prints <code class="language-plaintext highlighter-rouge">Percentage correct: 94.4%</code>.)</p>

<p>This gives a nice speed up, approximately halving the time required:
the real time is now stable around 1.81 seconds (6.25 s of user time)
on my machine.</p>

<section id="external-links" class="no-print">
  
  <div id="comments">
    <span class="external-label">Comments:</span>
    <ul class="external-list">
      

      
<li class="external-link"><a href="http://www.reddit.com/r/rust/comments/27s7ei/comparing_knn_in_rust/">/r/rust</a></li>


      
<li class="external-link"><a href="http://www.reddit.com/r/programming/comments/27s7g6/comparing_knn_in_rust/">/r/programming</a></li>


      
<li class="external-link"><a href="https://news.ycombinator.com/item?id=7872398">Hacker News</a></li>


      

      
    </ul>
  </div>
  
  <div id="external-page">
    <span class="external-label">Share this on</span>
    <ul class="external-list">
      <li class="external-link"><a href="https://twitter.com/intent/tweet?text=Comparing%20k-NN%20in%20Rust%20%23rustlang&amp;url=https://huonw.github.io/blog/2014/06/comparing-knn-in-rust/&amp;via=huon_w" target="_blank" rel="nofollow noopener" title="Share on Twitter">Twitter</a></li>
      <li class="external-link"><a href="https://facebook.com/sharer.php?u=https://huonw.github.io/blog/2014/06/comparing-knn-in-rust/" rel="nofollow noopener" target="_blank" title="Share on Facebook">Facebook</a></li>
      <li class="external-link"><a href="https://www.reddit.com/submit?url=https://huonw.github.io/blog/2014/06/comparing-knn-in-rust/&amp;title=Comparing%20k-NN%20in%20Rust" rel="nofollow noopener" target="_blank" title="Share on Reddit">Reddit</a></li>
    </ul>
  </div>
</section>


    </article>

    
    <footer id="more" class="no-print">
      <div id="by-line">
  <a href="/about"><div class="no-print" id="me-icon"></div></a>

<p>I'm <strong>Huon Wilson</strong> <a href="https://twitter.com/huon_w">@huon_w</a>, a
 mathematically and statistically inclined software engineer.
 I have been a long-term volunteer
 on <a href="http://rust-lang.org">Rust</a>'s core team, a
 compiler engineer on the <a href="https://swift.org/">Swift</a> team
 at Apple, and a senior software engineer at CSIRO's Data61, working on the <a href="https://github.com/stellargraph/stellargraph">StellarGraph
 graph machine learning library</a>.
</p>
</div>
      <h2 id="latest-heading"><a href="/blog">Latest posts</a></h2>
      
      <nav>
        <ul id="latest-list"><!--
           
           --><li class="latest-post">
                <a href="/blog/2024/03/qr-base10-base64/">
                   <h3>10 > 64, in QR codes</h3>
                     <p>QR codes reverse the usual order: decimal works better than base64 for encoding binary data, despite it requiring many more digits.
</p>
                   
                 </a>
            </li><!--
          
           --><li class="latest-post">
                <a href="/blog/2021/10/nsw-covid-qr/">
                   <h3>Mechanical sympathy for QR codes: making NSW check-in better</h3>
                     <p>QR codes are now critical infrastructure here in NSW, Australia. Let’s learn how to make them better.
</p>
                   
                 </a>
            </li><!--
          
           --><li class="latest-post">
                <a href="/blog/2021/09/qr-error-correction/">
                   <h3>QR error correction helps and hinders scanning</h3>
                     <p>A QR code can use one of four error correction levels. Higher error correction forces denser codes, but allows scanning in more situations. A trade-off!
</p>
                   
                 </a>
            </li><!--
          
      --></ul>
      </nav>
    </footer>
    
  </main>

  <footer id="page-footer">
    <span>Huon Wilson &mdash; <span class="date">2021</span></span>
  </footer>
</div>



<!-- Default Statcounter code for huonw.github.io
http://huonw.github.io -->
<script type="text/javascript">
var sc_project=7439209;
var sc_invisible=1;
var sc_security="b96244c7";
</script>
<script type="text/javascript"
src="https://www.statcounter.com/counter/counter.js"
async></script>
<noscript><div class="statcounter"><a title="hit counter"
href="https://statcounter.com/" target="_blank"><img
class="statcounter"
src="https://c.statcounter.com/7439209/0/b96244c7/1/"
alt="hit counter"
referrerPolicy="no-referrer-when-downgrade"></a></div></noscript>
<!-- End of Statcounter Code -->

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-62534856-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-62534856-1');
</script>



</body> </html>
