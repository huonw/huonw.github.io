<!DOCTYPE HTML>
<html lang="en">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>  Error handling in Rust: a k-NN case study |  Huon on the internet</title>

  <link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Atom feed">
  <link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="RSS feed">
  
  <link rel="canonical" href="https://huonw.github.io/blog/2014/06/error-handling-in-rust-knn-case-study/">

  <meta name="viewport" content="width=device-width; initial-scale=1.0;" />
  

  
  <meta name="description" content="Exploring idiomatic methods of handling runtime errors in Rust.
" />

  
  <meta name="twitter:card" content="summary" />
  
  <meta name="twitter:site" content="@huon_w" />
  <meta name="twitter:title" content="Error handling in Rust: a k-NN case study" />
  <meta name="twitter:description" content="Exploring idiomatic methods of handling runtime errors in Rust.
" />
  <meta name="twitter:url" content="https://huonw.github.io/blog/2014/06/error-handling-in-rust-knn-case-study/">

  <!-- facebook -->
  <meta property="og:url" content="https://huonw.github.io/blog/2014/06/error-handling-in-rust-knn-case-study/" />
  <meta property="og:title" content="Error handling in Rust: a k-NN case study" />
  <meta property="og:description" content="Exploring idiomatic methods of handling runtime errors in Rust.
" />
  
  <meta property="og:type" content="article" />
  
  
  
  <style>
    /*! modern-normalize v1.1.0 | MIT License | https://github.com/sindresorhus/modern-normalize */
*,::after,::before{box-sizing:border-box}html{line-height:1.15;-webkit-text-size-adjust:100%;-moz-tab-size:4;tab-size:4}body{margin:0;font-family:system-ui, -apple-system,'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji'}hr{height:0;color:inherit}abbr[title]{text-decoration:underline dotted}b,strong{font-weight:bolder}code,kbd,pre,samp{font-family:ui-monospace, SFMono-Regular, Consolas, 'Liberation Mono', Menlo, monospace;font-size:1em}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-0.25em}sup{top:-0.5em}table{text-indent:0;border-color:inherit}button,input,optgroup,select,textarea{font-family:inherit;font-size:100%;line-height:1.15;margin:0}button,select{text-transform:none}[type='button'],[type='reset'],[type='submit'],button{-webkit-appearance:button}::-moz-focus-inner{border-style:none;padding:0}:-moz-focusring{outline:1px dotted ButtonText}:-moz-ui-invalid{box-shadow:none}legend{padding:0}progress{vertical-align:baseline}::-webkit-inner-spin-button,::-webkit-outer-spin-button{height:auto}[type='search']{-webkit-appearance:textfield;outline-offset:-2px}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}summary{display:list-item}


    
      /* Borrowed from mojombo: https://github.com/mojombo/mojombo.github.com/blob/master/css/syntax.css */

.lineno { width: 2em; text-align:right; }
.highlight pre {
  white-space: pre;
}
.highlight .c { color: #777; font-style: italic; } /* Comment */
.highlight .err { color: #a61717; background-color: #e3d2d2 } /* Error */
.highlight .k { font-weight: bold } /* Keyword */
.highlight .o { font-weight: bold } /* Operator */
.highlight .cm { color: #999988; font-style: italic } /* Comment.Multiline */
.highlight .cp { color: #999999; font-weight: bold } /* Comment.Preproc */
.highlight .c1 { color: #999988; font-style: italic } /* Comment.Single */
.highlight .cs { color: #999999; font-weight: bold; font-style: italic } /* Comment.Special */
.highlight .gd { color: #000000; background-color: #ffdddd } /* Generic.Deleted */
.highlight .gd .x { color: #000000; background-color: #ffaaaa } /* Generic.Deleted.Specific */
.highlight .ge { font-style: italic } /* Generic.Emph */
.highlight .gr { color: #aa0000 } /* Generic.Error */
.highlight .gh { color: #999999 } /* Generic.Heading */
.highlight .gi { color: #000000; background-color: #ddffdd } /* Generic.Inserted */
.highlight .gi .x { color: #000000; background-color: #aaffaa } /* Generic.Inserted.Specific */
.highlight .go { color: #888888 } /* Generic.Output */
.highlight .gp { color: #555555 } /* Generic.Prompt */
.highlight .gs { font-weight: bold } /* Generic.Strong */
.highlight .gu { color: #aaaaaa } /* Generic.Subheading */
.highlight .gt { color: #aa0000 } /* Generic.Traceback */
.highlight .kc { font-weight: bold } /* Keyword.Constant */
.highlight .kd { font-weight: bold } /* Keyword.Declaration */
.highlight .kp { font-weight: bold } /* Keyword.Pseudo */
.highlight .kr { font-weight: bold } /* Keyword.Reserved */
.highlight .kt { color: #445588; font-weight: bold } /* Keyword.Type */
.highlight .m { color: #009999 } /* Literal.Number */
.highlight .s { color: #d14 } /* Literal.String */
.highlight .na { color: #008080 } /* Name.Attribute */
.highlight .nb { color: #0086B3 } /* Name.Builtin */
.highlight .nc { color: #445588; font-weight: bold } /* Name.Class */
.highlight .no { color: #008080 } /* Name.Constant */
.highlight .ni { color: #800080 } /* Name.Entity */
.highlight .ne { color: #990000; font-weight: bold } /* Name.Exception */
.highlight .nf { color: #990000; font-weight: bold } /* Name.Function */
.highlight .nn { color: #555555 } /* Name.Namespace */
.highlight .nt { color: #000080 } /* Name.Tag */
.highlight .nv { color: #008080 } /* Name.Variable */
.highlight .ow { font-weight: bold } /* Operator.Word */
.highlight .w { color: #bbbbbb } /* Text.Whitespace */
.highlight .mf { color: #009999 } /* Literal.Number.Float */
.highlight .mh { color: #009999 } /* Literal.Number.Hex */
.highlight .mi { color: #009999 } /* Literal.Number.Integer */
.highlight .mo { color: #009999 } /* Literal.Number.Oct */
.highlight .sb { color: #d14 } /* Literal.String.Backtick */
.highlight .sc { color: #d14 } /* Literal.String.Char */
.highlight .sd { color: #d14 } /* Literal.String.Doc */
.highlight .s2 { color: #d14 } /* Literal.String.Double */
.highlight .se { color: #d14 } /* Literal.String.Escape */
.highlight .sh { color: #d14 } /* Literal.String.Heredoc */
.highlight .si { color: #d14 } /* Literal.String.Interpol */
.highlight .sx { color: #d14 } /* Literal.String.Other */
.highlight .sr { color: #009926 } /* Literal.String.Regex */
.highlight .s1 { color: #d14 } /* Literal.String.Single */
.highlight .ss { color: #990073 } /* Literal.String.Symbol */
.highlight .bp { color: #999999 } /* Name.Builtin.Pseudo */
.highlight .vc { color: #008080 } /* Name.Variable.Class */
.highlight .vg { color: #008080 } /* Name.Variable.Global */
.highlight .vi { color: #008080 } /* Name.Variable.Instance */
.highlight .il { color: #009999 } /* Literal.Number.Integer.Long */


html {
    min-height:100%;
}

* {
  margin: 0;
}
* + * {
  margin-top: 0.75em;
}


body {
  padding:0px;
    counter-reset: footnotes;
    counter-reset: figure;
    margin:0px;
    font-size: 18px;
    background: white;
    color: #101010;

    font-variant: common-ligatures;
    -moz-font-feature-settings: "kern" on;
    -webkit-font-feature-settings: "kern" on;
    font-feature-settings: "kern" on;
}

#wrapper {
    margin: 0 auto;
    max-width: 630px;
    padding: 0.75em 15px;
    width: 100%;
    position:relative;
}

.lazily-filled {
  position: relative;
}
.lazily-filled > * {
  z-index: 0;
}
.lazily-filled::before {
  position: absolute;
  top: 0;
  left: 0;
  content: "";
  width: 100%;
  height: 100%;
  display: block;
  background-color: rgb(229, 236, 246);
  z-index: 1;
}
.lazily-filled::after {
  position: absolute;
  top: 50%;
  left: 50%;
  content: "";
  display: block;
  width: 128px;
  height: 128px;
  margin-left: -64px;
  margin-top: -64px;
  border-radius: 50%;
  border: 12px solid;
  border-color: white transparent;
  animation: spinner 5s linear;
  /* eventually stop animating when it's hidden */
  animation-iteration-count: 10;
  z-index: 2;
}
.lazily-filled::before, .lazily-filled::after {
  opacity: 0;
  transition: all 0.5s ease;
  pointer-events: none;
}
.lazily-filled:empty::before, .lazily-filled:empty::after {
  opacity: 1;
  animation-iteration-count: infinite;
  visibility: visible;
}
@keyframes spinner {
  0% {
    transform: rotate(0deg);
  }
  100% {
    transform: rotate(360deg);
  }
}

.plotly-plot * + * {
  margin-top: 0;
}

/* wonky safari */
.plotly text[style*="white-space: pre"] {
  white-space: nowrap !important;
}


/* lists */
li + li {
  margin-top: 0.5em;
}
ul, ol {
  padding-left: 1.5em;
}

table {
  margin-left: auto;
  margin-right: auto;
  border-collapse: collapse;
  text-align: left;
}

td, th {
  padding: 0.1em 0.75em;
}
@media (max-width: 500px) {
  td, th {
    padding-left: 0.375em;
    padding-right: 0.375em;
  }
}
tr:nth-child(even) {
  background: rgba(0, 0, 0, 5%);
}
thead {
  border-bottom: 1px solid grey;
  font-weight: bold;
}

header {
  margin-bottom: 1.5em;
}
header a:not(:hover) {
  text-decoration: none;
}
#blog-title {
  hyphens: none;
  font-variant: small-caps;
  font-size: 1.5em;
  font-weight: normal;
  text-align: center;
  line-height: 1em;
}
#info-list {
  list-style: none;
  padding: 0;
  display: flex;
  justify-content: center;
  flex-wrap: wrap;
}
#info-list li {
  margin: 0 1em;
}

#page-footer {
  border-top: 1px solid lightgrey;
  padding-top: 0.75em;
  color: grey;
  text-align: right;
}

.clear { clear: both; margin: 0; }


main {
    text-align:justify;
    -moz-hyphens: auto;
    -webkit-hyphens: auto;
    -ms-hyphens: auto;
    hyphens: auto;
    line-height: 1.5em;

    position: relative;
    z-index: 10;
}

a[href] {
    color: inherit;
    text-decoration: underline;
}

/*  The authorship info */
#info-intro {
    font-style: italic;
    text-align: center;
}

/* code */

code, pre {
  font-family: monospace;
  font-variant: none;
  -moz-hyphens: none;
  -webkit-hyphens: none;
  -ms-hyphens: none;
  hyphens: none;
}

pre {
  background: #f0f0f0;
}
code {
    background: #f7f7f7;
    padding: 0 0.1em;
    font-size: 0.9em;
    border-radius: 3px;
    border: 1px solid lightgrey;
}
pre code {
    background: none;
    padding: 0;
    -moz-hyphens: none;
    -webkit-hyphens: none;
    -ms-hyphens: none;
    hyphens: none;
    border-radius: 0;
    border-width: 0;
}
h1 code, h2 code, h3 code, h4 code {
  background: rgba(255,255,255,0.1);
}

.break-all {
  word-break: break-all;
}

/* quotes and similar */

blockquote {
    border: solid #eee;
    border-width: 0 1px;
    padding: 0 1.2em;
    color: #444;
    position: relative;
    margin-left: 0;
    margin-right: 0;
}

aside {
  padding: 0 1.2em;
  color: #444;
  position: relative;
}
aside[data-icon] {
  padding-left: 2.4em;
}
aside[data-icon]:before {
  content: attr(data-icon);
  position: absolute;
  left: 0;
  text-align: center;
  width: 2.4em;
}

/* images/figures */
img, figure svg {
  max-width: 100%;
  height: auto;
}
figure svg {
  width: 100%;
}
img:not(.inline-image), figure svg {
    display: block;
    margin: 0 auto;
    clear: both;
}

.image-positioner {
  max-width: 800px;
  margin-left: auto;
  margin-right: auto;
}

img[data-caption]:before {
    content: attr(data-caption);
}
figure {
  clear: both;
}
figure.image {
  width: 100vw;
  position: relative;
  left: 50%;
  right: 50%;
  margin-left: -50vw;
  margin-right: -50vw;

  min-width: 100%;
}
figcaption {
  margin: 0 auto;
  max-width: 570px;
  padding: 0 10px;
  text-align: center;
  font-style: italic;
  font-size: 0.9em;
}
figcaption p {
  display: inline;
}
figcaption::before {
  counter-increment: figure;
  content: "Figure " counter(figure) ". ";
}

.highlight table {
  font-size: 0.9em;
  padding: 0em;
  width: 100%;
  table-layout: fixed;
  overflow-y: hidden;
  display: block;
  position: relative;
  z-index: 1;
}
[data-lang] {
  position: relative;
  display: block;
}
[data-lang]::before {
  content: attr(data-lang);
  text-transform: capitalize;
  top: 0;
  right: 0;
  position: absolute;
  font-size: 1.5em;
  color: #f3f3f3;
  z-index: 1;
}

.highlight pre {
  background: transparent;
}
.gutter {
  padding: 0;
  border: solid #ccc;
  border-width: 0 1px 0 0;
  color: #ccc;
}
.lineno {
  width: 25px;
  padding-right: 5px;
}
.highlight td.code {
  overflow-x: auto;
  padding: 0;
  padding-left: 0.5em;
}


/* HEADINGS */

h1, h2 {
    font-variant: small-caps;
}

h1, h2, h3, h4 {
  -moz-hyphens: none;
  -webkit-hyphens: none;
  -ms-hyphens: none;
  hyphens: none;
  text-align: left;
}

h1 {
  font-size: 2.2em;
  text-align: center;
  line-height: 1em;
}
h2 {
  font-size: 1.7em;
}
h3 {
  font-size: 1.4em;
}
h4 {
  font-size: 1.2em;
}

/* crates.io badges */

.lib-info {
  float: right;
  width: 150px;
  text-align: center;
  margin: 0 1em;
}
.lib-badge {
  vertical-align: middle;
}
.centered-libs {
  text-align: center;
}
.centered-libs .lib-info {
  float: none;
}

/* external links */

#external-links {
  margin-top: 2.25em;
  text-align: center;
}
.external-label {
  font-weight: bold;
}
#external-links ul {
  list-style: none;
  display: inline-block;
  padding: 0;
  margin: 0;
}
#external-links li {
  list-style: none;
  display: inline;
}

/* "Footnotes" */

/* the div that holds them */
.footnotes {
    margin-top: 2.25em;
    padding-top: 1.5em;
    border-top: 1px solid rgb(240,240,240);
    font-size: 0.9em;
}
.footnotes ol {
  padding: 0;
}
.footnotes li {
    list-style-position: outside;
    margin-left: 30px;
    margin-right: 10px;
    color: #333;
}

.footnotes li:target, .footnotes li:hover {
    color: black;
    background-color: lightyellow;
}

.footnotes .reversefootnote {
    text-decoration: none;
}

/* extra info after a post */
#more {
  margin-top: 3em;
  padding-top: 1.5em;
  border-top: 1px solid lightgray;
}
#me-icon {
  max-width: 150px;
  height: 150px;
  background: url("/img/me.jpg");
  background-size: cover;
  margin-left: auto;
  margin-right: auto;
  border-radius: 30px;
}
#by-line {
  font-size: 0.8em;
}
#latest-list {
  padding: 0;
  list-style: none;
}
#latest-heading {
  text-align: center;
}
#latest-heading a:not(:hover) {
  text-decoration: none;
}
#latest-list a:hover h3 {
  text-decoration: underline;
}
#latest-list a {
  text-decoration: none;
}
.latest-post {
  padding: 0;
  font-size: 0.8em;
}
.latest-post > h3 {
  font-weight: bold;
}
.latest-post * {
  margin: 0;
}

/* post series */

.post-series {
  font-size: 0.8em;
  border: 1px solid lightgray;
  padding: 0.2em;
  cursor: pointer;
}

.post-series-title {
  font-weight: bold;
  font-size: 1.1em;
}
.post-series-list {
  padding-left: 1.5em;
  margin: 0;
}
.post-series .current {
  font-style: italic;
}

/* archive pages */
ul.post-list {
  list-style: none;
  padding: 0;
}

.post-post {
  margin: 0;
}

.post-post + .post-post {
  border-top: 1px dashed  #ddd;
  margin-top: 1em;
  padding-top: 1em;
}

a.post-heading {
  display: flex;
  align-items: baseline;
  text-decoration: none;
  gap: 1em;
}
.post-heading * {
  margin: 0;
}

.post-title {
  font-size: 1.2em;
  flex-grow: 1;
  text-decoration: underline;
}

.post-heading .post-date {
  font-style: italic;
  flex-shrink: 0;
}

.post-excerpt p {
  display: inline;
}

.post-more {
  font-style: italic;
  white-space: nowrap;
  float: right;
  margin: 0;
  font-size: smaller;
}

.post-list .footnote, .post-list .footnotes, .post-list p:empty {
  display: none
}

/* media queries */


@media only print {
    a {
      text-decoration: none !important;
    }
    header {
        display:none !important;
    }

    h1, h2, h3, h4 {
        padding-left: 0 !important;
    }

    #wrapper {
       max-width: none !important;
    }

    .no-print {
        display: none !important;
    }

    .footnotes .reversefootnote {
         display: none !important;
    }
    [data-lang]::before {
      content: "";
    }
}

    

    
  </style>
  
</head>

<body>
<div id="wrapper">
  <header>
    <h1 id="blog-title"><a href="/">Huon on the internet</a></h1>
    <nav>
      <ul id="info-list" class="no-print">
        <li><a href="/about">About</a></li>
        <li><a href="/blog">Blog</a></li>
        <li><a href="https://github.com/huonw">GitHub</a></li>
        <li><a href="https://bsky.app/profile/huonw.bsky.social">Bluesky</a></li>
      </ul>
    </nav>
  </header>
  <main>
    <article>
      
        <h1 id="title"> Error handling in Rust: a k-NN case study</h1>
        
      
      
         <div id="info-intro">
           By <a href="/about">Huon Wilson</a>
           
             &mdash; <span class="date pub-date">11 Jun 2014</span>
           
           
         </div>
      
      <p>After posting
<a href="/blog/2014/06/comparing-knn-in-rust/">a Rust translation of some <em>k</em>-nearest neighbour code</a>,
I got a <a href="https://news.ycombinator.com/item?id=7875378">few</a>
<a href="https://news.ycombinator.com/item?id=7872878">comments</a> asking “how
would you handle errors if you wanted to?”. This is the perfect chance
to briefly demonstrate a few idioms.</p>

<p>See my <a href="/blog/2014/06/comparing-knn-in-rust/">previous post</a> for context and the original
code; like with the code in that post, this code compiles with <code class="language-plaintext highlighter-rouge">rustc
0.11.0-pre-nightly (e55f64f 2014-06-09 01:11:58 -0700)</code></p>

<h2 id="what-type-of-error-handling-to-use">What type of error handling to use?</h2>

<p>The “canonical” way is to use type system, with types like
<a href="http://doc.rust-lang.org/master/std/result/type.Result.html"><code class="language-plaintext highlighter-rouge">Result&lt;A, B&gt;</code></a>, which can either be an <code class="language-plaintext highlighter-rouge">Ok</code> containing a
value of type <code class="language-plaintext highlighter-rouge">A</code> or an <code class="language-plaintext highlighter-rouge">Err</code> containing a <code class="language-plaintext highlighter-rouge">B</code> (isomorphic to
Haskell’s <code class="language-plaintext highlighter-rouge">Either</code>), and <a href="http://doc.rust-lang.org/master/std/option/type.Option.html"><code class="language-plaintext highlighter-rouge">Option&lt;T&gt;</code></a>, which is either a
<code class="language-plaintext highlighter-rouge">Some</code> containing a <code class="language-plaintext highlighter-rouge">T</code>, or just <code class="language-plaintext highlighter-rouge">None</code> containing no data.</p>

<p>The standard library uses <code class="language-plaintext highlighter-rouge">Result</code> and <code class="language-plaintext highlighter-rouge">Option</code> pervasively, meaning
you can essentially be guaranteed to handle all errors (and
theoretically never crash) as long as you avoid calling
<a href="http://doc.rust-lang.org/master/core/result/type.Result.html#method.unwrap"><code class="language-plaintext highlighter-rouge">unwrap</code></a> and the small number of similar methods. For
example, <a href="http://doc.rust-lang.org/master/std/io/index.html#error-handling">almost all IO actions</a> return an
<a href="http://doc.rust-lang.org/master/std/io/type.IoResult.html"><code class="language-plaintext highlighter-rouge">IoResult&lt;...&gt;</code></a>, which defines the possible errors via the
<a href="http://doc.rust-lang.org/master/std/io/struct.IoError.html"><code class="language-plaintext highlighter-rouge">IoError</code></a> type and its contained <code class="language-plaintext highlighter-rouge">IoErrorKind</code> enum.</p>

<p>An approximation of monadic short-circuiting is provided for <code class="language-plaintext highlighter-rouge">Result</code>
by
<a href="http://doc.rust-lang.org/master/std/result/#the-try!-macro">the <code class="language-plaintext highlighter-rouge">try!</code> macro</a>,
which just returns immediately if an error occurs (that is, if
variable with type <code class="language-plaintext highlighter-rouge">Result</code> is an <code class="language-plaintext highlighter-rouge">Err</code>), propagating it upwards for
the caller to handle. However, <code class="language-plaintext highlighter-rouge">try!</code> isn’t the only strategy, and
it’s easy to define custom handlers, as I do below.</p>

<p>Before you ask: Rust lacks conventional exceptions (since these are
hard to make memory safe without a garbage collector, as I understand
it); in safe code/by default, unwinding can only be stopped at task
boundaries.</p>

<h2 id="the-bullet-proof-code">The bullet-proof code</h2>

<p>The <code class="language-plaintext highlighter-rouge">try!</code> macro and <code class="language-plaintext highlighter-rouge">IoError</code> form my inspiration for the code to
handle errors in <code class="language-plaintext highlighter-rouge">slurp_file</code>: define an enum with the various failure
conditions, and <a href="http://doc.rust-lang.org/master/guide-macros.html">define a short custom macro</a> that either
“unwrap”s or short-circuits to return the appropriate error marker.</p>

<figure class="highlight"><pre><code class="language-rust" data-lang="rust"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
</pre></td><td class="code"><pre><span class="nd">#![feature(macro_rules)]</span>

<span class="c">// the possible things that can go wrong</span>
<span class="k">enum</span> <span class="n">SlurpError</span> <span class="p">{</span>
    <span class="c">// The input was malformed (could have line/column number info too)</span>
    <span class="n">InvalidInput</span><span class="p">,</span>
    <span class="c">// Some piece of IO failed (e.g. couldn't open a file)</span>
    <span class="nf">FailedIo</span><span class="p">(</span><span class="n">IoError</span><span class="p">)</span>
<span class="p">}</span>

<span class="c">// short-circuiting macro: "unwrap" the value, an error will return</span>
<span class="c">// from the surrounding function propagating that error upwards.</span>
<span class="c">//</span>
<span class="c">// macro_rules! macros take a sequence of tokens/AST non-terminals and</span>
<span class="c">// attempt to pattern match on them, taking the first branch that</span>
<span class="c">// fits, and then effectively replace the macro invocation with the</span>
<span class="c">// right-hand side of that branch.</span>
<span class="nd">macro_rules!</span> <span class="n">try_slurp</span> <span class="p">{</span>
    <span class="c">// `$...` is a special variable, a "macro argument", this `value`</span>
    <span class="c">// is an expression, e.g. `1 + 2`, `foo()`, `if ... { ... } else {</span>
    <span class="c">// ... }`. Hence, to match, this arm needs to be passed an</span>
    <span class="c">// expression, a comma, then a literal `FailedIo`.</span>
    <span class="c">// e.g. `try_slurp!(foo(), FailedIo)`</span>
    <span class="p">(</span><span class="nv">$value</span><span class="p">:</span> <span class="n">expr</span><span class="p">,</span> <span class="n">FailedIo</span><span class="p">)</span> <span class="k">=&gt;</span> <span class="p">{</span>
        <span class="c">// The macro expands to this code if the pattern matches. The</span>
        <span class="c">// `$value` expression is `match`d as a `Result&lt;..., IoError&gt;`</span>
        <span class="c">// (passing in something else will be a type error, after the</span>
        <span class="c">// macro expands). Success is unwrapped, and a failure is</span>
        <span class="c">// returned from the function/closure in which the macro is</span>
        <span class="c">// called.</span>
        <span class="k">match</span> <span class="nv">$value</span> <span class="p">{</span>
            <span class="nf">Ok</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">=&gt;</span> <span class="n">x</span><span class="p">,</span>
            <span class="nf">Err</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="k">=&gt;</span> <span class="k">return</span> <span class="nf">Err</span><span class="p">(</span><span class="nf">FailedIo</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
        <span class="p">}</span>
    <span class="p">};</span>

    <span class="c">// similarly here, this branch takes an arbitrary expression and</span>
    <span class="c">// then has to match exactly `InvalidInput`</span>
    <span class="p">(</span><span class="nv">$value</span><span class="p">:</span> <span class="n">expr</span><span class="p">,</span> <span class="n">InvalidInput</span><span class="p">)</span> <span class="k">=&gt;</span> <span class="p">{</span>
        <span class="c">// as above, except handling `$value` as an `Option&lt;...&gt;`.</span>
        <span class="k">match</span> <span class="nv">$value</span> <span class="p">{</span>
            <span class="nf">Some</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">=&gt;</span> <span class="n">x</span><span class="p">,</span>
            <span class="nb">None</span> <span class="k">=&gt;</span> <span class="k">return</span> <span class="nf">Err</span><span class="p">(</span><span class="n">InvalidInput</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">fn</span> <span class="nf">slurp_file</span><span class="p">(</span><span class="n">file</span><span class="p">:</span> <span class="o">&amp;</span><span class="n">Path</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="n">Result</span><span class="o">&lt;</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="n">LabelPixel</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">SlurpError</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="k">use</span> <span class="nn">std</span><span class="p">::{</span><span class="n">result</span><span class="p">,</span> <span class="n">option</span><span class="p">};</span>
    <span class="k">let</span> <span class="k">mut</span> <span class="n">file</span> <span class="o">=</span> <span class="nn">BufferedReader</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span><span class="nd">try_slurp!</span><span class="p">(</span><span class="nn">File</span><span class="p">::</span><span class="nf">open</span><span class="p">(</span><span class="n">file</span><span class="p">),</span> <span class="n">FailedIo</span><span class="p">));</span>

    <span class="k">let</span> <span class="n">lines</span> <span class="o">=</span> <span class="n">file</span><span class="nf">.lines</span><span class="p">()</span>
        <span class="nf">.skip</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="nf">.map</span><span class="p">(|</span><span class="n">line</span><span class="p">|</span> <span class="p">{</span>
            <span class="k">let</span> <span class="n">line</span> <span class="o">=</span> <span class="nd">try_slurp!</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">FailedIo</span><span class="p">);</span>

            <span class="k">let</span> <span class="k">mut</span> <span class="n">splits</span> <span class="o">=</span> <span class="n">line</span><span class="nf">.as_slice</span><span class="p">()</span><span class="nf">.trim</span><span class="p">()</span><span class="nf">.split</span><span class="p">(</span><span class="sc">','</span><span class="p">)</span><span class="nf">.map</span><span class="p">(|</span><span class="n">x</span><span class="p">|</span> <span class="nf">from_str</span><span class="p">(</span><span class="n">x</span><span class="p">));</span>

            <span class="c">// .and_then is flattening Option&lt;Option&lt;int&gt;&gt; to Option&lt;int&gt;.</span>
            <span class="k">let</span> <span class="n">label</span> <span class="o">=</span> <span class="nd">try_slurp!</span><span class="p">(</span><span class="n">splits</span><span class="nf">.next</span><span class="p">()</span><span class="nf">.and_then</span><span class="p">(|</span><span class="n">x</span><span class="p">|</span> <span class="n">x</span><span class="p">),</span> <span class="n">InvalidInput</span><span class="p">);</span>

            <span class="k">let</span> <span class="n">pixels</span> <span class="o">=</span> <span class="nd">try_slurp!</span><span class="p">(</span><span class="nn">option</span><span class="p">::</span><span class="nf">collect</span><span class="p">(</span><span class="n">splits</span><span class="p">),</span> <span class="n">InvalidInput</span><span class="p">);</span>

            <span class="nf">Ok</span><span class="p">(</span><span class="n">LabelPixel</span> <span class="p">{</span>
                <span class="n">label</span><span class="p">:</span> <span class="n">label</span><span class="p">,</span>
                <span class="n">pixels</span><span class="p">:</span> <span class="n">pixels</span>
            <span class="p">})</span>
        <span class="p">});</span>

    <span class="nn">result</span><span class="p">::</span><span class="nf">collect</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></figure>

<blockquote>
  <p>vbhit provides <a href="http://www.reddit.com/r/rust/comments/27tuu5/error_handling_in_rust_a_knn_case_study/ci4nvpi.">a nice alternative implementation</a> that
avoids defining the macro.</p>
</blockquote>

<p>The return value can then be pattern-matched where-ever <code class="language-plaintext highlighter-rouge">slurp_file</code>
is called, and the error propagated upwards there, or handled
appropriately e.g. the <code class="language-plaintext highlighter-rouge">slurp_file</code> calls in <code class="language-plaintext highlighter-rouge">main</code> could be changed
to something like:</p>

<figure class="highlight"><pre><code class="language-rust" data-lang="rust"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="code"><pre><span class="k">let</span> <span class="n">training_set</span> <span class="o">=</span> <span class="k">match</span> <span class="nf">slurp_file</span><span class="p">(</span><span class="o">&amp;</span><span class="nn">Path</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span><span class="s">"trainingsample.csv"</span><span class="p">))</span> <span class="p">{</span>
    <span class="nf">Ok</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="k">=&gt;</span> <span class="n">data</span><span class="p">,</span>
    <span class="nf">Err</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="k">=&gt;</span> <span class="p">{</span>
        <span class="k">match</span> <span class="n">e</span> <span class="p">{</span>
            <span class="nf">FailedIo</span><span class="p">(</span><span class="n">io</span><span class="p">)</span> <span class="k">=&gt;</span> <span class="nd">println!</span><span class="p">(</span><span class="s">"Couldn't read file: {}"</span><span class="p">,</span> <span class="n">io</span><span class="p">),</span>
            <span class="n">InvalidInput</span> <span class="k">=&gt;</span> <span class="nd">println!</span><span class="p">(</span><span class="s">"Invalid file format"</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="nn">std</span><span class="p">::</span><span class="nn">os</span><span class="p">::</span><span class="nf">set_exit_status</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
        <span class="k">return</span>
    <span class="p">}</span>
<span class="p">};</span>
</pre></td></tr></tbody></table></code></pre></figure>

<h2 id="collect">“collect”?</h2>

<p>The two <code class="language-plaintext highlighter-rouge">collect</code> functions
(<a href="http://doc.rust-lang.org/master/std/result/fn.collect.html"><code class="language-plaintext highlighter-rouge">result</code></a>
and
<a href="http://doc.rust-lang.org/master/std/option/fn.collect.html"><code class="language-plaintext highlighter-rouge">option</code></a>)
are useful helpers, which take an <code class="language-plaintext highlighter-rouge">Iterator&lt;Result&lt;T, X&gt;&gt;</code> and return
something like <code class="language-plaintext highlighter-rouge">Result&lt;Vec&lt;T&gt;, X&gt;</code> or <code class="language-plaintext highlighter-rouge">Result&lt;HashSet&lt;T&gt;, X&gt;</code>
(respectively <code class="language-plaintext highlighter-rouge">Option</code>). It’s not a coincidence that these functions
share the same name as the
<a href="http://doc.rust-lang.org/master/std/iter/trait.Iterator.html#tymethod.collect"><code class="language-plaintext highlighter-rouge">Iterator.collect</code></a>
I used last time: all of them allow collecting to the same set of
generic container types.</p>

<p>A Haskeller might notice that they are actually just special cases of
<a href="http://hackage.haskell.org/package/base-4.7.0.0/docs/Prelude.html#v:sequence">the monadic <code class="language-plaintext highlighter-rouge">sequence</code></a>; there is a possibility that this
could be handled generically in future (with higher kinded types),
but, unfortunately, there is no guarantee that a Monad trait will work
nicely due to Rust’s affine types and various low-level details.</p>

<section id="external-links" class="no-print">
  
  <div id="comments">
    <span class="external-label">Comments:</span>
    <ul class="external-list">
      

      
<li class="external-link"><a href="http://www.reddit.com/r/rust/comments/27tuu5/error_handling_in_rust_a_knn_case_study/">/r/rust</a></li>


      
<li class="external-link"><a href="http://www.reddit.com/r/programming/comments/27tuw8/error_handling_in_rust_a_knn_case_study/">/r/programming</a></li>


      
<li class="external-link"><a href="https://news.ycombinator.com/item?id=7875793">Hacker News</a></li>


      

      
    </ul>
  </div>
  
  <div id="external-page">
    <span class="external-label">Share this on</span>
    <ul class="external-list">
      <li class="external-link"><a href="https://bsky.app/intent/compose?text=Error%20handling%20in%20Rust:%20a%20k-NN%20case%20study%20by%20@huonw.bsky.social%20https://huonw.github.io/blog/2014/06/error-handling-in-rust-knn-case-study/" target="_blank" rel="nofollow noopener" title="Share on Bluesky">Bluesky</a></li>
      <li class="external-link"><a href="https://twitter.com/intent/tweet?text=Error%20handling%20in%20Rust:%20a%20k-NN%20case%20study%20%23rustlang&amp;url=https://huonw.github.io/blog/2014/06/error-handling-in-rust-knn-case-study/&amp;via=huon_w" target="_blank" rel="nofollow noopener" title="Share on Twitter">Twitter</a></li>
      <li class="external-link"><a href="https://facebook.com/sharer.php?u=https://huonw.github.io/blog/2014/06/error-handling-in-rust-knn-case-study/" rel="nofollow noopener" target="_blank" title="Share on Facebook">Facebook</a></li>
      <li class="external-link"><a href="https://www.reddit.com/submit?url=https://huonw.github.io/blog/2014/06/error-handling-in-rust-knn-case-study/&amp;title=Error%20handling%20in%20Rust:%20a%20k-NN%20case%20study" rel="nofollow noopener" target="_blank" title="Share on Reddit">Reddit</a></li>
    </ul>
  </div>
</section>


    </article>

    
    <footer id="more" class="no-print">
      <div id="by-line">
  <a href="/about"><div class="no-print" id="me-icon"></div></a>

<p>I'm <a href="https://bsky.app/profile/huonw.bsky.social"><strong>Huon Wilson</strong></a>, a
 mathematically and statistically inclined software engineer.
 I have been a long-term volunteer
 on <a href="http://rust-lang.org">Rust</a>'s core team, a
 compiler engineer on the <a href="https://swift.org/">Swift</a> team
 at Apple, and a senior software engineer at CSIRO's Data61, working on the <a href="https://github.com/stellargraph/stellargraph">StellarGraph
 graph machine learning library</a>.
</p>
</div>
      <h2 id="latest-heading"><a href="/blog">Latest posts</a></h2>
      
      <nav>
        <ul id="latest-list"><!--
           
           --><li class="latest-post">
                <a href="/blog/2025/02/ci-tee/">
                   <h3>Prefer tee -a, not >>, in CI</h3>
                     <p><table>
  <tbody>
    <tr>
      <td>GitHub Actions suggests using code like echo … » $GITHUB_ENV, but echo …</td>
      <td>tee -a $GITHUB_ENV is often better.</td>
    </tr>
  </tbody>
</table>
</p>
                   
                 </a>
            </li><!--
          
           --><li class="latest-post">
                <a href="/blog/2024/08/async-hazard-mmap/">
                   <h3>Async hazard: mmap is secretly blocking IO</h3>
                     <p>Memory-mapping a file is convenient, but it’s a hazard when used with async/await concurrent code: it means a “simple” memory index does blocking IO.
</p>
                   
                 </a>
            </li><!--
          
           --><li class="latest-post">
                <a href="/blog/2024/07/github-permalinks/">
                   <h3>GitHub tip-hub: habitual permalinks</h3>
                     <p>Hit y to create a permalink to a GitHub directory, file or line. They’re easy to make, stable, and even render a preview in some places.
</p>
                   
                 </a>
            </li><!--
          
      --></ul>
      </nav>
    </footer>
    
  </main>

  <footer id="page-footer">
    <span>Huon Wilson &mdash; <span class="date">2021</span></span>
  </footer>
</div>



<!-- Default Statcounter code for huonw.github.io
http://huonw.github.io -->
<script type="text/javascript">
var sc_project=7439209;
var sc_invisible=1;
var sc_security="b96244c7";
</script>
<script type="text/javascript"
src="https://www.statcounter.com/counter/counter.js"
async></script>
<noscript><div class="statcounter"><a title="hit counter"
href="https://statcounter.com/" target="_blank"><img
class="statcounter"
src="https://c.statcounter.com/7439209/0/b96244c7/1/"
alt="hit counter"
referrerPolicy="no-referrer-when-downgrade"></a></div></noscript>
<!-- End of Statcounter Code -->

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-62534856-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-62534856-1');
</script>



</body> </html>
