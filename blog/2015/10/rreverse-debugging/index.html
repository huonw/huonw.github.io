<!DOCTYPE HTML>
<html lang="en">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>  Rreverrse Debugging |  Huon on the internet</title>

  <link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Atom feed">
  <link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="RSS feed">
  
  <link rel="canonical" href="https://huonw.github.io/blog/2015/10/rreverse-debugging/">

  <meta name="viewport" content="width=device-width; initial-scale=1.0;" />
  

  
  <meta name="description" content="rr is the debugger for Rust (et al.) that is is almost too good to be true.
" />

  
  <meta name="twitter:card" content="summary" />
  
  <meta name="twitter:site" content="@huon_w" />
  <meta name="twitter:title" content="Rreverrse Debugging" />
  <meta name="twitter:description" content="rr is the debugger for Rust (et al.) that is is almost too good to be true.
" />
  <meta name="twitter:url" content="https://huonw.github.io/blog/2015/10/rreverse-debugging/">

  <!-- facebook -->
  <meta property="og:url" content="https://huonw.github.io/blog/2015/10/rreverse-debugging/" />
  <meta property="og:title" content="Rreverrse Debugging" />
  <meta property="og:description" content="rr is the debugger for Rust (et al.) that is is almost too good to be true.
" />
  
  <meta property="og:type" content="article" />
  
  
  
  <style>
    /*! modern-normalize v1.1.0 | MIT License | https://github.com/sindresorhus/modern-normalize */
*,::after,::before{box-sizing:border-box}html{line-height:1.15;-webkit-text-size-adjust:100%;-moz-tab-size:4;tab-size:4}body{margin:0;font-family:system-ui, -apple-system,'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji'}hr{height:0;color:inherit}abbr[title]{text-decoration:underline dotted}b,strong{font-weight:bolder}code,kbd,pre,samp{font-family:ui-monospace, SFMono-Regular, Consolas, 'Liberation Mono', Menlo, monospace;font-size:1em}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-0.25em}sup{top:-0.5em}table{text-indent:0;border-color:inherit}button,input,optgroup,select,textarea{font-family:inherit;font-size:100%;line-height:1.15;margin:0}button,select{text-transform:none}[type='button'],[type='reset'],[type='submit'],button{-webkit-appearance:button}::-moz-focus-inner{border-style:none;padding:0}:-moz-focusring{outline:1px dotted ButtonText}:-moz-ui-invalid{box-shadow:none}legend{padding:0}progress{vertical-align:baseline}::-webkit-inner-spin-button,::-webkit-outer-spin-button{height:auto}[type='search']{-webkit-appearance:textfield;outline-offset:-2px}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}summary{display:list-item}


    
      /* Borrowed from mojombo: https://github.com/mojombo/mojombo.github.com/blob/master/css/syntax.css */

.lineno { width: 2em; text-align:right; }
.highlight pre {
  white-space: pre;
}
.highlight .c { color: #777; font-style: italic; } /* Comment */
.highlight .err { color: #a61717; background-color: #e3d2d2 } /* Error */
.highlight .k { font-weight: bold } /* Keyword */
.highlight .o { font-weight: bold } /* Operator */
.highlight .cm { color: #999988; font-style: italic } /* Comment.Multiline */
.highlight .cp { color: #999999; font-weight: bold } /* Comment.Preproc */
.highlight .c1 { color: #999988; font-style: italic } /* Comment.Single */
.highlight .cs { color: #999999; font-weight: bold; font-style: italic } /* Comment.Special */
.highlight .gd { color: #000000; background-color: #ffdddd } /* Generic.Deleted */
.highlight .gd .x { color: #000000; background-color: #ffaaaa } /* Generic.Deleted.Specific */
.highlight .ge { font-style: italic } /* Generic.Emph */
.highlight .gr { color: #aa0000 } /* Generic.Error */
.highlight .gh { color: #999999 } /* Generic.Heading */
.highlight .gi { color: #000000; background-color: #ddffdd } /* Generic.Inserted */
.highlight .gi .x { color: #000000; background-color: #aaffaa } /* Generic.Inserted.Specific */
.highlight .go { color: #888888 } /* Generic.Output */
.highlight .gp { color: #555555 } /* Generic.Prompt */
.highlight .gs { font-weight: bold } /* Generic.Strong */
.highlight .gu { color: #aaaaaa } /* Generic.Subheading */
.highlight .gt { color: #aa0000 } /* Generic.Traceback */
.highlight .kc { font-weight: bold } /* Keyword.Constant */
.highlight .kd { font-weight: bold } /* Keyword.Declaration */
.highlight .kp { font-weight: bold } /* Keyword.Pseudo */
.highlight .kr { font-weight: bold } /* Keyword.Reserved */
.highlight .kt { color: #445588; font-weight: bold } /* Keyword.Type */
.highlight .m { color: #009999 } /* Literal.Number */
.highlight .s { color: #d14 } /* Literal.String */
.highlight .na { color: #008080 } /* Name.Attribute */
.highlight .nb { color: #0086B3 } /* Name.Builtin */
.highlight .nc { color: #445588; font-weight: bold } /* Name.Class */
.highlight .no { color: #008080 } /* Name.Constant */
.highlight .ni { color: #800080 } /* Name.Entity */
.highlight .ne { color: #990000; font-weight: bold } /* Name.Exception */
.highlight .nf { color: #990000; font-weight: bold } /* Name.Function */
.highlight .nn { color: #555555 } /* Name.Namespace */
.highlight .nt { color: #000080 } /* Name.Tag */
.highlight .nv { color: #008080 } /* Name.Variable */
.highlight .ow { font-weight: bold } /* Operator.Word */
.highlight .w { color: #bbbbbb } /* Text.Whitespace */
.highlight .mf { color: #009999 } /* Literal.Number.Float */
.highlight .mh { color: #009999 } /* Literal.Number.Hex */
.highlight .mi { color: #009999 } /* Literal.Number.Integer */
.highlight .mo { color: #009999 } /* Literal.Number.Oct */
.highlight .sb { color: #d14 } /* Literal.String.Backtick */
.highlight .sc { color: #d14 } /* Literal.String.Char */
.highlight .sd { color: #d14 } /* Literal.String.Doc */
.highlight .s2 { color: #d14 } /* Literal.String.Double */
.highlight .se { color: #d14 } /* Literal.String.Escape */
.highlight .sh { color: #d14 } /* Literal.String.Heredoc */
.highlight .si { color: #d14 } /* Literal.String.Interpol */
.highlight .sx { color: #d14 } /* Literal.String.Other */
.highlight .sr { color: #009926 } /* Literal.String.Regex */
.highlight .s1 { color: #d14 } /* Literal.String.Single */
.highlight .ss { color: #990073 } /* Literal.String.Symbol */
.highlight .bp { color: #999999 } /* Name.Builtin.Pseudo */
.highlight .vc { color: #008080 } /* Name.Variable.Class */
.highlight .vg { color: #008080 } /* Name.Variable.Global */
.highlight .vi { color: #008080 } /* Name.Variable.Instance */
.highlight .il { color: #009999 } /* Literal.Number.Integer.Long */


html {
    min-height:100%;
}

* {
  margin: 0;
}
* + * {
  margin-top: 0.75em;
}


body {
  padding:0px;
    counter-reset: footnotes;
    counter-reset: figure;
    margin:0px;
    font-size: 18px;
    background: white;
    color: #101010;

    font-variant: common-ligatures;
    -moz-font-feature-settings: "kern" on;
    -webkit-font-feature-settings: "kern" on;
    font-feature-settings: "kern" on;
}

#wrapper {
    margin: 0 auto;
    max-width: 630px;
    padding: 0.75em 15px;
    width: 100%;
    position:relative;
}

.lazily-filled {
  position: relative;
}
.lazily-filled > * {
  z-index: 0;
}
.lazily-filled::before {
  position: absolute;
  top: 0;
  left: 0;
  content: "";
  width: 100%;
  height: 100%;
  display: block;
  background-color: rgb(229, 236, 246);
  z-index: 1;
}
.lazily-filled::after {
  position: absolute;
  top: 50%;
  left: 50%;
  content: "";
  display: block;
  width: 128px;
  height: 128px;
  margin-left: -64px;
  margin-top: -64px;
  border-radius: 50%;
  border: 12px solid;
  border-color: white transparent;
  animation: spinner 5s linear;
  /* eventually stop animating when it's hidden */
  animation-iteration-count: 10;
  z-index: 2;
}
.lazily-filled::before, .lazily-filled::after {
  opacity: 0;
  transition: all 0.5s ease;
  pointer-events: none;
}
.lazily-filled:empty::before, .lazily-filled:empty::after {
  opacity: 1;
  animation-iteration-count: infinite;
  visibility: visible;
}
@keyframes spinner {
  0% {
    transform: rotate(0deg);
  }
  100% {
    transform: rotate(360deg);
  }
}

.plotly-plot * + * {
  margin-top: 0;
}

/* wonky safari */
.plotly text[style*="white-space: pre"] {
  white-space: nowrap !important;
}


/* lists */
li + li {
  margin-top: 0.5em;
}
ul, ol {
  padding-left: 1.5em;
}

table {
  margin-left: auto;
  margin-right: auto;
  border-collapse: collapse;
  text-align: left;
}

td, th {
  padding: 0.1em 0.75em;
}
@media (max-width: 500px) {
  td, th {
    padding-left: 0.375em;
    padding-right: 0.375em;
  }
}
tr:nth-child(even) {
  background: rgba(0, 0, 0, 5%);
}
thead {
  border-bottom: 1px solid grey;
  font-weight: bold;
}

header {
  margin-bottom: 1.5em;
}
header a:not(:hover) {
  text-decoration: none;
}
#blog-title {
  hyphens: none;
  font-variant: small-caps;
  font-size: 1.5em;
  font-weight: normal;
  text-align: center;
  line-height: 1em;
}
#info-list {
  list-style: none;
  padding: 0;
  display: flex;
  justify-content: center;
  flex-wrap: wrap;
}
#info-list li {
  margin: 0 1em;
}

#page-footer {
  border-top: 1px solid lightgrey;
  padding-top: 0.75em;
  color: grey;
  text-align: right;
}

.clear { clear: both; margin: 0; }


main {
    text-align:justify;
    -moz-hyphens: auto;
    -webkit-hyphens: auto;
    -ms-hyphens: auto;
    hyphens: auto;
    line-height: 1.5em;

    position: relative;
    z-index: 10;
}

a[href] {
    color: inherit;
    text-decoration: underline;
}

/*  The authorship info */
#info-intro {
    font-style: italic;
    text-align: center;
}

/* code */

code, pre {
  font-family: monospace;
  font-variant: none;
  -moz-hyphens: none;
  -webkit-hyphens: none;
  -ms-hyphens: none;
  hyphens: none;
}

pre {
  background: #f0f0f0;
}
code {
    background: #f7f7f7;
    padding: 0 0.1em;
    font-size: 0.9em;
    border-radius: 3px;
    border: 1px solid lightgrey;
}
pre code {
    background: none;
    padding: 0;
    -moz-hyphens: none;
    -webkit-hyphens: none;
    -ms-hyphens: none;
    hyphens: none;
    border-radius: 0;
    border-width: 0;
}
h1 code, h2 code, h3 code, h4 code {
  background: rgba(255,255,255,0.1);
}

.break-all {
  word-break: break-all;
}

/* quotes and similar */

blockquote {
    border: solid #eee;
    border-width: 0 1px;
    padding: 0 1.2em;
    color: #444;
    position: relative;
    margin-left: 0;
    margin-right: 0;
}

aside {
  padding: 0 1.2em;
  color: #444;
  position: relative;
}
aside[data-icon] {
  padding-left: 2.4em;
}
aside[data-icon]:before {
  content: attr(data-icon);
  position: absolute;
  left: 0;
  text-align: center;
  width: 2.4em;
}

/* images/figures */
img, figure svg {
  max-width: 100%;
  height: auto;
}
figure svg {
  width: 100%;
}
img:not(.inline-image), figure svg {
    display: block;
    margin: 0 auto;
    clear: both;
}

.image-positioner {
  max-width: 800px;
  margin-left: auto;
  margin-right: auto;
}

img[data-caption]:before {
    content: attr(data-caption);
}
figure {
  clear: both;
}
figure.image {
  width: 100vw;
  position: relative;
  left: 50%;
  right: 50%;
  margin-left: -50vw;
  margin-right: -50vw;

  min-width: 100%;
}
figcaption {
  margin: 0 auto;
  max-width: 570px;
  padding: 0 10px;
  text-align: center;
  font-style: italic;
  font-size: 0.9em;
}
figcaption p {
  display: inline;
}
figcaption::before {
  counter-increment: figure;
  content: "Figure " counter(figure) ". ";
}

.highlight table {
  font-size: 0.9em;
  padding: 0em;
  width: 100%;
  table-layout: fixed;
  overflow-y: hidden;
  display: block;
  position: relative;
  z-index: 1;
}
[data-lang] {
  position: relative;
  display: block;
}
[data-lang]::before {
  content: attr(data-lang);
  text-transform: capitalize;
  top: 0;
  right: 0;
  position: absolute;
  font-size: 1.5em;
  color: #f3f3f3;
  z-index: 1;
}

.highlight pre {
  background: transparent;
}
.gutter {
  padding: 0;
  border: solid #ccc;
  border-width: 0 1px 0 0;
  color: #ccc;
}
.lineno {
  width: 25px;
  padding-right: 5px;
}
.highlight td.code {
  overflow-x: auto;
  padding: 0;
  padding-left: 0.5em;
}


/* HEADINGS */

h1, h2 {
    font-variant: small-caps;
}

h1, h2, h3, h4 {
  -moz-hyphens: none;
  -webkit-hyphens: none;
  -ms-hyphens: none;
  hyphens: none;
  text-align: left;
}

h1 {
  font-size: 2.2em;
  text-align: center;
  line-height: 1em;
}
h2 {
  font-size: 1.7em;
}
h3 {
  font-size: 1.4em;
}
h4 {
  font-size: 1.2em;
}

/* crates.io badges */

.lib-info {
  float: right;
  width: 150px;
  text-align: center;
  margin: 0 1em;
}
.lib-badge {
  vertical-align: middle;
}
.centered-libs {
  text-align: center;
}
.centered-libs .lib-info {
  float: none;
}

/* external links */

#external-links {
  margin-top: 2.25em;
  text-align: center;
}
.external-label {
  font-weight: bold;
}
#external-links ul {
  list-style: none;
  display: inline-block;
  padding: 0;
  margin: 0;
}
#external-links li {
  list-style: none;
  display: inline;
}

/* "Footnotes" */

/* the div that holds them */
.footnotes {
    margin-top: 2.25em;
    padding-top: 1.5em;
    border-top: 1px solid rgb(240,240,240);
    font-size: 0.9em;
}
.footnotes ol {
  padding: 0;
}
.footnotes li {
    list-style-position: outside;
    margin-left: 30px;
    margin-right: 10px;
    color: #333;
}

.footnotes li:target, .footnotes li:hover {
    color: black;
    background-color: lightyellow;
}

.footnotes .reversefootnote {
    text-decoration: none;
}

/* extra info after a post */
#more {
  margin-top: 3em;
  padding-top: 1.5em;
  border-top: 1px solid lightgray;
}
#me-icon {
  max-width: 150px;
  height: 150px;
  background: url("/img/me.jpg");
  background-size: cover;
  margin-left: auto;
  margin-right: auto;
  border-radius: 30px;
}
#by-line {
  font-size: 0.8em;
}
#latest-list {
  padding: 0;
  list-style: none;
}
#latest-heading {
  text-align: center;
}
#latest-heading a:not(:hover) {
  text-decoration: none;
}
#latest-list a:hover h3 {
  text-decoration: underline;
}
#latest-list a {
  text-decoration: none;
}
.latest-post {
  padding: 0;
  font-size: 0.8em;
}
.latest-post > h3 {
  font-weight: bold;
}
.latest-post * {
  margin: 0;
}

/* post series */

.post-series {
  font-size: 0.8em;
  border: 1px solid lightgray;
  padding: 0.2em;
  cursor: pointer;
}

.post-series-title {
  font-weight: bold;
  font-size: 1.1em;
}
.post-series-list {
  padding-left: 1.5em;
  margin: 0;
}
.post-series .current {
  font-style: italic;
}

/* archive pages */
ul.post-list {
  list-style: none;
  padding: 0;
}

.post-post {
  margin: 0;
}

.post-post + .post-post {
  border-top: 1px dashed  #ddd;
  margin-top: 1em;
  padding-top: 1em;
}

a.post-heading {
  display: flex;
  align-items: baseline;
  text-decoration: none;
  gap: 1em;
}
.post-heading * {
  margin: 0;
}

.post-title {
  font-size: 1.2em;
  flex-grow: 1;
  text-decoration: underline;
}

.post-heading .post-date {
  font-style: italic;
  flex-shrink: 0;
}

.post-excerpt p {
  display: inline;
}

.post-more {
  font-style: italic;
  white-space: nowrap;
  float: right;
  margin: 0;
  font-size: smaller;
}

.post-list .footnote, .post-list .footnotes, .post-list p:empty {
  display: none
}

/* media queries */


@media only print {
    a {
      text-decoration: none !important;
    }
    header {
        display:none !important;
    }

    h1, h2, h3, h4 {
        padding-left: 0 !important;
    }

    #wrapper {
       max-width: none !important;
    }

    .no-print {
        display: none !important;
    }

    .footnotes .reversefootnote {
         display: none !important;
    }
    [data-lang]::before {
      content: "";
    }
}

    

    
  </style>
  
</head>

<body>
<div id="wrapper">
  <header>
    <h1 id="blog-title"><a href="/">Huon on the internet</a></h1>
    <nav>
      <ul id="info-list" class="no-print">
        <li><a href="/about">About</a></li>
        <li><a href="/blog">Blog</a></li>
        <li><a href="https://github.com/huonw">GitHub</a></li>
        <li><a href="https://twitter.com/huon_w">Twitter</a></li>
      </ul>
    </nav>
  </header>
  <main>
    <article>
      
        <h1 id="title"> Rreverrse Debugging</h1>
        
      
      
         <div id="info-intro">
           By <a href="/about">Huon Wilson</a>
           
             &mdash; <span class="date pub-date">27 Oct 2015</span>
           
           
         </div>
      
      <p>Imagine being able to step forward and <em>backwards</em> as code runs in
your debugger. Imagine being able to do an test run multiple times
with exactly the same sequence of instructions and values, right down
to memory addresses and IO. Imagine being able to run an executable
thousands of times and then do all that in the one execution that
triggers the rare bug that‚Äôs draining you of life‚Ä¶</p>

<p>The <a href="http://rr-project.org/">rr tool</a> is amazing.</p>

<h2 id="a-debugger-skeptic">A Debugger Skeptic</h2>

<p>I‚Äôve never been a huge user of debuggers. Being able to diagnose my
code line-by-line, statement-by-statement sounded theoretically good
to me, but I‚Äôve never really ‚Äúclicked‚Äù with it in practice.</p>

<p>Of course, there‚Äôs an element of a vicious cycle: I only use debuggers
(generally gdb for native code, and pdb for Python) occasionally and
so I‚Äôm not an expert, so things end up being annoying, slow and
require searching the internet a lot, and this discourages me from
using them. And, for anything non-trivial, circumstances often mean
that my attempts to use a debugger are an exercise in pulling teeth
and are slower than just staring at the code harder and/or adding more
logging.</p>

<p>There‚Äôs also a large element of just never having a tool I liked using
(which is what this whole post is about): I don‚Äôt do that much in
managed languages like Java or C#, and I‚Äôve not used Visual Studio in
any detail, all of which I‚Äôve heard rumours about being top-notch.</p>

<p>The thing I struggle with most is the disconnect between when problems
are detected/manifest, and the fundamental cause. A typical ‚Äútricky‚Äù
bug might only occur occasionally: an assertion of
internal-consistency inside a library triggers inside a function in a
somewhat non-deterministic way, meaning it may take hundreds or even
thousands of calls before it triggers. And, even when it does, the
assertion is usually just detecting some flow-on consequence, and the
actual problem is usually some unknown distance before the
assertion. All this means I struggle to wrangle the debugger into the
right position to catch the bug, without having to walk through too
many perfectly fine executions. I‚Äôm sure a gdb-empress could handle
this with ease, but I don‚Äôt have those skills, so just sticking some
<code class="language-plaintext highlighter-rouge">println!</code>s in my code and reading the log backwards from the error is
easier.</p>

<p>Recently I‚Äôve been trying to get better at using debuggers, to break
my vicious cycle. I‚Äôve been poking around in my Python code for my
Masters‚Äô with pdb, and I‚Äôve of course been poking around in Rust code
with gdb. This has been an uphill struggle: I have to consciously
decide to actually open a debugger and then work out exactly where I
need to be. There was a boost when I worked out that
<a href="https://github.com/rust-lang/rust/blob/0152a93bb41ba360b41dd62451c2472fc5978d0c/src/etc/rust-gdb">the <code class="language-plaintext highlighter-rouge">rust-gdb</code> wrapper</a> was made to be used (and is
conveniently installed by default, even with
<a href="https://github.com/brson/multirust"><code class="language-plaintext highlighter-rouge">multirust</code></a>), but, still: not my favourite activity.</p>

<p>And then, <a href="https://github.com/mozilla/rr/releases/tag/4.0.0">rr 4.0</a> was <a href="http://robert.ocallahan.org/2015/10/rr-40-released-with-reverse-execution.html">released</a>‚Ä¶</p>

<h2 id="on-a-rrrroll">On a rrrroll</h2>

<p>rr is everything I never knew I wanted from a debugger. I can barely
stay out of it: I‚Äôm slicing and dicing bugs in Rust code like never
before. Instead of having to plan out the best places to put
breakpoints for what I suspect the issue <em>might</em> be, I just run the
code, and then break whereever/whenever I want to later.</p>

<p>The workflow is simple: make a recording of an execution, and then
replay it in a debugger, with the ability to do go anywhere you want
any time.</p>

<p>With Rust/Cargo, my command line will often look like:</p>

<figure class="highlight"><pre><code class="language-sh" data-lang="sh"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="code"><pre><span class="nv">$ </span>cargo build <span class="nt">--example</span> foo
... things compiling ...
<span class="nv">$ </span>rr ./target/debug/examples/foo
... rr &amp; program output ...
<span class="nv">$ </span>rr replay <span class="nt">-d</span> rust-gdb
... rr &amp; gdb start-up ...
<span class="o">(</span>gdb<span class="o">)</span> <span class="nb">break </span>rust_panic
...
<span class="o">(</span>gdb<span class="o">)</span> <span class="k">continue</span>
... program output ...
<span class="o">(</span>gdb<span class="o">)</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>(The <code class="language-plaintext highlighter-rouge">-d</code> flag was <a href="https://github.com/mozilla/rr/pull/1551">added</a> just after 4.0 was released. I asked
a question about swapping in different gdbs, and was prompted to
file an issue, which was fixed in just a few hours! Anyway, this means
getting the best Rust experience requires building from rr
<a href="https://github.com/mozilla/rr">from source</a> at the moment.)</p>

<h3 id="recording">Recording</h3>

<p>The recording step with <code class="language-plaintext highlighter-rouge">rr</code> is simple: tell it your binary and it‚Äôll
run it, saving the state it needs for replaying as the program
executes.</p>

<p>This <em>could</em> be implemented as just saving the entire state of the
machine (memory and registers) between each step, but this would be
super-slow, and it won‚Äôt be nearly as nice to use as rr. The worst
overhead I‚Äôve noticed is the rr‚Äôd program taking <s>14√ó longer</s>, but it‚Äôs
a pretty dumb program, and I only came up with it for this blog post<sup id="fnref:worst-case" role="doc-noteref"><a href="#fn:worst-case" class="footnote" rel="footnote">0</a></sup>:</p>

<figure class="highlight"><pre><code class="language-rust" data-lang="rust"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="code"><pre><span class="c">// hammer.rs</span>
<span class="k">use</span> <span class="nn">std</span><span class="p">::</span><span class="nn">fs</span><span class="p">::</span><span class="n">File</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">std</span><span class="p">::</span><span class="nn">io</span><span class="p">::</span><span class="nn">prelude</span><span class="p">::</span><span class="o">*</span><span class="p">;</span>

<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">for</span> <span class="mi">_</span> <span class="n">in</span> <span class="mi">0</span><span class="o">..</span><span class="mi">100000</span> <span class="p">{</span>
        <span class="k">let</span> <span class="k">mut</span> <span class="n">buffer</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">;</span> <span class="mi">1000</span><span class="p">];</span>
        <span class="nn">File</span><span class="p">::</span><span class="nf">open</span><span class="p">(</span><span class="s">"foo.txt"</span><span class="p">)</span><span class="nf">.unwrap</span><span class="p">()</span><span class="nf">.read</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="n">buffer</span><span class="p">)</span><span class="nf">.unwrap</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>It takes <s>4.2s</s> 0.5s (this case <a href="https://github.com/mozilla/rr/commit/9bc7077e0a031a200aca7baf785dad17eba9f941">was optimised</a>) to be
recorded with rr, but only 0.3s to run normally. (Compiled with
<code class="language-plaintext highlighter-rouge">rustc -g hammer.rs</code>, with Rust 1.3.0.) Of course, most programs will
being doing more than reading from a file a <em>lot</em>, and the overhead is
much smaller for more typical work-loads. For instance, I‚Äôve been
doing some work with Aatch‚Äôs big-integer library, <a href="https://github.com/Aatch/ramp">ramp</a>, and
<a href="https://github.com/Aatch/ramp/blob/7fac34b95600562a1272995568fff331eb533894/examples/factorial.rs">the <code class="language-plaintext highlighter-rouge">factorial</code> example</a> (compiled in debug mode) takes
1.8s to run under rr, and 1.5s normally.</p>

<h3 id="determinism">Determinism</h3>

<p>The replaying is where the magic really kicks in for me. The <code class="language-plaintext highlighter-rouge">rr
replay</code> command brings up an instance of gdb with the trace loaded
and ready to go.</p>

<p>The recording means that the ‚Äúexecution‚Äù of a replay is now
deterministic (and completely so, as far as I can tell), so you can be
sure about a lot of things. Reading random data is fine:</p>

<figure class="highlight"><pre><code class="language-rust" data-lang="rust"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="code"><pre><span class="c">// urandom.rs</span>
<span class="k">use</span> <span class="nn">std</span><span class="p">::</span><span class="nn">fs</span><span class="p">::</span><span class="n">File</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">std</span><span class="p">::</span><span class="nn">io</span><span class="p">::</span><span class="nn">prelude</span><span class="p">::</span><span class="o">*</span><span class="p">;</span>

<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">let</span> <span class="k">mut</span> <span class="n">buffer</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">;</span> <span class="mi">5</span><span class="p">];</span>
    <span class="nn">File</span><span class="p">::</span><span class="nf">open</span><span class="p">(</span><span class="s">"/dev/urandom"</span><span class="p">)</span><span class="nf">.unwrap</span><span class="p">()</span><span class="nf">.read</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="n">buffer</span><span class="p">)</span><span class="nf">.unwrap</span><span class="p">();</span>

    <span class="nd">println!</span><span class="p">(</span><span class="s">"{:?}"</span><span class="p">,</span> <span class="n">buffer</span><span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>Recording and playing it back gives the same result each time:</p>

<figure class="highlight"><pre><code class="language-sh" data-lang="sh"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="code"><pre><span class="nv">$ </span>rr ./urandom
rr: Saving the execution of <span class="sb">`</span>./urandom<span class="s1">' to trace directory `/home/huon/.rr/urandom-2'</span><span class="nb">.</span>
<span class="o">[</span>45, 45, 28, 0, 236]
<span class="nv">$ </span>~/projects/mozilla/rr/obj/bin/rr replay <span class="nt">-d</span> rust-gdb ~/.rr/urandom-2
GNU gdb <span class="o">(</span>Ubuntu 7.10-1ubuntu2<span class="o">)</span> 7.10
...
<span class="o">(</span>gdb<span class="o">)</span> c
Continuing.
<span class="o">[</span>45, 45, 28, 0, 236]
</pre></td></tr></tbody></table></code></pre></figure>

<p>Even the memory addresses of allocations, the stack and everything
else are deterministic, so watches and watchpoints can be placed on
exact bytes in memory and they‚Äôll do the right thing on every ‚Äúrun‚Äù of
the program. (I‚Äôve not had a reason to use it yet, but seems awesome
for debugging memory corruption: find an execution that exhibits
corruption of some string or something, and place a watch point on
those bytes to find the locations that modify the string.)</p>

<h3 id="back-to-the-future">Back to the future</h3>

<p>The thing I‚Äôve really fallen in love with is reverse debugging:
instead of just being able to let the program‚Äôs execution progress
forward in various forms (<code class="language-plaintext highlighter-rouge">step</code>, <code class="language-plaintext highlighter-rouge">next</code>, <code class="language-plaintext highlighter-rouge">continue</code> etc.), you can do
the same in reverse.</p>

<p>My strategy is:</p>

<ul>
  <li>find out some code has a bug (oh no!),</li>
  <li>record executions with <code class="language-plaintext highlighter-rouge">rr</code> until the bug exhibits how I want<sup id="fnref:rare" role="doc-noteref"><a href="#fn:rare" class="footnote" rel="footnote">1</a></sup>,</li>
  <li>replay the execution until there‚Äôs a sure-fire indicator it occurred
(for instance, in Rust code, breaking on <code class="language-plaintext highlighter-rouge">rust_panic</code> will stop
execution at any panic, including assertion failures),</li>
  <li>work backwards from that point, diving in and out of functions and
stepping forward and backwards over lines/instructions/anything.</li>
</ul>

<p>The keys here are the <code class="language-plaintext highlighter-rouge">r</code>/<code class="language-plaintext highlighter-rouge">reverse-</code>-prefixed gdb commands: <code class="language-plaintext highlighter-rouge">rn</code>
(<code class="language-plaintext highlighter-rouge">reverse-next</code>), <code class="language-plaintext highlighter-rouge">rs</code> (<code class="language-plaintext highlighter-rouge">reverse-step</code>), <code class="language-plaintext highlighter-rouge">rc</code> (<code class="language-plaintext highlighter-rouge">reverse-continue</code>) and
so on. These do what their non-<code class="language-plaintext highlighter-rouge">reverse</code> conterparts do, except
backwards: <code class="language-plaintext highlighter-rouge">next</code> goes from line 9 to line 10, <code class="language-plaintext highlighter-rouge">reverse-next</code> goes
from line 10 to line 9.</p>

<p>It just feels so great to start up the debugger, break on
<code class="language-plaintext highlighter-rouge">rust_panic</code>, examine the state of the world, and then break on some
<em>previous</em> function call and jump back to it with
<code class="language-plaintext highlighter-rouge">reverse-continue</code>. I can track down problems without having to fiddle
with setting up how to actually start the debugger in the right place.</p>

<h3 id="removing-the-rose-coloured-glasses">Removing the rose-coloured glasses</h3>

<p>I‚Äôm probably sounding breathlessly enthusiastic, as if record/replay
and reverse execution was some amazing new functionally. It‚Äôs not.</p>

<p>Other environments/languages/tools have the functionality, but it‚Äôs
the first time I‚Äôve had the luck to use it. There‚Äôs even actually
<a href="https://www.sourceware.org/gdb/wiki/ProcessRecord">recording</a> and <a href="https://www.sourceware.org/gdb/wiki/ReverseDebug">reverse execution</a> in gdb itself,
but it is (apparently) quite slow, and seems to be less reliable: I
tried <code class="language-plaintext highlighter-rouge">target record</code> on an Rust executable, and the recording
immediately failed in glibc‚Äôs <code class="language-plaintext highlighter-rouge">memset</code> (it couldn‚Äôt handle an AVX2
instruction).</p>

<p>Also, rr of course has its own limitations:</p>

<ul>
  <li>it doesn‚Äôt literally fix your bugs for you,</li>
  <li>it only runs on Linux and only x86 &amp; x86-64 (although there‚Äôs a
<a href="https://github.com/mozilla/rr/issues/1373">bug about ARM</a>),</li>
  <li>programs run on a single-core, so concurrency is possible but not
parallelism (and hence programs may be much slower due to that, and
some bugs for which rr might be nice to have are harder/impossible
to trigger),</li>
  <li>modifying variables/memory is useless: any changes are ignored and
overwritten, since the executions are recorded and fixed,</li>
  <li>it doesn‚Äôt support all syscalls, but I‚Äôve not encountered one that
isn‚Äôt supported personally, and the reason is they‚Äôre implemented on
an on-demand basis; things that have been founded to be needed for
debugging Firefox etc.,</li>
  <li>the time overhead is fairly low, but the memory overhead is quite
large: the factorial example from before went from 3MB (as measured
by GNU time) to 82MB. I‚Äôm sure that a large part of this is a
constant overhead, because it doesn‚Äôt seem like it‚Äôd be a great tool
for debugging large applications (for which it is designed, and
<a href="https://github.com/mozilla/rr/wiki/Testimonials">used</a>) with 30√ó increase in memory use.</li>
</ul>

<p>(There‚Äôs a few more technical things mentioned in the limitations on
<a href="http://rr-project.org/">rr‚Äôs website</a>.)</p>

<h2 id="summary">Summary</h2>

<p>Reverse debugging has converted me from ‚Äúmeh debuggers‚Äù to ‚Äúüíú rr‚Äù:
being able to dance around freely‚Äî<em>frolic</em>, even‚Äîin code
pleases me like no other tool. It is language agnostic, I‚Äôm led to
believe that anything that works in GDB itself will work with rr: I
believe it was designed with C/C++ applications like Firefox in mind,
but it works flawlessly with Rust, and I‚Äôm sure other languages too.</p>

<section id="external-links" class="no-print">
  
  <div id="comments">
    <span class="external-label">Comments:</span>
    <ul class="external-list">
      
<li class="external-link"><a href="https://users.rust-lang.org/t/rreverrse-debugging/3418">users</a></li>


      
<li class="external-link"><a href="https://www.reddit.com/r/rust/comments/3qf6j9/rreverrse_debugging/">/r/rust</a></li>


      
<li class="external-link"><a href="https://www.reddit.com/r/programming/comments/3qf6kq/rreverrse_debugging/">/r/programming</a></li>


      

      
    </ul>
  </div>
  
  <div id="external-page">
    <span class="external-label">Share this on</span>
    <ul class="external-list">
      <li class="external-link"><a href="https://twitter.com/intent/tweet?text=Rreverrse%20Debugging%20%23rustlang&amp;url=https://huonw.github.io/blog/2015/10/rreverse-debugging/&amp;via=huon_w" target="_blank" rel="nofollow noopener" title="Share on Twitter">Twitter</a></li>
      <li class="external-link"><a href="https://facebook.com/sharer.php?u=https://huonw.github.io/blog/2015/10/rreverse-debugging/" rel="nofollow noopener" target="_blank" title="Share on Facebook">Facebook</a></li>
      <li class="external-link"><a href="https://www.reddit.com/submit?url=https://huonw.github.io/blog/2015/10/rreverse-debugging/&amp;title=Rreverrse%20Debugging" rel="nofollow noopener" target="_blank" title="Share on Reddit">Reddit</a></li>
    </ul>
  </div>
</section>

<div class="footnotes" role="doc-endnotes">
  <ol start="0">
    <li id="fn:worst-case" role="doc-endnote">
      <p>I know pretty much nothing about the internals of rr or
Linux, so I have no idea if this is actually triggering a
particularly bad case; but I do know that rr will shim in/save the
result of syscalls into the operating system, so doing a lot of
them (as opening/reading/closing a file will do) is probably slow.¬†<a href="#fnref:worst-case" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:rare" role="doc-endnote">
      <p>The rr developers point out this means tracking down rare
     bugs is made easier: run rr on a test-case in a loop until
     the bug triggers, and then you can dissect it at leisure,
     instead of just hoping to catch it by chance in a traditional
     debugger. (Again not something I‚Äôve particularly needed to
     use yet, so I don‚Äôt speak from experience: the rarest bug
     I‚Äôve had to tackle recently occurred in about a quarter of
     executions.)¬†<a href="#fnref:rare" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
  </ol>
</div>

    </article>

    
    <footer id="more" class="no-print">
      <div id="by-line">
  <a href="/about"><div class="no-print" id="me-icon"></div></a>

<p>I'm <strong>Huon Wilson</strong> <a href="https://twitter.com/huon_w">@huon_w</a>, a
 mathematically and statistically inclined software engineer.
 I have been a long-term volunteer
 on <a href="http://rust-lang.org">Rust</a>'s core team, a
 compiler engineer on the <a href="https://swift.org/">Swift</a> team
 at Apple, and a senior software engineer at CSIRO's Data61, working on the <a href="https://github.com/stellargraph/stellargraph">StellarGraph
 graph machine learning library</a>.
</p>
</div>
      <h2 id="latest-heading"><a href="/blog">Latest posts</a></h2>
      
      <nav>
        <ul id="latest-list"><!--
           
           --><li class="latest-post">
                <a href="/blog/2021/10/nsw-covid-qr/">
                   <h3>Mechanical sympathy for QR codes: making NSW check-in better</h3>
                     <p>QR codes are now critical infrastructure here in NSW, Australia. Let‚Äôs learn how to make them better.
</p>
                   
                 </a>
            </li><!--
          
           --><li class="latest-post">
                <a href="/blog/2021/09/qr-error-correction/">
                   <h3>QR error correction helps and hinders scanning</h3>
                     <p>A QR code can use one of four error correction levels. Higher error correction forces denser codes, but allows scanning in more situations. A trade-off!
</p>
                   
                 </a>
            </li><!--
          
           --><li class="latest-post">
                <a href="/blog/2021/08/home-cooked-app/">
                   <h3>The joy of cooking (an app)</h3>
                     <p>I‚Äôve been writing a bunch of code designed to enhance the life of just me and my wife. It‚Äôs great fun.
</p>
                   
                 </a>
            </li><!--
          
      --></ul>
      </nav>
    </footer>
    
  </main>

  <footer id="page-footer">
    <span>Huon Wilson &mdash; <span class="date">2021</span></span>
  </footer>
</div>



<!-- Default Statcounter code for huonw.github.io
http://huonw.github.io -->
<script type="text/javascript">
var sc_project=7439209;
var sc_invisible=1;
var sc_security="b96244c7";
</script>
<script type="text/javascript"
src="https://www.statcounter.com/counter/counter.js"
async></script>
<noscript><div class="statcounter"><a title="hit counter"
href="https://statcounter.com/" target="_blank"><img
class="statcounter"
src="https://c.statcounter.com/7439209/0/b96244c7/1/"
alt="hit counter"
referrerPolicy="no-referrer-when-downgrade"></a></div></noscript>
<!-- End of Statcounter Code -->

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-62534856-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-62534856-1');
</script>



</body> </html>
