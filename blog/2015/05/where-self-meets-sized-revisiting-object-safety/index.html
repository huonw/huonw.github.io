<!DOCTYPE HTML>
<html lang="en">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>  Where Self Meets Sized: Revisiting Object Safety |  Huon on the internet</title>

  <link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Atom feed">
  <link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="RSS feed">
  
  <link rel="canonical" href="https://huonw.github.io/blog/2015/05/where-self-meets-sized-revisiting-object-safety/">

  <meta name="viewport" content="width=device-width; initial-scale=1.0;" />
  

  
  <meta name="description" content="Rust&apos;s `where Self: Sized` now offers new flexibility for writing object-safe traits.
" />

  
  <meta name="twitter:card" content="summary" />
  
  <meta name="twitter:site" content="@huon_w" />
  <meta name="twitter:title" content="Where Self Meets Sized: Revisiting Object Safety" />
  <meta name="twitter:description" content="Rust&apos;s `where Self: Sized` now offers new flexibility for writing object-safe traits.
" />
  <meta name="twitter:url" content="https://huonw.github.io/blog/2015/05/where-self-meets-sized-revisiting-object-safety/">

  <!-- facebook -->
  <meta property="og:url" content="https://huonw.github.io/blog/2015/05/where-self-meets-sized-revisiting-object-safety/" />
  <meta property="og:title" content="Where Self Meets Sized: Revisiting Object Safety" />
  <meta property="og:description" content="Rust&apos;s `where Self: Sized` now offers new flexibility for writing object-safe traits.
" />
  
  <meta property="og:type" content="article" />
  
  
  
  <style>
    /*! modern-normalize v1.1.0 | MIT License | https://github.com/sindresorhus/modern-normalize */
*,::after,::before{box-sizing:border-box}html{line-height:1.15;-webkit-text-size-adjust:100%;-moz-tab-size:4;tab-size:4}body{margin:0;font-family:system-ui, -apple-system,'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji'}hr{height:0;color:inherit}abbr[title]{text-decoration:underline dotted}b,strong{font-weight:bolder}code,kbd,pre,samp{font-family:ui-monospace, SFMono-Regular, Consolas, 'Liberation Mono', Menlo, monospace;font-size:1em}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-0.25em}sup{top:-0.5em}table{text-indent:0;border-color:inherit}button,input,optgroup,select,textarea{font-family:inherit;font-size:100%;line-height:1.15;margin:0}button,select{text-transform:none}[type='button'],[type='reset'],[type='submit'],button{-webkit-appearance:button}::-moz-focus-inner{border-style:none;padding:0}:-moz-focusring{outline:1px dotted ButtonText}:-moz-ui-invalid{box-shadow:none}legend{padding:0}progress{vertical-align:baseline}::-webkit-inner-spin-button,::-webkit-outer-spin-button{height:auto}[type='search']{-webkit-appearance:textfield;outline-offset:-2px}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}summary{display:list-item}


    
      /* Borrowed from mojombo: https://github.com/mojombo/mojombo.github.com/blob/master/css/syntax.css */

.lineno { width: 2em; text-align:right; }
.highlight pre {
  white-space: pre;
}
.highlight .c { color: #777; font-style: italic; } /* Comment */
.highlight .err { color: #a61717; background-color: #e3d2d2 } /* Error */
.highlight .k { font-weight: bold } /* Keyword */
.highlight .o { font-weight: bold } /* Operator */
.highlight .cm { color: #999988; font-style: italic } /* Comment.Multiline */
.highlight .cp { color: #999999; font-weight: bold } /* Comment.Preproc */
.highlight .c1 { color: #999988; font-style: italic } /* Comment.Single */
.highlight .cs { color: #999999; font-weight: bold; font-style: italic } /* Comment.Special */
.highlight .gd { color: #000000; background-color: #ffdddd } /* Generic.Deleted */
.highlight .gd .x { color: #000000; background-color: #ffaaaa } /* Generic.Deleted.Specific */
.highlight .ge { font-style: italic } /* Generic.Emph */
.highlight .gr { color: #aa0000 } /* Generic.Error */
.highlight .gh { color: #999999 } /* Generic.Heading */
.highlight .gi { color: #000000; background-color: #ddffdd } /* Generic.Inserted */
.highlight .gi .x { color: #000000; background-color: #aaffaa } /* Generic.Inserted.Specific */
.highlight .go { color: #888888 } /* Generic.Output */
.highlight .gp { color: #555555 } /* Generic.Prompt */
.highlight .gs { font-weight: bold } /* Generic.Strong */
.highlight .gu { color: #aaaaaa } /* Generic.Subheading */
.highlight .gt { color: #aa0000 } /* Generic.Traceback */
.highlight .kc { font-weight: bold } /* Keyword.Constant */
.highlight .kd { font-weight: bold } /* Keyword.Declaration */
.highlight .kp { font-weight: bold } /* Keyword.Pseudo */
.highlight .kr { font-weight: bold } /* Keyword.Reserved */
.highlight .kt { color: #445588; font-weight: bold } /* Keyword.Type */
.highlight .m { color: #009999 } /* Literal.Number */
.highlight .s { color: #d14 } /* Literal.String */
.highlight .na { color: #008080 } /* Name.Attribute */
.highlight .nb { color: #0086B3 } /* Name.Builtin */
.highlight .nc { color: #445588; font-weight: bold } /* Name.Class */
.highlight .no { color: #008080 } /* Name.Constant */
.highlight .ni { color: #800080 } /* Name.Entity */
.highlight .ne { color: #990000; font-weight: bold } /* Name.Exception */
.highlight .nf { color: #990000; font-weight: bold } /* Name.Function */
.highlight .nn { color: #555555 } /* Name.Namespace */
.highlight .nt { color: #000080 } /* Name.Tag */
.highlight .nv { color: #008080 } /* Name.Variable */
.highlight .ow { font-weight: bold } /* Operator.Word */
.highlight .w { color: #bbbbbb } /* Text.Whitespace */
.highlight .mf { color: #009999 } /* Literal.Number.Float */
.highlight .mh { color: #009999 } /* Literal.Number.Hex */
.highlight .mi { color: #009999 } /* Literal.Number.Integer */
.highlight .mo { color: #009999 } /* Literal.Number.Oct */
.highlight .sb { color: #d14 } /* Literal.String.Backtick */
.highlight .sc { color: #d14 } /* Literal.String.Char */
.highlight .sd { color: #d14 } /* Literal.String.Doc */
.highlight .s2 { color: #d14 } /* Literal.String.Double */
.highlight .se { color: #d14 } /* Literal.String.Escape */
.highlight .sh { color: #d14 } /* Literal.String.Heredoc */
.highlight .si { color: #d14 } /* Literal.String.Interpol */
.highlight .sx { color: #d14 } /* Literal.String.Other */
.highlight .sr { color: #009926 } /* Literal.String.Regex */
.highlight .s1 { color: #d14 } /* Literal.String.Single */
.highlight .ss { color: #990073 } /* Literal.String.Symbol */
.highlight .bp { color: #999999 } /* Name.Builtin.Pseudo */
.highlight .vc { color: #008080 } /* Name.Variable.Class */
.highlight .vg { color: #008080 } /* Name.Variable.Global */
.highlight .vi { color: #008080 } /* Name.Variable.Instance */
.highlight .il { color: #009999 } /* Literal.Number.Integer.Long */


html {
    min-height:100%;
}

* {
  margin: 0;
}
* + * {
  margin-top: 0.75em;
}


body {
  padding:0px;
    counter-reset: footnotes;
    counter-reset: figure;
    margin:0px;
    font-size: 18px;
    background: white;
    color: #101010;

    font-variant: common-ligatures;
    -moz-font-feature-settings: "kern" on;
    -webkit-font-feature-settings: "kern" on;
    font-feature-settings: "kern" on;
}

#wrapper {
    margin: 0 auto;
    max-width: 630px;
    padding: 0.75em 15px;
    width: 100%;
    position:relative;
}

.lazily-filled {
  position: relative;
}
.lazily-filled > * {
  z-index: 0;
}
.lazily-filled::before {
  position: absolute;
  top: 0;
  left: 0;
  content: "";
  width: 100%;
  height: 100%;
  display: block;
  background-color: rgb(229, 236, 246);
  z-index: 1;
}
.lazily-filled::after {
  position: absolute;
  top: 50%;
  left: 50%;
  content: "";
  display: block;
  width: 128px;
  height: 128px;
  margin-left: -64px;
  margin-top: -64px;
  border-radius: 50%;
  border: 12px solid;
  border-color: white transparent;
  animation: spinner 5s linear;
  /* eventually stop animating when it's hidden */
  animation-iteration-count: 10;
  z-index: 2;
}
.lazily-filled::before, .lazily-filled::after {
  opacity: 0;
  transition: all 0.5s ease;
  pointer-events: none;
}
.lazily-filled:empty::before, .lazily-filled:empty::after {
  opacity: 1;
  animation-iteration-count: infinite;
  visibility: visible;
}
@keyframes spinner {
  0% {
    transform: rotate(0deg);
  }
  100% {
    transform: rotate(360deg);
  }
}

.plotly-plot * + * {
  margin-top: 0;
}

/* wonky safari */
.plotly text[style*="white-space: pre"] {
  white-space: nowrap !important;
}


/* lists */
li + li {
  margin-top: 0.5em;
}
ul, ol {
  padding-left: 1.5em;
}

table {
  margin-left: auto;
  margin-right: auto;
  border-collapse: collapse;
  text-align: left;
}

td, th {
  padding: 0.1em 0.75em;
}
@media (max-width: 500px) {
  td, th {
    padding-left: 0.375em;
    padding-right: 0.375em;
  }
}
tr:nth-child(even) {
  background: rgba(0, 0, 0, 5%);
}
thead {
  border-bottom: 1px solid grey;
  font-weight: bold;
}

header {
  margin-bottom: 1.5em;
}
header a:not(:hover) {
  text-decoration: none;
}
#blog-title {
  hyphens: none;
  font-variant: small-caps;
  font-size: 1.5em;
  font-weight: normal;
  text-align: center;
  line-height: 1em;
}
#info-list {
  list-style: none;
  padding: 0;
  display: flex;
  justify-content: center;
  flex-wrap: wrap;
}
#info-list li {
  margin: 0 1em;
}

#page-footer {
  border-top: 1px solid lightgrey;
  padding-top: 0.75em;
  color: grey;
  text-align: right;
}

.clear { clear: both; margin: 0; }


main {
    text-align:justify;
    -moz-hyphens: auto;
    -webkit-hyphens: auto;
    -ms-hyphens: auto;
    hyphens: auto;
    line-height: 1.5em;

    position: relative;
    z-index: 10;
}

a[href] {
    color: inherit;
    text-decoration: underline;
}

/*  The authorship info */
#info-intro {
    font-style: italic;
    text-align: center;
}

/* code */

code, pre {
  font-family: monospace;
  font-variant: none;
  -moz-hyphens: none;
  -webkit-hyphens: none;
  -ms-hyphens: none;
  hyphens: none;
}

pre {
  background: #f0f0f0;
}
code {
    background: #f7f7f7;
    padding: 0 0.1em;
    font-size: 0.9em;
    border-radius: 3px;
    border: 1px solid lightgrey;
}
pre code {
    background: none;
    padding: 0;
    -moz-hyphens: none;
    -webkit-hyphens: none;
    -ms-hyphens: none;
    hyphens: none;
    border-radius: 0;
    border-width: 0;
}
h1 code, h2 code, h3 code, h4 code {
  background: rgba(255,255,255,0.1);
}

.break-all {
  word-break: break-all;
}

/* quotes and similar */

blockquote {
    border: solid #eee;
    border-width: 0 1px;
    padding: 0 1.2em;
    color: #444;
    position: relative;
    margin-left: 0;
    margin-right: 0;
}

aside {
  padding: 0 1.2em;
  color: #444;
  position: relative;
}
aside[data-icon] {
  padding-left: 2.4em;
}
aside[data-icon]:before {
  content: attr(data-icon);
  position: absolute;
  left: 0;
  text-align: center;
  width: 2.4em;
}

/* images/figures */
img, figure svg {
  max-width: 100%;
  height: auto;
}
figure svg {
  width: 100%;
}
img:not(.inline-image), figure svg {
    display: block;
    margin: 0 auto;
    clear: both;
}

.image-positioner {
  max-width: 800px;
  margin-left: auto;
  margin-right: auto;
}

img[data-caption]:before {
    content: attr(data-caption);
}
figure {
  clear: both;
}
figure.image {
  width: 100vw;
  position: relative;
  left: 50%;
  right: 50%;
  margin-left: -50vw;
  margin-right: -50vw;

  min-width: 100%;
}
figcaption {
  margin: 0 auto;
  max-width: 570px;
  padding: 0 10px;
  text-align: center;
  font-style: italic;
  font-size: 0.9em;
}
figcaption p {
  display: inline;
}
figcaption::before {
  counter-increment: figure;
  content: "Figure " counter(figure) ". ";
}

.highlight table {
  font-size: 0.9em;
  padding: 0em;
  width: 100%;
  table-layout: fixed;
  overflow-y: hidden;
  display: block;
  position: relative;
  z-index: 1;
}
[data-lang] {
  position: relative;
  display: block;
}
[data-lang]::before {
  content: attr(data-lang);
  text-transform: capitalize;
  top: 0;
  right: 0;
  position: absolute;
  font-size: 1.5em;
  color: #f3f3f3;
  z-index: 1;
}

.highlight pre {
  background: transparent;
}
.gutter {
  padding: 0;
  border: solid #ccc;
  border-width: 0 1px 0 0;
  color: #ccc;
}
.lineno {
  width: 25px;
  padding-right: 5px;
}
.highlight td.code {
  overflow-x: auto;
  padding: 0;
  padding-left: 0.5em;
}


/* HEADINGS */

h1, h2 {
    font-variant: small-caps;
}

h1, h2, h3, h4 {
  -moz-hyphens: none;
  -webkit-hyphens: none;
  -ms-hyphens: none;
  hyphens: none;
  text-align: left;
}

h1 {
  font-size: 2.2em;
  text-align: center;
  line-height: 1em;
}
h2 {
  font-size: 1.7em;
}
h3 {
  font-size: 1.4em;
}
h4 {
  font-size: 1.2em;
}

/* crates.io badges */

.lib-info {
  float: right;
  width: 150px;
  text-align: center;
  margin: 0 1em;
}
.lib-badge {
  vertical-align: middle;
}
.centered-libs {
  text-align: center;
}
.centered-libs .lib-info {
  float: none;
}

/* external links */

#external-links {
  margin-top: 2.25em;
  text-align: center;
}
.external-label {
  font-weight: bold;
}
#external-links ul {
  list-style: none;
  display: inline-block;
  padding: 0;
  margin: 0;
}
#external-links li {
  list-style: none;
  display: inline;
}

/* "Footnotes" */

/* the div that holds them */
.footnotes {
    margin-top: 2.25em;
    padding-top: 1.5em;
    border-top: 1px solid rgb(240,240,240);
    font-size: 0.9em;
}
.footnotes ol {
  padding: 0;
}
.footnotes li {
    list-style-position: outside;
    margin-left: 30px;
    margin-right: 10px;
    color: #333;
}

.footnotes li:target, .footnotes li:hover {
    color: black;
    background-color: lightyellow;
}

.footnotes .reversefootnote {
    text-decoration: none;
}

/* extra info after a post */
#more {
  margin-top: 3em;
  padding-top: 1.5em;
  border-top: 1px solid lightgray;
}
#me-icon {
  max-width: 150px;
  height: 150px;
  background: url("/img/me.jpg");
  background-size: cover;
  margin-left: auto;
  margin-right: auto;
  border-radius: 30px;
}
#by-line {
  font-size: 0.8em;
}
#latest-list {
  padding: 0;
  list-style: none;
}
#latest-heading {
  text-align: center;
}
#latest-heading a:not(:hover) {
  text-decoration: none;
}
#latest-list a:hover h3 {
  text-decoration: underline;
}
#latest-list a {
  text-decoration: none;
}
.latest-post {
  padding: 0;
  font-size: 0.8em;
}
.latest-post > h3 {
  font-weight: bold;
}
.latest-post * {
  margin: 0;
}

/* post series */

.post-series {
  font-size: 0.8em;
  border: 1px solid lightgray;
  padding: 0.2em;
  cursor: pointer;
}

.post-series-title {
  font-weight: bold;
  font-size: 1.1em;
}
.post-series-list {
  padding-left: 1.5em;
  margin: 0;
}
.post-series .current {
  font-style: italic;
}

/* archive pages */
ul.post-list {
  list-style: none;
  padding: 0;
}

.post-post {
  margin: 0;
}

.post-post + .post-post {
  border-top: 1px dashed  #ddd;
  margin-top: 1em;
  padding-top: 1em;
}

a.post-heading {
  display: flex;
  align-items: baseline;
  text-decoration: none;
  gap: 1em;
}
.post-heading * {
  margin: 0;
}

.post-title {
  font-size: 1.2em;
  flex-grow: 1;
  text-decoration: underline;
}

.post-heading .post-date {
  font-style: italic;
  flex-shrink: 0;
}

.post-excerpt p {
  display: inline;
}

.post-more {
  font-style: italic;
  white-space: nowrap;
  float: right;
  margin: 0;
  font-size: smaller;
}

.post-list .footnote, .post-list .footnotes, .post-list p:empty {
  display: none
}

/* media queries */


@media only print {
    a {
      text-decoration: none !important;
    }
    header {
        display:none !important;
    }

    h1, h2, h3, h4 {
        padding-left: 0 !important;
    }

    #wrapper {
       max-width: none !important;
    }

    .no-print {
        display: none !important;
    }

    .footnotes .reversefootnote {
         display: none !important;
    }
    [data-lang]::before {
      content: "";
    }
}

    

    
  </style>
  
</head>

<body>
<div id="wrapper">
  <header>
    <h1 id="blog-title"><a href="/">Huon on the internet</a></h1>
    <nav>
      <ul id="info-list" class="no-print">
        <li><a href="/about">About</a></li>
        <li><a href="/blog">Blog</a></li>
        <li><a href="https://github.com/huonw">GitHub</a></li>
        <li><a href="https://twitter.com/huon_w">Twitter</a></li>
      </ul>
    </nav>
  </header>
  <main>
    <article>
      
        <h1 id="title"> Where Self Meets Sized: Revisiting Object Safety</h1>
        
      
      
         <div id="info-intro">
           By <a href="/about">Huon Wilson</a>
           
             &mdash; <span class="date pub-date">06 May 2015</span>
           
           
         </div>
      
      <p>The concept of object safety in Rust was recently refined to be more
flexible in an important way: the checks can be disabled for specific
methods by using <code class="language-plaintext highlighter-rouge">where</code> clauses to restrict them to only work when
<code class="language-plaintext highlighter-rouge">Self: Sized</code>.</p>

<p>This post is a rather belated fourth entry in my series on trait
objects and object safety:
<a href="/blog/2015/01/peeking-inside-trait-objects/"><em>Peeking inside Trait Objects</em></a>,
<a href="/blog/2015/01/the-sized-trait/"><em>The Sized Trait</em></a> and <a href="/blog/2015/01/object-safety/"><em>Object Safety</em></a>. It’s
been long enough that a refresher is definitely in order, although this
isn’t complete coverage of the details.</p>

<details class="post-series">
  <summary class="post-series-title">Other posts in this series on trait objects</summary>
  <ol class="post-series-list">
    <li class=""><a href="/blog/2015/01/peeking-inside-trait-objects/">Peeking inside Trait Objects</a></li>
    <li class=""><a href="/blog/2015/01/the-sized-trait/">The Sized Trait</a></li>
    <li class=""><a href="/blog/2015/01/object-safety/">Object Safety</a></li>
    <li class="current"><a href="/blog/2015/05/where-self-meets-sized-revisiting-object-safety/">Where Self Meets Sized: Revisting Object Safety</a></li>
  </ol>
</details>

<h2 id="recap">Recap</h2>

<p>Rust offers open sets of types, type erasure and dynamic dispatch via
<a href="/blog/2015/01/peeking-inside-trait-objects/">trait objects</a>. However, to ensure a uniform handling
of trait objects and non-trait objects in generic code, there are
certain restrictions about exactly which traits can be used to create
objects: this is <a href="/blog/2015/01/object-safety/">object safety</a>.</p>

<p>A trait is object safe only if the compiler can automatically
implement it for itself, by implementing each method as a dynamic
function call through the vtable stored in a trait object.</p>

<figure class="highlight"><pre><code class="language-rust" data-lang="rust"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td><td class="code"><pre><span class="k">trait</span> <span class="n">Foo</span> <span class="p">{</span>
    <span class="k">fn</span> <span class="nf">method_a</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="nb">u8</span><span class="p">;</span>

    <span class="k">fn</span> <span class="nf">method_b</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="nb">f32</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="nb">String</span><span class="p">;</span>
<span class="p">}</span>

<span class="c">// automatically inserted by the compiler</span>
<span class="k">impl</span><span class="o">&lt;</span><span class="nv">'a</span><span class="o">&gt;</span> <span class="n">Foo</span> <span class="k">for</span> <span class="n">Foo</span><span class="o">+</span><span class="nv">'a</span> <span class="p">{</span>
    <span class="k">fn</span> <span class="nf">method_a</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="nb">u8</span> <span class="p">{</span>
         <span class="c">// dynamic dispatch to `method_a` of erased type</span>
         <span class="k">self</span><span class="nf">.method_a</span><span class="p">()</span>
    <span class="p">}</span>
    <span class="k">fn</span> <span class="nf">method_b</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="nb">f32</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="nb">String</span> <span class="p">{</span>
         <span class="c">// as above</span>
         <span class="k">self</span><span class="nf">.method_b</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>Without the object safety rules one can write functions with type
signatures satisfied by trait objects, where the internals make it
impossible to actually use with trait objects. However, Rust tries to ensure
that this can’t happen—code should only need to know the signatures
of anything it calls, not the internals—and hence object safety.</p>

<p>These rules outlaw creating trait objects of, for example, traits with
generic methods:</p>

<figure class="highlight"><pre><code class="language-rust" data-lang="rust"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td><td class="code"><pre><span class="k">trait</span> <span class="n">Bar</span> <span class="p">{</span>
    <span class="k">fn</span> <span class="n">bad</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">T</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">impl</span> <span class="n">Bar</span> <span class="k">for</span> <span class="nb">u8</span> <span class="p">{</span>
    <span class="k">fn</span> <span class="n">bad</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="p">,</span> <span class="mi">_</span><span class="p">:</span> <span class="n">T</span><span class="p">)</span> <span class="p">{}</span>
<span class="p">}</span>

<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="o">&amp;</span><span class="mi">1_u8</span> <span class="k">as</span> <span class="o">&amp;</span><span class="n">Bar</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*
...:10:5: 10:7 error: cannot convert to a trait object because trait `Bar` is not object-safe [E0038]
...:10     &amp;1 as &amp;Bar;
           ^~
...:10:5: 10:7 note: method `bad` has generic type parameters
...:10     &amp;1 as &amp;Bar;
           ^~
*/</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>Trait object values always appear behind a pointer, like <code class="language-plaintext highlighter-rouge">&amp;SomeTrait</code>
or <code class="language-plaintext highlighter-rouge">Box&lt;AnotherTrait&gt;</code>, since the trait value “<code class="language-plaintext highlighter-rouge">SomeTrait</code>” itself
doesn’t have size known at compile time. This property is captured via
the <a href="/blog/2015/01/the-sized-trait/"><code class="language-plaintext highlighter-rouge">Sized</code> trait</a>, which is implemented for types like <code class="language-plaintext highlighter-rouge">i32</code>,
or simple <code class="language-plaintext highlighter-rouge">struct</code>s and <code class="language-plaintext highlighter-rouge">enum</code>s, but not for unsized slices <code class="language-plaintext highlighter-rouge">[T]</code>, or
the plain trait types <code class="language-plaintext highlighter-rouge">SomeTrait</code>.</p>

<h2 id="iterating-on-the-design">Iterating on the design</h2>

<p>One impact of introducing object safety was that the design of several
traits had to change. The most noticeable ones were <code class="language-plaintext highlighter-rouge">Iterator</code>, and
the IO traits <code class="language-plaintext highlighter-rouge">Read</code> and <code class="language-plaintext highlighter-rouge">Write</code> (although they were probably <code class="language-plaintext highlighter-rouge">Reader</code>
and <code class="language-plaintext highlighter-rouge">Writer</code> at that point).</p>

<p>Focusing on the former, before object safety it was defined
something<sup id="fnref:associated-type" role="doc-noteref"><a href="#fn:associated-type" class="footnote" rel="footnote">0</a></sup> like:</p>

<figure class="highlight"><pre><code class="language-rust" data-lang="rust"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre></td><td class="code"><pre><span class="k">trait</span> <span class="n">Iterator</span> <span class="p">{</span>
    <span class="k">type</span> <span class="n">Item</span><span class="p">;</span>

    <span class="k">fn</span> <span class="nf">next</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="k">self</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="nb">Option</span><span class="o">&lt;</span><span class="nn">Self</span><span class="p">::</span><span class="n">Item</span><span class="o">&gt;</span><span class="p">;</span>
    <span class="k">fn</span> <span class="nf">size_hint</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="p">(</span><span class="nb">usize</span><span class="p">,</span> <span class="nb">Option</span><span class="o">&lt;</span><span class="nb">usize</span><span class="o">&gt;</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* ... */</span> <span class="p">}</span>

    <span class="c">// ... methods methods methods ...</span>

    <span class="k">fn</span> <span class="n">zip</span><span class="o">&lt;</span><span class="n">U</span><span class="o">&gt;</span><span class="p">(</span><span class="k">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">U</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="n">Zip</span><span class="o">&lt;</span><span class="n">Self</span><span class="p">,</span> <span class="nn">U</span><span class="p">::</span><span class="n">IntoIter</span><span class="o">&gt;</span>
        <span class="k">where</span> <span class="n">U</span><span class="p">:</span> <span class="n">IntoIterator</span>
    <span class="p">{</span> <span class="cm">/* ... */</span> <span class="p">}</span>

    <span class="k">fn</span> <span class="n">map</span><span class="o">&lt;</span><span class="n">B</span><span class="p">,</span> <span class="n">F</span><span class="o">&gt;</span><span class="p">(</span><span class="k">self</span><span class="p">,</span> <span class="n">f</span><span class="p">:</span> <span class="n">F</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">Self</span><span class="p">,</span> <span class="n">F</span><span class="o">&gt;</span>
        <span class="k">where</span> <span class="n">F</span><span class="p">:</span> <span class="nf">FnMut</span><span class="p">(</span><span class="nn">Self</span><span class="p">::</span><span class="n">Item</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="n">B</span>
    <span class="p">{</span> <span class="cm">/* ... */</span> <span class="p">}</span>

    <span class="c">// etc</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>The above <code class="language-plaintext highlighter-rouge">Iterator</code> isn’t object safe: it has generic methods, and so
it isn’t possible to implement <code class="language-plaintext highlighter-rouge">Iterator</code> for <code class="language-plaintext highlighter-rouge">Iterator</code> itself. This
is unfortunate, since it is very useful to be able to create and use
<code class="language-plaintext highlighter-rouge">Iterator</code> trait objects, so it <em>had</em> to be made object safe.</p>

<p>The solution at the time was extension traits: define a new trait
<code class="language-plaintext highlighter-rouge">IteratorExt</code> that incorporated all the object unsafe methods, and use
a blanket implementation to implement it for all <code class="language-plaintext highlighter-rouge">Iterator</code>s “from the
outside”.</p>

<figure class="highlight"><pre><code class="language-rust" data-lang="rust"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre></td><td class="code"><pre><span class="k">trait</span> <span class="n">Iterator</span> <span class="p">{</span>
    <span class="k">type</span> <span class="n">Item</span><span class="p">;</span>

    <span class="k">fn</span> <span class="nf">next</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="k">self</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="nb">Option</span><span class="o">&lt;</span><span class="nn">Self</span><span class="p">::</span><span class="n">Item</span><span class="o">&gt;</span><span class="p">;</span>

    <span class="k">fn</span> <span class="nf">size_hint</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="p">(</span><span class="nb">usize</span><span class="p">,</span> <span class="nb">Option</span><span class="o">&lt;</span><span class="nb">usize</span><span class="o">&gt;</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* ... */</span> <span class="p">}</span>
<span class="p">}</span>

<span class="k">trait</span> <span class="n">IteratorExt</span><span class="p">:</span> <span class="n">Sized</span> <span class="o">+</span> <span class="n">Iterator</span> <span class="p">{</span>
    <span class="c">// ... methods methods methods ...</span>

    <span class="k">fn</span> <span class="n">zip</span><span class="o">&lt;</span><span class="n">U</span><span class="o">&gt;</span><span class="p">(</span><span class="k">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">U</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="n">Zip</span><span class="o">&lt;</span><span class="n">Self</span><span class="p">,</span> <span class="nn">U</span><span class="p">::</span><span class="n">IntoIter</span><span class="o">&gt;</span>
        <span class="k">where</span> <span class="n">U</span><span class="p">:</span> <span class="n">IntoIterator</span>
    <span class="p">{</span> <span class="cm">/* ... */</span> <span class="p">}</span>

    <span class="k">fn</span> <span class="n">map</span><span class="o">&lt;</span><span class="n">B</span><span class="p">,</span> <span class="n">F</span><span class="o">&gt;</span><span class="p">(</span><span class="k">self</span><span class="p">,</span> <span class="n">f</span><span class="p">:</span> <span class="n">F</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">Self</span><span class="p">,</span> <span class="n">F</span><span class="o">&gt;</span>
        <span class="k">where</span> <span class="n">F</span><span class="p">:</span> <span class="nf">FnMut</span><span class="p">(</span><span class="nn">Self</span><span class="p">::</span><span class="n">Item</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="n">B</span>
    <span class="p">{</span> <span class="cm">/* ... */</span> <span class="p">}</span>

    <span class="c">// etc</span>
<span class="p">}</span>
<span class="c">// blanket impl, for all iterators</span>
<span class="k">impl</span><span class="o">&lt;</span><span class="n">I</span><span class="p">:</span> <span class="n">Iterator</span><span class="o">&gt;</span> <span class="n">IteratorExt</span> <span class="k">for</span> <span class="n">I</span> <span class="p">{}</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>The <code class="language-plaintext highlighter-rouge">next</code> and <code class="language-plaintext highlighter-rouge">size_hint</code> methods are object safe, so this version of
<code class="language-plaintext highlighter-rouge">Iterator</code> can create trait objects: <code class="language-plaintext highlighter-rouge">Box&lt;Iterator&lt;Item = u8&gt;&gt;</code> is a
legal iterator over bytes. It works because the methods of
<code class="language-plaintext highlighter-rouge">IteratorExt</code> are no longer part of <code class="language-plaintext highlighter-rouge">Iterator</code> and so they’re not
involved in any object considerations for it.</p>

<p>Fortunately, those methods aren’t lost on trait objects, because there
are implementations like the following, allowing the blanket
implementation of <code class="language-plaintext highlighter-rouge">IteratorExt</code> to kick in:</p>

<figure class="highlight"><pre><code class="language-rust" data-lang="rust"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="code"><pre><span class="c">// make Box&lt;...&gt; an Iterator by deferring to the contents</span>
<span class="k">impl</span><span class="o">&lt;</span><span class="n">I</span><span class="p">:</span> <span class="n">Iterator</span> <span class="o">+</span> <span class="o">?</span><span class="n">Sized</span><span class="o">&gt;</span> <span class="n">Iterator</span> <span class="k">for</span> <span class="nb">Box</span><span class="o">&lt;</span><span class="n">I</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="k">type</span> <span class="n">Item</span> <span class="o">=</span> <span class="nn">I</span><span class="p">::</span><span class="n">Item</span><span class="p">;</span>

    <span class="k">fn</span> <span class="nf">next</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="k">self</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="nb">Option</span><span class="o">&lt;</span><span class="nn">I</span><span class="p">::</span><span class="n">Item</span><span class="o">&gt;</span> <span class="p">{</span>
        <span class="p">(</span><span class="o">**</span><span class="k">self</span><span class="p">)</span><span class="nf">.next</span><span class="p">()</span>
    <span class="p">}</span>

    <span class="k">fn</span> <span class="nf">size_hint</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="p">(</span><span class="nb">usize</span><span class="p">,</span> <span class="nb">Option</span><span class="o">&lt;</span><span class="nb">usize</span><span class="o">&gt;</span><span class="p">)</span> <span class="p">{</span>
        <span class="p">(</span><span class="o">**</span><span class="k">self</span><span class="p">)</span><span class="nf">.size_hint</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></figure>

<div class="join"></div>

<p>(The <code class="language-plaintext highlighter-rouge">?Sized</code> ensures this applies to <code class="language-plaintext highlighter-rouge">Box&lt;Iterator&lt;...&gt;&gt;</code> trait
objects as well as simply <code class="language-plaintext highlighter-rouge">Box&lt;SomeType&gt;</code> where <code class="language-plaintext highlighter-rouge">SomeType</code> is a normal
type that implements <code class="language-plaintext highlighter-rouge">Iterator</code>.)</p>

<p>This approach has some benefits, like clarifying the separation
between the “core” methods (<code class="language-plaintext highlighter-rouge">next</code> and <code class="language-plaintext highlighter-rouge">size_hint</code>) and the
helpers. However, it has several downsides, especially for cases that
aren’t <code class="language-plaintext highlighter-rouge">Iterator</code>:</p>

<ul>
  <li>extra traits in the documentation,</li>
  <li>users will have to import those extra traits</li>
  <li>it only works with default-able methods,</li>
  <li>the defaults can’t be overridden, e.g. there’s no way for a specific
type to slot in a more efficient way to implement a method</li>
</ul>

<p>All-in-all, it was a wet blanket on libraries. Fortunately, not all
was lost: let’s meet our saviour.</p>

<h2 id="its-a-bird-its-a-plane">It’s a bird… it’s a plane…</h2>

<p>It’s a <a href="https://github.com/rust-lang/rfcs/blob/master/text/0135-where.md"><code class="language-plaintext highlighter-rouge">where</code> clause</a>!</p>

<p><code class="language-plaintext highlighter-rouge">where</code> clauses allow predicating functions/methods/types on
essentially arbitrary trait relationships, not just the plain <code class="language-plaintext highlighter-rouge">&lt;T:
SomeTrait&gt;</code>, where the left-hand side has to be a generic type
declared right then and there. For example, one can use
<a href="http://doc.rust-lang.org/std/convert/trait.From.html"><code class="language-plaintext highlighter-rouge">From</code></a> to
convert <em>to</em> types with a <code class="language-plaintext highlighter-rouge">where</code> clause.</p>

<figure class="highlight"><pre><code class="language-rust" data-lang="rust"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="code"><pre><span class="k">fn</span> <span class="n">convert_to_string</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">T</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="nb">String</span>
    <span class="k">where</span> <span class="nb">String</span><span class="p">:</span> <span class="n">From</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span>
<span class="p">{</span>
    <span class="nn">String</span><span class="p">::</span><span class="nf">from</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>The important realisation was that <code class="language-plaintext highlighter-rouge">where</code> allows placing restrictions
on <code class="language-plaintext highlighter-rouge">Self</code> directly on methods, so that certain methods only exist for
some implementing types. This was used to great effect to collapse
piles of traits into a single one, for example in <code class="language-plaintext highlighter-rouge">std::iter</code>.
<a href="http://doc.rust-lang.org/0.12.0/std/iter/#traits">Rust 0.12.0 had</a> a
swathe of extra <code class="language-plaintext highlighter-rouge">Iterator</code> traits: <code class="language-plaintext highlighter-rouge">Additive...</code>, <code class="language-plaintext highlighter-rouge">Cloneable...</code>,
<code class="language-plaintext highlighter-rouge">Multiplicative...</code>, <code class="language-plaintext highlighter-rouge">MutableDoubleEnded...</code>, <code class="language-plaintext highlighter-rouge">Ord...</code>.</p>

<p>Each of these were designed to define a few extra methods that
required specific restrictions on the element type of the iterator,
for example, <code class="language-plaintext highlighter-rouge">OrdIterator</code> needed <code class="language-plaintext highlighter-rouge">Ord</code> elements:</p>

<figure class="highlight"><pre><code class="language-rust" data-lang="rust"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="code"><pre><span class="k">trait</span> <span class="n">OrdIterator</span><span class="p">:</span> <span class="n">Iterator</span> <span class="p">{</span>
     <span class="k">fn</span> <span class="nf">max</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="k">self</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="nb">Option</span><span class="o">&lt;</span><span class="nn">Self</span><span class="p">::</span><span class="n">Item</span><span class="o">&gt;</span><span class="p">;</span>
     <span class="c">// ...</span>
<span class="p">}</span>

<span class="k">impl</span><span class="o">&lt;</span><span class="n">A</span><span class="p">:</span> <span class="nb">Ord</span><span class="p">,</span> <span class="n">I</span><span class="p">:</span> <span class="n">Iterator</span><span class="o">&lt;</span><span class="n">Item</span> <span class="o">=</span> <span class="n">A</span><span class="o">&gt;&gt;</span> <span class="n">OrdIterator</span> <span class="k">for</span> <span class="n">I</span> <span class="p">{</span>
    <span class="k">fn</span> <span class="nf">max</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="k">self</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="nb">Option</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span> <span class="p">{</span> <span class="cm">/* ... */</span> <span class="p">}</span>

    <span class="c">// ...</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>The <a href="http://doc.rust-lang.org/std/iter">current <code class="language-plaintext highlighter-rouge">std::iter</code></a> is much
cleaner: all the traits above have been merged into <code class="language-plaintext highlighter-rouge">Iterator</code> itself
with <code class="language-plaintext highlighter-rouge">where</code> clauses, e.g.
<a href="http://doc.rust-lang.org/nightly/std/iter/trait.Iterator.html#method.max"><code class="language-plaintext highlighter-rouge">max</code></a>:</p>

<figure class="highlight"><pre><code class="language-rust" data-lang="rust"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="code"><pre><span class="k">trait</span> <span class="n">Iterator</span> <span class="p">{</span>
    <span class="k">type</span> <span class="n">Item</span><span class="p">;</span>

    <span class="c">// ...</span>

    <span class="k">fn</span> <span class="nf">max</span><span class="p">(</span><span class="k">self</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="nb">Option</span><span class="o">&lt;</span><span class="nn">Self</span><span class="p">::</span><span class="n">Item</span><span class="o">&gt;</span>
        <span class="k">where</span> <span class="nn">Self</span><span class="p">::</span><span class="n">Item</span><span class="p">:</span> <span class="nb">Ord</span>
    <span class="p">{</span> <span class="cm">/* ... */</span> <span class="p">}</span>

    <span class="c">// ...</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>Notably, there’s no restriction on <code class="language-plaintext highlighter-rouge">Item</code> for general <code class="language-plaintext highlighter-rouge">Iterator</code>s,
only on <code class="language-plaintext highlighter-rouge">max</code>, so iterators retain full flexibility while still
gaining a <code class="language-plaintext highlighter-rouge">max</code> method that only works when it should:</p>

<figure class="highlight"><pre><code class="language-rust" data-lang="rust"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="code"><pre><span class="k">struct</span> <span class="n">NotOrd</span><span class="p">;</span>

<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="p">(</span><span class="mi">0</span><span class="o">..</span><span class="mi">10</span><span class="p">)</span><span class="nf">.max</span><span class="p">();</span> <span class="c">// ok</span>
    <span class="p">(</span><span class="mi">0</span><span class="o">..</span><span class="mi">10</span><span class="p">)</span><span class="nf">.map</span><span class="p">(|</span><span class="mi">_</span><span class="p">|</span> <span class="n">NotOrd</span><span class="p">)</span><span class="nf">.max</span><span class="p">();</span>
<span class="p">}</span>
<span class="cm">/*
...:5:29: 5:34 error: the trait `core::cmp::Ord` is not implemented for the type `NotOrd` [E0277]
...:5     (0..10).map(|_| NotOrd).max();
                                  ^~~~~
*/</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>This approach works fine for normal traits like <code class="language-plaintext highlighter-rouge">Ord</code>, and also works
equally well for “special” traits like <code class="language-plaintext highlighter-rouge">Sized</code>:
<a href="http://stackoverflow.com/a/27820018/1256624">it is possible</a> to
restrict methods to only work when <code class="language-plaintext highlighter-rouge">Self</code> has a statically known size
with <code class="language-plaintext highlighter-rouge">where Self: Sized</code>. Initially this had no interaction with
object safety, it would just influence what exactly that method could
do.</p>

<h2 id="putting-it-together">Putting it together</h2>

<p>The piece that interacts with object safety is <a href="https://github.com/rust-lang/rfcs/pull/817">RFC 817</a>, which
made <code class="language-plaintext highlighter-rouge">where Self: Sized</code> special: the compiler now understands that
methods tagged with that cannot ever be used on a trait object, even
in generic code.  This means it is perfectly correct to completely
ignores any methods with that <code class="language-plaintext highlighter-rouge">where</code> clause when checking object
safety.</p>

<p>The bad example from the start can be written to compile:</p>

<figure class="highlight"><pre><code class="language-rust" data-lang="rust"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="code"><pre><span class="k">trait</span> <span class="n">Bar</span> <span class="p">{</span>
    <span class="k">fn</span> <span class="n">bad</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">T</span><span class="p">)</span>
        <span class="k">where</span> <span class="n">Self</span><span class="p">:</span> <span class="n">Sized</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">impl</span> <span class="n">Bar</span> <span class="k">for</span> <span class="nb">u8</span> <span class="p">{</span>
    <span class="k">fn</span> <span class="n">bad</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="p">,</span> <span class="mi">_</span><span class="p">:</span> <span class="n">T</span><span class="p">)</span>
        <span class="k">where</span> <span class="n">Self</span><span class="p">:</span> <span class="n">Sized</span>
    <span class="p">{}</span>
<span class="p">}</span>

<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="o">&amp;</span><span class="mi">1_u8</span> <span class="k">as</span> <span class="o">&amp;</span><span class="n">Bar</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></figure>

<div class="join"></div>

<p>And also adjusted to not compile: try calling <code class="language-plaintext highlighter-rouge">(&amp;1_u8 as
&amp;Bar).bad("foo")</code> in <code class="language-plaintext highlighter-rouge">main</code> and the compiler spits out an error,</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="code"><pre>...:13:21: 13:31 error: the trait `core::marker::Sized` is not implemented for the type `Bar` [E0277]
...:13     (&amp;1_u8 as &amp;Bar).bad("foo")
                           ^~~~~~~~~~
...:13:21: 13:31 note: `Bar` does not have a constant size known at compile-time
...:13     (&amp;1_u8 as &amp;Bar).bad("foo")
                           ^~~~~~~~~~
</pre></td></tr></tbody></table></code></pre></figure>

<p>Importantly, this solves the <code class="language-plaintext highlighter-rouge">Iterator</code> problem: there’s no longer a
need to split methods into extension traits to ensure object safety,
one can instead just guard the bad ones. <code class="language-plaintext highlighter-rouge">Iterator</code> now looks like:</p>

<figure class="highlight"><pre><code class="language-rust" data-lang="rust"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre></td><td class="code"><pre><span class="k">trait</span> <span class="n">Iterator</span> <span class="p">{</span>
    <span class="k">type</span> <span class="n">Item</span><span class="p">;</span>

    <span class="k">fn</span> <span class="nf">next</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="k">self</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="nb">Option</span><span class="o">&lt;</span><span class="nn">Self</span><span class="p">::</span><span class="n">Item</span><span class="o">&gt;</span><span class="p">;</span>

    <span class="k">fn</span> <span class="nf">size_hint</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="p">(</span><span class="nb">usize</span><span class="p">,</span> <span class="nb">Option</span><span class="o">&lt;</span><span class="nb">usize</span><span class="o">&gt;</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* ... */</span> <span class="p">}</span>

    <span class="c">// ... methods methods methods ...</span>

    <span class="k">fn</span> <span class="n">zip</span><span class="o">&lt;</span><span class="n">U</span><span class="o">&gt;</span><span class="p">(</span><span class="k">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">U</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="n">Zip</span><span class="o">&lt;</span><span class="n">Self</span><span class="p">,</span> <span class="nn">U</span><span class="p">::</span><span class="n">IntoIter</span><span class="o">&gt;</span>
        <span class="k">where</span> <span class="n">Self</span><span class="p">:</span> <span class="n">Sized</span><span class="p">,</span> <span class="n">U</span><span class="p">:</span> <span class="n">IntoIterator</span>
    <span class="p">{</span> <span class="cm">/* ... */</span> <span class="p">}</span>

    <span class="k">fn</span> <span class="n">map</span><span class="o">&lt;</span><span class="n">B</span><span class="p">,</span> <span class="n">F</span><span class="o">&gt;</span><span class="p">(</span><span class="k">self</span><span class="p">,</span> <span class="n">f</span><span class="p">:</span> <span class="n">F</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">Self</span><span class="p">,</span> <span class="n">F</span><span class="o">&gt;</span>
        <span class="k">where</span> <span class="n">Self</span><span class="p">:</span> <span class="n">Sized</span><span class="p">,</span> <span class="n">F</span><span class="p">:</span> <span class="nf">FnMut</span><span class="p">(</span><span class="nn">Self</span><span class="p">::</span><span class="n">Item</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="n">B</span>
    <span class="p">{</span> <span class="cm">/* ... */</span> <span class="p">}</span>

    <span class="c">// etc</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></figure>

<div class="join"></div>

<p>(Along with <code class="language-plaintext highlighter-rouge">max</code> and the other <code class="language-plaintext highlighter-rouge">where</code>-reliant methods from the other
<code class="language-plaintext highlighter-rouge">*Iterator</code> traits mentioned above.)</p>

<p>The extra flexibility this <code class="language-plaintext highlighter-rouge">where</code> clauses offer is immensely helpful
for designing that perfect API.  Of course, just adding <code class="language-plaintext highlighter-rouge">where Self:
Sized</code> isn’t a complete solution or the only trick: the current
<code class="language-plaintext highlighter-rouge">Iterator</code> still has the same sort of implementations of <code class="language-plaintext highlighter-rouge">Iterator</code>
for <code class="language-plaintext highlighter-rouge">Box&lt;I&gt;</code> where <code class="language-plaintext highlighter-rouge">I: Iterator + ?Sized</code>, and traits using the
<code class="language-plaintext highlighter-rouge">where</code> technique may want to adopt others that <code class="language-plaintext highlighter-rouge">Iterator</code> does.</p>

<section id="external-links" class="no-print">
  
  <div id="comments">
    <span class="external-label">Comments:</span>
    <ul class="external-list">
      
<li class="external-link"><a href="https://users.rust-lang.org/t/where-self-meets-sized-revisting-object-safety/1249">users</a></li>


      
<li class="external-link"><a href="http://www.reddit.com/r/rust/comments/351pil/where_self_meets_sized_revisiting_object_safety/">/r/rust</a></li>


      

      

      
    </ul>
  </div>
  
  <div id="external-page">
    <span class="external-label">Share this on</span>
    <ul class="external-list">
      <li class="external-link"><a href="https://twitter.com/intent/tweet?text=Where%20Self%20Meets%20Sized:%20Revisiting%20Object%20Safety%20%23rustlang&amp;url=https://huonw.github.io/blog/2015/05/where-self-meets-sized-revisiting-object-safety/&amp;via=huon_w" target="_blank" rel="nofollow noopener" title="Share on Twitter">Twitter</a></li>
      <li class="external-link"><a href="https://facebook.com/sharer.php?u=https://huonw.github.io/blog/2015/05/where-self-meets-sized-revisiting-object-safety/" rel="nofollow noopener" target="_blank" title="Share on Facebook">Facebook</a></li>
      <li class="external-link"><a href="https://www.reddit.com/submit?url=https://huonw.github.io/blog/2015/05/where-self-meets-sized-revisiting-object-safety/&amp;title=Where%20Self%20Meets%20Sized:%20Revisiting%20Object%20Safety" rel="nofollow noopener" target="_blank" title="Share on Reddit">Reddit</a></li>
    </ul>
  </div>
</section>

<div class="footnotes" role="doc-endnotes">
  <ol start="0">
    <li id="fn:associated-type" role="doc-endnote">
      <p>I’m using an associated type for <code class="language-plaintext highlighter-rouge">Item</code> here, but
                I believe it was probably still a generic
                parameter <code class="language-plaintext highlighter-rouge">trait Iterator&lt;Item&gt; { ...</code> at this
                point, and the <code class="language-plaintext highlighter-rouge">IntoIterator</code> trait didn’t
                exist. However it doesn’t matter: the exact same
                problems existed, just with different syntax. <a href="#fnref:associated-type" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
  </ol>
</div>

    </article>

    
    <footer id="more" class="no-print">
      <div id="by-line">
  <a href="/about"><div class="no-print" id="me-icon"></div></a>

<p>I'm <strong>Huon Wilson</strong> <a href="https://twitter.com/huon_w">@huon_w</a>, a
 mathematically and statistically inclined software engineer.
 I have been a long-term volunteer
 on <a href="http://rust-lang.org">Rust</a>'s core team, a
 compiler engineer on the <a href="https://swift.org/">Swift</a> team
 at Apple, and a senior software engineer at CSIRO's Data61, working on the <a href="https://github.com/stellargraph/stellargraph">StellarGraph
 graph machine learning library</a>.
</p>
</div>
      <h2 id="latest-heading"><a href="/blog">Latest posts</a></h2>
      
      <nav>
        <ul id="latest-list"><!--
           
           --><li class="latest-post">
                <a href="/blog/2024/03/qr-base10-base64/">
                   <h3>10 > 64, in QR codes</h3>
                     <p>QR codes reverse the usual order: decimal works better than base64 for encoding binary data, despite it requiring many more digits.
</p>
                   
                 </a>
            </li><!--
          
           --><li class="latest-post">
                <a href="/blog/2021/10/nsw-covid-qr/">
                   <h3>Mechanical sympathy for QR codes: making NSW check-in better</h3>
                     <p>QR codes are now critical infrastructure here in NSW, Australia. Let’s learn how to make them better.
</p>
                   
                 </a>
            </li><!--
          
           --><li class="latest-post">
                <a href="/blog/2021/09/qr-error-correction/">
                   <h3>QR error correction helps and hinders scanning</h3>
                     <p>A QR code can use one of four error correction levels. Higher error correction forces denser codes, but allows scanning in more situations. A trade-off!
</p>
                   
                 </a>
            </li><!--
          
      --></ul>
      </nav>
    </footer>
    
  </main>

  <footer id="page-footer">
    <span>Huon Wilson &mdash; <span class="date">2021</span></span>
  </footer>
</div>



<!-- Default Statcounter code for huonw.github.io
http://huonw.github.io -->
<script type="text/javascript">
var sc_project=7439209;
var sc_invisible=1;
var sc_security="b96244c7";
</script>
<script type="text/javascript"
src="https://www.statcounter.com/counter/counter.js"
async></script>
<noscript><div class="statcounter"><a title="hit counter"
href="https://statcounter.com/" target="_blank"><img
class="statcounter"
src="https://c.statcounter.com/7439209/0/b96244c7/1/"
alt="hit counter"
referrerPolicy="no-referrer-when-downgrade"></a></div></noscript>
<!-- End of Statcounter Code -->

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-62534856-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-62534856-1');
</script>



</body> </html>
