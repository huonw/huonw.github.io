<!DOCTYPE HTML>
<html lang="en">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>  Some notes on Send and Sync |  Huon on the internet</title>

  <link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Atom feed">
  <link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="RSS feed">
  
  <link rel="canonical" href="https://huonw.github.io/blog/2015/02/some-notes-on-send-and-sync/">

  <meta name="viewport" content="width=device-width; initial-scale=1.0;" />
  

  
  <meta name="description" content="The `Send` and `Sync` traits in Rust are cool, here are two edge-ish cases.
" />

  
  <meta name="twitter:card" content="summary" />
  
  <meta name="twitter:site" content="@huon_w" />
  <meta name="twitter:title" content="Some notes on Send and Sync" />
  <meta name="twitter:description" content="The `Send` and `Sync` traits in Rust are cool, here are two edge-ish cases.
" />
  <meta name="twitter:url" content="https://huonw.github.io/blog/2015/02/some-notes-on-send-and-sync/">

  <!-- facebook -->
  <meta property="og:url" content="https://huonw.github.io/blog/2015/02/some-notes-on-send-and-sync/" />
  <meta property="og:title" content="Some notes on Send and Sync" />
  <meta property="og:description" content="The `Send` and `Sync` traits in Rust are cool, here are two edge-ish cases.
" />
  
  <meta property="og:type" content="article" />
  
  
  
  <style>
    /*! modern-normalize v1.1.0 | MIT License | https://github.com/sindresorhus/modern-normalize */
*,::after,::before{box-sizing:border-box}html{line-height:1.15;-webkit-text-size-adjust:100%;-moz-tab-size:4;tab-size:4}body{margin:0;font-family:system-ui, -apple-system,'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji'}hr{height:0;color:inherit}abbr[title]{text-decoration:underline dotted}b,strong{font-weight:bolder}code,kbd,pre,samp{font-family:ui-monospace, SFMono-Regular, Consolas, 'Liberation Mono', Menlo, monospace;font-size:1em}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-0.25em}sup{top:-0.5em}table{text-indent:0;border-color:inherit}button,input,optgroup,select,textarea{font-family:inherit;font-size:100%;line-height:1.15;margin:0}button,select{text-transform:none}[type='button'],[type='reset'],[type='submit'],button{-webkit-appearance:button}::-moz-focus-inner{border-style:none;padding:0}:-moz-focusring{outline:1px dotted ButtonText}:-moz-ui-invalid{box-shadow:none}legend{padding:0}progress{vertical-align:baseline}::-webkit-inner-spin-button,::-webkit-outer-spin-button{height:auto}[type='search']{-webkit-appearance:textfield;outline-offset:-2px}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}summary{display:list-item}


    
      /* Borrowed from mojombo: https://github.com/mojombo/mojombo.github.com/blob/master/css/syntax.css */

.lineno { width: 2em; text-align:right; }
.highlight pre {
  white-space: pre;
}
.highlight .c { color: #777; font-style: italic; } /* Comment */
.highlight .err { color: #a61717; background-color: #e3d2d2 } /* Error */
.highlight .k { font-weight: bold } /* Keyword */
.highlight .o { font-weight: bold } /* Operator */
.highlight .cm { color: #999988; font-style: italic } /* Comment.Multiline */
.highlight .cp { color: #999999; font-weight: bold } /* Comment.Preproc */
.highlight .c1 { color: #999988; font-style: italic } /* Comment.Single */
.highlight .cs { color: #999999; font-weight: bold; font-style: italic } /* Comment.Special */
.highlight .gd { color: #000000; background-color: #ffdddd } /* Generic.Deleted */
.highlight .gd .x { color: #000000; background-color: #ffaaaa } /* Generic.Deleted.Specific */
.highlight .ge { font-style: italic } /* Generic.Emph */
.highlight .gr { color: #aa0000 } /* Generic.Error */
.highlight .gh { color: #999999 } /* Generic.Heading */
.highlight .gi { color: #000000; background-color: #ddffdd } /* Generic.Inserted */
.highlight .gi .x { color: #000000; background-color: #aaffaa } /* Generic.Inserted.Specific */
.highlight .go { color: #888888 } /* Generic.Output */
.highlight .gp { color: #555555 } /* Generic.Prompt */
.highlight .gs { font-weight: bold } /* Generic.Strong */
.highlight .gu { color: #aaaaaa } /* Generic.Subheading */
.highlight .gt { color: #aa0000 } /* Generic.Traceback */
.highlight .kc { font-weight: bold } /* Keyword.Constant */
.highlight .kd { font-weight: bold } /* Keyword.Declaration */
.highlight .kp { font-weight: bold } /* Keyword.Pseudo */
.highlight .kr { font-weight: bold } /* Keyword.Reserved */
.highlight .kt { color: #445588; font-weight: bold } /* Keyword.Type */
.highlight .m { color: #009999 } /* Literal.Number */
.highlight .s { color: #d14 } /* Literal.String */
.highlight .na { color: #008080 } /* Name.Attribute */
.highlight .nb { color: #0086B3 } /* Name.Builtin */
.highlight .nc { color: #445588; font-weight: bold } /* Name.Class */
.highlight .no { color: #008080 } /* Name.Constant */
.highlight .ni { color: #800080 } /* Name.Entity */
.highlight .ne { color: #990000; font-weight: bold } /* Name.Exception */
.highlight .nf { color: #990000; font-weight: bold } /* Name.Function */
.highlight .nn { color: #555555 } /* Name.Namespace */
.highlight .nt { color: #000080 } /* Name.Tag */
.highlight .nv { color: #008080 } /* Name.Variable */
.highlight .ow { font-weight: bold } /* Operator.Word */
.highlight .w { color: #bbbbbb } /* Text.Whitespace */
.highlight .mf { color: #009999 } /* Literal.Number.Float */
.highlight .mh { color: #009999 } /* Literal.Number.Hex */
.highlight .mi { color: #009999 } /* Literal.Number.Integer */
.highlight .mo { color: #009999 } /* Literal.Number.Oct */
.highlight .sb { color: #d14 } /* Literal.String.Backtick */
.highlight .sc { color: #d14 } /* Literal.String.Char */
.highlight .sd { color: #d14 } /* Literal.String.Doc */
.highlight .s2 { color: #d14 } /* Literal.String.Double */
.highlight .se { color: #d14 } /* Literal.String.Escape */
.highlight .sh { color: #d14 } /* Literal.String.Heredoc */
.highlight .si { color: #d14 } /* Literal.String.Interpol */
.highlight .sx { color: #d14 } /* Literal.String.Other */
.highlight .sr { color: #009926 } /* Literal.String.Regex */
.highlight .s1 { color: #d14 } /* Literal.String.Single */
.highlight .ss { color: #990073 } /* Literal.String.Symbol */
.highlight .bp { color: #999999 } /* Name.Builtin.Pseudo */
.highlight .vc { color: #008080 } /* Name.Variable.Class */
.highlight .vg { color: #008080 } /* Name.Variable.Global */
.highlight .vi { color: #008080 } /* Name.Variable.Instance */
.highlight .il { color: #009999 } /* Literal.Number.Integer.Long */


html {
    min-height:100%;
}

* {
  margin: 0;
}
* + * {
  margin-top: 0.75em;
}


body {
  padding:0px;
    counter-reset: footnotes;
    counter-reset: figure;
    margin:0px;
    font-size: 18px;
    background: white;
    color: #101010;

    font-variant: common-ligatures;
    -moz-font-feature-settings: "kern" on;
    -webkit-font-feature-settings: "kern" on;
    font-feature-settings: "kern" on;
}

#wrapper {
    margin: 0 auto;
    max-width: 630px;
    padding: 0.75em 15px;
    width: 100%;
    position:relative;
}

.lazily-filled {
  position: relative;
}
.lazily-filled > * {
  z-index: 0;
}
.lazily-filled::before {
  position: absolute;
  top: 0;
  left: 0;
  content: "";
  width: 100%;
  height: 100%;
  display: block;
  background-color: rgb(229, 236, 246);
  z-index: 1;
}
.lazily-filled::after {
  position: absolute;
  top: 50%;
  left: 50%;
  content: "";
  display: block;
  width: 128px;
  height: 128px;
  margin-left: -64px;
  margin-top: -64px;
  border-radius: 50%;
  border: 12px solid;
  border-color: white transparent;
  animation: spinner 5s linear;
  /* eventually stop animating when it's hidden */
  animation-iteration-count: 10;
  z-index: 2;
}
.lazily-filled::before, .lazily-filled::after {
  opacity: 0;
  transition: all 0.5s ease;
  pointer-events: none;
}
.lazily-filled:empty::before, .lazily-filled:empty::after {
  opacity: 1;
  animation-iteration-count: infinite;
  visibility: visible;
}
@keyframes spinner {
  0% {
    transform: rotate(0deg);
  }
  100% {
    transform: rotate(360deg);
  }
}

.plotly-plot * + * {
  margin-top: 0;
}

/* wonky safari */
.plotly text[style*="white-space: pre"] {
  white-space: nowrap !important;
}


/* lists */
li + li {
  margin-top: 0.5em;
}
ul, ol {
  padding-left: 1.5em;
}

table {
  margin-left: auto;
  margin-right: auto;
  border-collapse: collapse;
  text-align: left;
}

td, th {
  padding: 0.1em 0.75em;
}
@media (max-width: 500px) {
  td, th {
    padding-left: 0.375em;
    padding-right: 0.375em;
  }
}
tr:nth-child(even) {
  background: rgba(0, 0, 0, 5%);
}
thead {
  border-bottom: 1px solid grey;
  font-weight: bold;
}

header {
  margin-bottom: 1.5em;
}
header a:not(:hover) {
  text-decoration: none;
}
#blog-title {
  hyphens: none;
  font-variant: small-caps;
  font-size: 1.5em;
  font-weight: normal;
  text-align: center;
  line-height: 1em;
}
#info-list {
  list-style: none;
  padding: 0;
  display: flex;
  justify-content: center;
  flex-wrap: wrap;
}
#info-list li {
  margin: 0 1em;
}

#page-footer {
  border-top: 1px solid lightgrey;
  padding-top: 0.75em;
  color: grey;
  text-align: right;
}

.clear { clear: both; margin: 0; }


main {
    text-align:justify;
    -moz-hyphens: auto;
    -webkit-hyphens: auto;
    -ms-hyphens: auto;
    hyphens: auto;
    line-height: 1.5em;

    position: relative;
    z-index: 10;
}

a[href] {
    color: inherit;
    text-decoration: underline;
}

/*  The authorship info */
#info-intro {
    font-style: italic;
    text-align: center;
}

/* code */

code, pre {
  font-family: monospace;
  font-variant: none;
  -moz-hyphens: none;
  -webkit-hyphens: none;
  -ms-hyphens: none;
  hyphens: none;
}

pre {
  background: #f0f0f0;
}
code {
    background: #f7f7f7;
    padding: 0 0.1em;
    font-size: 0.9em;
    border-radius: 3px;
    border: 1px solid lightgrey;
}
pre code {
    background: none;
    padding: 0;
    -moz-hyphens: none;
    -webkit-hyphens: none;
    -ms-hyphens: none;
    hyphens: none;
    border-radius: 0;
    border-width: 0;
}
h1 code, h2 code, h3 code, h4 code {
  background: rgba(255,255,255,0.1);
}

.break-all {
  word-break: break-all;
}

/* quotes and similar */

blockquote {
    border: solid #eee;
    border-width: 0 1px;
    padding: 0 1.2em;
    color: #444;
    position: relative;
    margin-left: 0;
    margin-right: 0;
}

aside {
  padding: 0 1.2em;
  color: #444;
  position: relative;
}
aside[data-icon] {
  padding-left: 2.4em;
}
aside[data-icon]:before {
  content: attr(data-icon);
  position: absolute;
  left: 0;
  text-align: center;
  width: 2.4em;
}

/* images/figures */
img, figure svg {
  max-width: 100%;
  height: auto;
}
figure svg {
  width: 100%;
}
img:not(.inline-image), figure svg {
    display: block;
    margin: 0 auto;
    clear: both;
}

.image-positioner {
  max-width: 800px;
  margin-left: auto;
  margin-right: auto;
}

img[data-caption]:before {
    content: attr(data-caption);
}
figure {
  clear: both;
}
figure.image {
  width: 100vw;
  position: relative;
  left: 50%;
  right: 50%;
  margin-left: -50vw;
  margin-right: -50vw;

  min-width: 100%;
}
figcaption {
  margin: 0 auto;
  max-width: 570px;
  padding: 0 10px;
  text-align: center;
  font-style: italic;
  font-size: 0.9em;
}
figcaption p {
  display: inline;
}
figcaption::before {
  counter-increment: figure;
  content: "Figure " counter(figure) ". ";
}

.highlight table {
  font-size: 0.9em;
  padding: 0em;
  width: 100%;
  table-layout: fixed;
  overflow-y: hidden;
  display: block;
  position: relative;
  z-index: 1;
}
[data-lang] {
  position: relative;
  display: block;
}
[data-lang]::before {
  content: attr(data-lang);
  text-transform: capitalize;
  top: 0;
  right: 0;
  position: absolute;
  font-size: 1.5em;
  color: #f3f3f3;
  z-index: 1;
}

.highlight pre {
  background: transparent;
}
.gutter {
  padding: 0;
  border: solid #ccc;
  border-width: 0 1px 0 0;
  color: #ccc;
}
.lineno {
  width: 25px;
  padding-right: 5px;
}
.highlight td.code {
  overflow-x: auto;
  padding: 0;
  padding-left: 0.5em;
}


/* HEADINGS */

h1, h2 {
    font-variant: small-caps;
}

h1, h2, h3, h4 {
  -moz-hyphens: none;
  -webkit-hyphens: none;
  -ms-hyphens: none;
  hyphens: none;
  text-align: left;
}

h1 {
  font-size: 2.2em;
  text-align: center;
  line-height: 1em;
}
h2 {
  font-size: 1.7em;
}
h3 {
  font-size: 1.4em;
}
h4 {
  font-size: 1.2em;
}

/* crates.io badges */

.lib-info {
  float: right;
  width: 150px;
  text-align: center;
  margin: 0 1em;
}
.lib-badge {
  vertical-align: middle;
}
.centered-libs {
  text-align: center;
}
.centered-libs .lib-info {
  float: none;
}

/* external links */

#external-links {
  margin-top: 2.25em;
  text-align: center;
}
.external-label {
  font-weight: bold;
}
#external-links ul {
  list-style: none;
  display: inline-block;
  padding: 0;
  margin: 0;
}
#external-links li {
  list-style: none;
  display: inline;
}

/* "Footnotes" */

/* the div that holds them */
.footnotes {
    margin-top: 2.25em;
    padding-top: 1.5em;
    border-top: 1px solid rgb(240,240,240);
    font-size: 0.9em;
}
.footnotes ol {
  padding: 0;
}
.footnotes li {
    list-style-position: outside;
    margin-left: 30px;
    margin-right: 10px;
    color: #333;
}

.footnotes li:target, .footnotes li:hover {
    color: black;
    background-color: lightyellow;
}

.footnotes .reversefootnote {
    text-decoration: none;
}

/* extra info after a post */
#more {
  margin-top: 3em;
  padding-top: 1.5em;
  border-top: 1px solid lightgray;
}
#me-icon {
  max-width: 150px;
  height: 150px;
  background: url("/img/me.jpg");
  background-size: cover;
  margin-left: auto;
  margin-right: auto;
  border-radius: 30px;
}
#by-line {
  font-size: 0.8em;
}
#latest-list {
  padding: 0;
  list-style: none;
}
#latest-heading {
  text-align: center;
}
#latest-heading a:not(:hover) {
  text-decoration: none;
}
#latest-list a:hover h3 {
  text-decoration: underline;
}
#latest-list a {
  text-decoration: none;
}
.latest-post {
  padding: 0;
  font-size: 0.8em;
}
.latest-post > h3 {
  font-weight: bold;
}
.latest-post * {
  margin: 0;
}

/* post series */

.post-series {
  font-size: 0.8em;
  border: 1px solid lightgray;
  padding: 0.2em;
  cursor: pointer;
}

.post-series-title {
  font-weight: bold;
  font-size: 1.1em;
}
.post-series-list {
  padding-left: 1.5em;
  margin: 0;
}
.post-series .current {
  font-style: italic;
}

/* archive pages */
ul.post-list {
  list-style: none;
  padding: 0;
}

.post-post {
  margin: 0;
}

.post-post + .post-post {
  border-top: 1px dashed  #ddd;
  margin-top: 1em;
  padding-top: 1em;
}

a.post-heading {
  display: flex;
  align-items: baseline;
  text-decoration: none;
  gap: 1em;
}
.post-heading * {
  margin: 0;
}

.post-title {
  font-size: 1.2em;
  flex-grow: 1;
  text-decoration: underline;
}

.post-heading .post-date {
  font-style: italic;
  flex-shrink: 0;
}

.post-excerpt p {
  display: inline;
}

.post-more {
  font-style: italic;
  white-space: nowrap;
  float: right;
  margin: 0;
  font-size: smaller;
}

.post-list .footnote, .post-list .footnotes, .post-list p:empty {
  display: none
}

/* media queries */


@media only print {
    a {
      text-decoration: none !important;
    }
    header {
        display:none !important;
    }

    h1, h2, h3, h4 {
        padding-left: 0 !important;
    }

    #wrapper {
       max-width: none !important;
    }

    .no-print {
        display: none !important;
    }

    .footnotes .reversefootnote {
         display: none !important;
    }
    [data-lang]::before {
      content: "";
    }
}

    

    
  </style>
  
</head>

<body>
<div id="wrapper">
  <header>
    <h1 id="blog-title"><a href="/">Huon on the internet</a></h1>
    <nav>
      <ul id="info-list" class="no-print">
        <li><a href="/about">About</a></li>
        <li><a href="/blog">Blog</a></li>
        <li><a href="https://github.com/huonw">GitHub</a></li>
        <li><a href="https://bsky.app/profile/huonw.bsky.social">Bluesky</a></li>
      </ul>
    </nav>
  </header>
  <main>
    <article>
      
        <h1 id="title"> Some notes on Send and Sync</h1>
        
      
      
         <div id="info-intro">
           By <a href="/about">Huon Wilson</a>
           
             &mdash; <span class="date pub-date">20 Feb 2015</span>
           
           
         </div>
      
      <p>If you’ve been in the <code class="language-plaintext highlighter-rouge">#rust-internals</code> IRC channel recently, you
may’ve caught a madman raving about how much they like Rust:</p>

<figure class="highlight"><pre><code class="language-irc" data-lang="irc"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="code"><pre>...
[15:50:03] &lt;huon&gt; I love this language
...
[20:02:07] &lt;huon&gt; did you know: Rust is awesome.
...
</pre></td></tr></tbody></table></code></pre></figure>

<p>I was (and still am) losing my mind over how well <code class="language-plaintext highlighter-rouge">Sync</code> and <code class="language-plaintext highlighter-rouge">Send</code>
interact with everything, especially now that
<a href="https://github.com/rust-lang/rust/pull/22319">the implementation</a> for
<a href="https://github.com/rust-lang/rfcs/pull/458">RFC 458</a> has landed.</p>

<p>I’m aiming to write down a few edge cases and slight subtleties here
that Aaron Turon, Niko Matsakis and I have realised; so that we (and
others) don’t have to keep rediscovering them. So, unfortunately, this
short(ish) article isn’t aiming to describe entirely why I’m so keen
on them, but…</p>

<h2 id="the-traits">The traits</h2>

<p>… I’m sure I can write something.</p>

<p>Rust aims to be a language with really good support for concurrency;
and there’s two parts to it: ownership &amp; lifetimes, and the traits
<a href="http://doc.rust-lang.org/nightly/std/marker/trait.Send.html"><code class="language-plaintext highlighter-rouge">Send</code></a> &amp; <a href="http://doc.rust-lang.org/nightly/std/marker/trait.Sync.html"><code class="language-plaintext highlighter-rouge">Sync</code></a> (the docs for these aren’t great at
the moment, especially since the latest set of improvements landed so
recently).</p>

<p>These traits capture and control the two most common ways a piece of
data be accessed and thrown around by threads, dictating whether it is
safe to transfer ownership or pass a reference into another
thread.</p>

<p>The traits are “marker traits”, meaning they have no methods and don’t
inherently provide any functionality. They serve as markers of certain
invariants that types implementing them are expected to fulfill
(they’re <code class="language-plaintext highlighter-rouge">unsafe</code> to implement manually for this reason: the
programmer has to ensure the invariants are upheld). Specifically, the
working definitions we have from them now are:</p>

<ul>
  <li>If <code class="language-plaintext highlighter-rouge">T: Send</code>, then passing by-value a value of type <code class="language-plaintext highlighter-rouge">T</code> into
another thread will not lead to data races (or other unsafety)</li>
  <li>If <code class="language-plaintext highlighter-rouge">T: Sync</code>, then passing a reference <code class="language-plaintext highlighter-rouge">&amp;T</code> to a value of type <code class="language-plaintext highlighter-rouge">T</code>
into another thread will not lead to data races (or other unsafety)
(aka, <code class="language-plaintext highlighter-rouge">T: Sync</code> implies <code class="language-plaintext highlighter-rouge">&amp;T: Send</code>)</li>
</ul>

<p>That is, <code class="language-plaintext highlighter-rouge">Sync</code> is related to how a type works when shared across
multiple threads at once, and <code class="language-plaintext highlighter-rouge">Send</code> talks about how a type behaves as
it crosses a task boundary. (These definitions are pretty vague, but
the core team is definitely very interested in firming up and
formalising them to be able to prove useful concrete things.)</p>

<p>These two traits enable a lot of useful concurrency and parallel
patterns to be expressed while guaranteeing memory safety. Basic
examples include message passing and shared memory, both immutable &amp;
mutable (e.g. with enforced atomic instructions, or protected by
locks). But more advanced things are easily possible too, with safety
falling automatically out of the type system and the design of the
standard library, e.g. manipulating (reading and writing) data stored
directly on another thread’s stack and mutating disjoint pieces of a
vector in parallel with no locking necessary.</p>

<p>(It’s worth mentioning that Rust only guarantees memory safety and,
particularly, freedom from data races, it doesn’t guarantee freedom
from other concurrence/parallelism issues, such as dead locks, and
non-data-race race conditions.)</p>

<p>I have a very basic little library, <a href="http://huonw.github.io/simple_parallel/simple_parallel/"><code class="language-plaintext highlighter-rouge">simple_parallel</code></a>
(<a href="https://github.com/huonw/simple_parallel">source</a>), that is trying to experiment with these
ideas. The examples there show off a few of the things mentioned
above, and compile today. I think its pretty cool what Rust can do.</p>

<p>Anyway, there’ll probably be lots more said about this later by me and
by others. Now, I’ll stop distracting myself and get on to the actual
notes I wanted to write down.</p>

<h2 id="sync--copy--send"><code class="language-plaintext highlighter-rouge">Sync + Copy</code> ⇒ <code class="language-plaintext highlighter-rouge">Send</code></h2>

<p>That is, if a type <code class="language-plaintext highlighter-rouge">T</code> implements both <code class="language-plaintext highlighter-rouge">Sync</code> and <code class="language-plaintext highlighter-rouge">Copy</code>, then it can
also implement <code class="language-plaintext highlighter-rouge">Send</code> (conversely, a type is only allowed to be both
<code class="language-plaintext highlighter-rouge">Sync</code> and <code class="language-plaintext highlighter-rouge">Copy</code> if it is also <code class="language-plaintext highlighter-rouge">Send</code>).</p>

<p>Proof:</p>

<figure class="highlight"><pre><code class="language-rust" data-lang="rust"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="code"><pre><span class="c">// we start with some `T` on the main thread</span>
<span class="k">let</span> <span class="n">x</span><span class="p">:</span> <span class="n">T</span> <span class="o">=</span> <span class="o">...</span><span class="p">;</span>

<span class="nn">thread</span><span class="p">::</span><span class="nf">scoped</span><span class="p">(||</span> <span class="p">{</span>
    <span class="c">// and transfer a reference to a subthread (safe, since T: Sync)</span>
    <span class="k">let</span> <span class="n">y</span><span class="p">:</span> <span class="o">&amp;</span><span class="n">T</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">x</span><span class="p">;</span>

    <span class="c">// now use `T: Copy` to duplicate the data out, meaning we've</span>
    <span class="c">// transferred `x` by-value into this new thread</span>
    <span class="k">let</span> <span class="n">z</span><span class="p">:</span> <span class="n">T</span> <span class="o">=</span> <span class="o">*</span><span class="n">y</span><span class="p">;</span>

<span class="p">})</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>The transfer happened only using <code class="language-plaintext highlighter-rouge">Sync + Copy</code> and so must be safe (if
it wasn’t safe <code class="language-plaintext highlighter-rouge">T</code> isn’t allowed to implement <code class="language-plaintext highlighter-rouge">Sync</code>), hence it is
legal for <code class="language-plaintext highlighter-rouge">T</code> to implement <code class="language-plaintext highlighter-rouge">Send</code>.</p>

<p>This might not seem so interesting, since it <em>is</em> just a specific case
of the definition of <code class="language-plaintext highlighter-rouge">Sync</code> (“can copy out of <code class="language-plaintext highlighter-rouge">&amp;</code>” is a fundamental
property of our <code class="language-plaintext highlighter-rouge">T: Copy</code> type, and so has to be considered when
considering the thread safety of <code class="language-plaintext highlighter-rouge">&amp;T</code>), but it is a little
subtle.</p>

<p>Also, needing to consider this case at all probably won’t come up for
many types; one is most likely to encounter types that are not <code class="language-plaintext highlighter-rouge">Send</code>
when storing pointers to shared memory—such as <code class="language-plaintext highlighter-rouge">Rc</code>—and
most such types are not <code class="language-plaintext highlighter-rouge">Copy</code> since they have to manage their
memory—such as <code class="language-plaintext highlighter-rouge">Rc</code> again. The two most prominent examples are
<code class="language-plaintext highlighter-rouge">&amp;</code> (which has safety ensured by <code class="language-plaintext highlighter-rouge">Sync</code> and static analysis in the
compiler: lifetimes) and a hypothetical <code class="language-plaintext highlighter-rouge">Gc&lt;T&gt;</code> pointer. I guess we’ll
just have to take care for <code class="language-plaintext highlighter-rouge">Gc</code>.</p>

<h2 id="mut-t-send-when-t-send"><code class="language-plaintext highlighter-rouge">&amp;mut T: Send</code> when <code class="language-plaintext highlighter-rouge">T: Send</code></h2>

<p>We want to work out when it is safe to transfer a mutable reference
<code class="language-plaintext highlighter-rouge">&amp;mut T</code> between threads. For the shared reference <code class="language-plaintext highlighter-rouge">&amp;T</code> it is easy:
replacing <code class="language-plaintext highlighter-rouge">&amp;T</code> with <code class="language-plaintext highlighter-rouge">U</code> in the definition of <code class="language-plaintext highlighter-rouge">Sync</code> gives the
definition of <code class="language-plaintext highlighter-rouge">Send</code> (up to alpha renaming), so <code class="language-plaintext highlighter-rouge">&amp;T: Send</code> when <code class="language-plaintext highlighter-rouge">T:
Sync</code>, which can be
<a href="https://github.com/rust-lang/rust/blob/522d09dfecbeca1595f25ac58c6d0178bbd21d7d/src/libcore/marker.rs#L388">expressed in code</a>
as</p>

<figure class="highlight"><pre><code class="language-rust" data-lang="rust"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
</pre></td><td class="code"><pre><span class="k">unsafe</span> <span class="k">impl</span><span class="o">&lt;</span><span class="nv">'a</span><span class="p">,</span> <span class="n">T</span><span class="p">:</span> <span class="n">Sync</span><span class="o">&gt;</span> <span class="nb">Send</span> <span class="k">for</span> <span class="o">&amp;</span><span class="nv">'a</span> <span class="n">T</span> <span class="p">{</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>For <code class="language-plaintext highlighter-rouge">&amp;mut</code>, you might suspect that thread-safety might depend on
<code class="language-plaintext highlighter-rouge">Sync</code> in some way since that trait is so important for the other
reference type, but, you’d be wrong. It is another example of the
dramatic semantic difference between <code class="language-plaintext highlighter-rouge">&amp;mut</code> and <code class="language-plaintext highlighter-rouge">&amp;</code> despite the
syntactic similarities.</p>

<p>The mutable reference type has the guarantee that it is globally
unaliased, so if a thread has access to a piece of data via a <code class="language-plaintext highlighter-rouge">&amp;mut</code>,
then it is the only thread in the whole program that can legally read
from/write to that data. In particular, there’s no sharing and there
cannot be several threads concurrently accessing that memory at the
same time, hence the sharing-related guarantees of <code class="language-plaintext highlighter-rouge">Sync</code> don’t
guarantee thread-safety for <code class="language-plaintext highlighter-rouge">&amp;mut</code>. (RFC 458 describes this as <code class="language-plaintext highlighter-rouge">&amp;mut</code>
linearizing access to its contents.)</p>

<p>Thinking about this, it seems like transferring a <code class="language-plaintext highlighter-rouge">&amp;mut T</code> between
threads might <em>almost</em> be safe for any <code class="language-plaintext highlighter-rouge">T</code>. The thinking might be that
<code class="language-plaintext highlighter-rouge">Send</code> describes “passing by-value” between threads, and this passing
changes fundamental properties of the program, such as where/when
destructors are run; on the other hand, passing a <code class="language-plaintext highlighter-rouge">&amp;mut T</code> is passing
by reference so doesn’t change such things, and a <code class="language-plaintext highlighter-rouge">&amp;mut</code> has unique
access, so the whole set-up is basically the same as running on the
original thread. For example, passing a <code class="language-plaintext highlighter-rouge">&amp;mut T</code> around doesn’t change
where/when the destructor of the <code class="language-plaintext highlighter-rouge">T</code> is run: it is still run when it
goes out of scope, on the main thread.</p>

<p>Unfortunately…</p>

<figure class="highlight"><pre><code class="language-rust" data-lang="rust"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="code"><pre><span class="c">// we start with some `T` on the main thread</span>
<span class="k">let</span> <span class="n">x</span><span class="p">:</span> <span class="n">T</span> <span class="o">=</span> <span class="o">...</span><span class="p">;</span>
<span class="c">// wrap it up</span>
<span class="k">let</span> <span class="k">mut</span> <span class="n">packet</span><span class="p">:</span> <span class="nb">Option</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="o">=</span> <span class="nf">Some</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>

<span class="nn">thread</span><span class="p">::</span><span class="nf">scoped</span><span class="p">(||</span> <span class="p">{</span>
    <span class="c">// and transfer just a mutable reference to the other thread</span>
    <span class="k">let</span> <span class="n">y</span><span class="p">:</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="nb">Option</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="o">=</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="n">packet</span><span class="p">;</span>

    <span class="c">// and then steal the `T` out!</span>
    <span class="k">let</span> <span class="n">z</span><span class="p">:</span> <span class="n">T</span> <span class="o">=</span> <span class="n">y</span><span class="nf">.take</span><span class="p">()</span><span class="nf">.unwrap</span><span class="p">();</span>
<span class="p">})</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>That code transfers the <code class="language-plaintext highlighter-rouge">T</code> between two threads by just transferring a
<code class="language-plaintext highlighter-rouge">&amp;mut Option&lt;T&gt;</code>. Hence, if it is illegal to transfer a <code class="language-plaintext highlighter-rouge">T</code> between
threads, by-value, it must also be illegal to transfer <code class="language-plaintext highlighter-rouge">&amp;mut
Option&lt;T&gt;</code> because we can use that to construct a <code class="language-plaintext highlighter-rouge">T</code> transfer. In
pseudo-code, if <code class="language-plaintext highlighter-rouge">T: !Send</code>, then <code class="language-plaintext highlighter-rouge">&amp;mut Option&lt;T&gt;: !Send</code> (using
“negative bounds”, meaning <code class="language-plaintext highlighter-rouge">T</code> does not implement <code class="language-plaintext highlighter-rouge">Send</code>).</p>

<p>Of course, this isn’t a failing of <code class="language-plaintext highlighter-rouge">Option</code> itself, its just a type
that makes for a direct example. One could also create one <code class="language-plaintext highlighter-rouge">T</code> in each
thread, and use <code class="language-plaintext highlighter-rouge">std::mem::swap</code> to exchange their places, causing
both <code class="language-plaintext highlighter-rouge">T</code>s to transfer by-value between threads (double the
unsafety!!).</p>

<p>The general rule is that transferring a <code class="language-plaintext highlighter-rouge">&amp;mut T</code> between threads is
guaranteed to be safe if <code class="language-plaintext highlighter-rouge">T: Send</code>, so <code class="language-plaintext highlighter-rouge">&amp;mut T</code> behaves <em>very</em> much
like <code class="language-plaintext highlighter-rouge">T</code> with relation to concurrency. (It is <em>theoretically</em> possible
to have types for which sending a <code class="language-plaintext highlighter-rouge">&amp;mut T</code> is safe, but sending a
plain <code class="language-plaintext highlighter-rouge">T</code> is not, meaning <code class="language-plaintext highlighter-rouge">&amp;mut T: Send</code> but not <code class="language-plaintext highlighter-rouge">T: Send</code>, so the
relationship is not “if and only if”, as wrongerontheinternet pointed
out on /r/rust.)</p>

<section id="external-links" class="no-print">
  
  <div id="comments">
    <span class="external-label">Comments:</span>
    <ul class="external-list">
      
<li class="external-link"><a href="http://users.rust-lang.org/t/some-notes-on-send-and-sync/400">users</a></li>


      
<li class="external-link"><a href="http://www.reddit.com/r/rust/comments/2wjwcl/some_notes_on_send_and_sync/">/r/rust</a></li>


      

      

      

      
    </ul>
  </div>
  
  <div id="external-page">
    <span class="external-label">Share this on</span>
    <ul class="external-list">
      <li class="external-link"><a href="https://bsky.app/intent/compose?text=Some%20notes%20on%20Send%20and%20Sync%20by%20@huonw.bsky.social%20https://huonw.github.io/blog/2015/02/some-notes-on-send-and-sync/" target="_blank" rel="nofollow noopener" title="Share on Bluesky">Bluesky</a></li>
      <li class="external-link"><a href="https://twitter.com/intent/tweet?text=Some%20notes%20on%20Send%20and%20Sync%20%23rustlang&amp;url=https://huonw.github.io/blog/2015/02/some-notes-on-send-and-sync/&amp;via=huon_w" target="_blank" rel="nofollow noopener" title="Share on Twitter">Twitter</a></li>
      <li class="external-link"><a href="https://facebook.com/sharer.php?u=https://huonw.github.io/blog/2015/02/some-notes-on-send-and-sync/" rel="nofollow noopener" target="_blank" title="Share on Facebook">Facebook</a></li>
      <li class="external-link"><a href="https://www.reddit.com/submit?url=https://huonw.github.io/blog/2015/02/some-notes-on-send-and-sync/&amp;title=Some%20notes%20on%20Send%20and%20Sync" rel="nofollow noopener" target="_blank" title="Share on Reddit">Reddit</a></li>
    </ul>
  </div>
</section>


    </article>

    
    <footer id="more" class="no-print">
      <div id="by-line">
  <a href="/about"><div class="no-print" id="me-icon"></div></a>

<p>I'm <a href="https://bsky.app/profile/huonw.bsky.social"><strong>Huon Wilson</strong></a>, a
 mathematically and statistically inclined software engineer.
 I have been a long-term volunteer
 on <a href="http://rust-lang.org">Rust</a>'s core team, a
 compiler engineer on the <a href="https://swift.org/">Swift</a> team
 at Apple, and a senior software engineer at CSIRO's Data61, working on the <a href="https://github.com/stellargraph/stellargraph">StellarGraph
 graph machine learning library</a>.
</p>
</div>
      <h2 id="latest-heading"><a href="/blog">Latest posts</a></h2>
      
      <nav>
        <ul id="latest-list"><!--
           
           --><li class="latest-post">
                <a href="/blog/2025/02/ci-tee/">
                   <h3>Prefer tee -a, not >>, in CI</h3>
                     <p><table>
  <tbody>
    <tr>
      <td>GitHub Actions suggests using code like echo … » $GITHUB_ENV, but echo …</td>
      <td>tee -a $GITHUB_ENV is often better.</td>
    </tr>
  </tbody>
</table>
</p>
                   
                 </a>
            </li><!--
          
           --><li class="latest-post">
                <a href="/blog/2024/08/async-hazard-mmap/">
                   <h3>Async hazard: mmap is secretly blocking IO</h3>
                     <p>Memory-mapping a file is convenient, but it’s a hazard when used with async/await concurrent code: it means a “simple” memory index does blocking IO.
</p>
                   
                 </a>
            </li><!--
          
           --><li class="latest-post">
                <a href="/blog/2024/07/github-permalinks/">
                   <h3>GitHub tip-hub: habitual permalinks</h3>
                     <p>Hit y to create a permalink to a GitHub directory, file or line. They’re easy to make, stable, and even render a preview in some places.
</p>
                   
                 </a>
            </li><!--
          
      --></ul>
      </nav>
    </footer>
    
  </main>

  <footer id="page-footer">
    <span>Huon Wilson &mdash; <span class="date">2021</span></span>
  </footer>
</div>



<!-- Default Statcounter code for huonw.github.io
http://huonw.github.io -->
<script type="text/javascript">
var sc_project=7439209;
var sc_invisible=1;
var sc_security="b96244c7";
</script>
<script type="text/javascript"
src="https://www.statcounter.com/counter/counter.js"
async></script>
<noscript><div class="statcounter"><a title="hit counter"
href="https://statcounter.com/" target="_blank"><img
class="statcounter"
src="https://c.statcounter.com/7439209/0/b96244c7/1/"
alt="hit counter"
referrerPolicy="no-referrer-when-downgrade"></a></div></noscript>
<!-- End of Statcounter Code -->

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-62534856-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-62534856-1');
</script>



</body> </html>
