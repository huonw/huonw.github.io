<!DOCTYPE HTML>
<html lang="en">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>  Take a break: Rust match has fallthrough |  Huon on the internet</title>

  <link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Atom feed">
  <link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="RSS feed">
  
  <link rel="canonical" href="https://huonw.github.io/blog/2025/03/rust-fallthrough/">

  <meta name="viewport" content="width=device-width; initial-scale=1.0;" />
  

  
  <meta name="description" content="Match + labelled blocks &amp; breaks = fallthrough. It works, but it&apos;s not very pretty!" />

  
  <meta name="twitter:card" content="summary" />
  
  <meta name="twitter:site" content="@huon_w" />
  <meta name="twitter:title" content="Take a break: Rust match has fallthrough" />
  <meta name="twitter:description" content="Match + labelled blocks &amp; breaks = fallthrough. It works, but it&apos;s not very pretty!" />
  <meta name="twitter:url" content="https://huonw.github.io/blog/2025/03/rust-fallthrough/">

  <!-- facebook -->
  <meta property="og:url" content="https://huonw.github.io/blog/2025/03/rust-fallthrough/" />
  <meta property="og:title" content="Take a break: Rust match has fallthrough" />
  <meta property="og:description" content="Match + labelled blocks &amp; breaks = fallthrough. It works, but it&apos;s not very pretty!" />
  
  <meta property="og:type" content="article" />
  
  
  
  <style>
    /*! modern-normalize v1.1.0 | MIT License | https://github.com/sindresorhus/modern-normalize */
*,::after,::before{box-sizing:border-box}html{line-height:1.15;-webkit-text-size-adjust:100%;-moz-tab-size:4;tab-size:4}body{margin:0;font-family:system-ui, -apple-system,'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji'}hr{height:0;color:inherit}abbr[title]{text-decoration:underline dotted}b,strong{font-weight:bolder}code,kbd,pre,samp{font-family:ui-monospace, SFMono-Regular, Consolas, 'Liberation Mono', Menlo, monospace;font-size:1em}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-0.25em}sup{top:-0.5em}table{text-indent:0;border-color:inherit}button,input,optgroup,select,textarea{font-family:inherit;font-size:100%;line-height:1.15;margin:0}button,select{text-transform:none}[type='button'],[type='reset'],[type='submit'],button{-webkit-appearance:button}::-moz-focus-inner{border-style:none;padding:0}:-moz-focusring{outline:1px dotted ButtonText}:-moz-ui-invalid{box-shadow:none}legend{padding:0}progress{vertical-align:baseline}::-webkit-inner-spin-button,::-webkit-outer-spin-button{height:auto}[type='search']{-webkit-appearance:textfield;outline-offset:-2px}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}summary{display:list-item}


    
      /* Borrowed from mojombo: https://github.com/mojombo/mojombo.github.com/blob/master/css/syntax.css */

.lineno { width: 2em; text-align:right; }
.highlight pre {
  white-space: pre;
}
.highlight .c { color: #777; font-style: italic; } /* Comment */
.highlight .err { color: #a61717; background-color: #e3d2d2 } /* Error */
.highlight .k { font-weight: bold } /* Keyword */
.highlight .o { font-weight: bold } /* Operator */
.highlight .cm { color: #999988; font-style: italic } /* Comment.Multiline */
.highlight .cp { color: #999999; font-weight: bold } /* Comment.Preproc */
.highlight .c1 { color: #999988; font-style: italic } /* Comment.Single */
.highlight .cs { color: #999999; font-weight: bold; font-style: italic } /* Comment.Special */
.highlight .gd { color: #000000; background-color: #ffdddd } /* Generic.Deleted */
.highlight .gd .x { color: #000000; background-color: #ffaaaa } /* Generic.Deleted.Specific */
.highlight .ge { font-style: italic } /* Generic.Emph */
.highlight .gr { color: #aa0000 } /* Generic.Error */
.highlight .gh { color: #999999 } /* Generic.Heading */
.highlight .gi { color: #000000; background-color: #ddffdd } /* Generic.Inserted */
.highlight .gi .x { color: #000000; background-color: #aaffaa } /* Generic.Inserted.Specific */
.highlight .go { color: #888888 } /* Generic.Output */
.highlight .gp { color: #555555 } /* Generic.Prompt */
.highlight .gs { font-weight: bold } /* Generic.Strong */
.highlight .gu { color: #aaaaaa } /* Generic.Subheading */
.highlight .gt { color: #aa0000 } /* Generic.Traceback */
.highlight .kc { font-weight: bold } /* Keyword.Constant */
.highlight .kd { font-weight: bold } /* Keyword.Declaration */
.highlight .kp { font-weight: bold } /* Keyword.Pseudo */
.highlight .kr { font-weight: bold } /* Keyword.Reserved */
.highlight .kt { color: #445588; font-weight: bold } /* Keyword.Type */
.highlight .m { color: #009999 } /* Literal.Number */
.highlight .s { color: #d14 } /* Literal.String */
.highlight .na { color: #008080 } /* Name.Attribute */
.highlight .nb { color: #0086B3 } /* Name.Builtin */
.highlight .nc { color: #445588; font-weight: bold } /* Name.Class */
.highlight .no { color: #008080 } /* Name.Constant */
.highlight .ni { color: #800080 } /* Name.Entity */
.highlight .ne { color: #990000; font-weight: bold } /* Name.Exception */
.highlight .nf { color: #990000; font-weight: bold } /* Name.Function */
.highlight .nn { color: #555555 } /* Name.Namespace */
.highlight .nt { color: #000080 } /* Name.Tag */
.highlight .nv { color: #008080 } /* Name.Variable */
.highlight .ow { font-weight: bold } /* Operator.Word */
.highlight .w { color: #bbbbbb } /* Text.Whitespace */
.highlight .mf { color: #009999 } /* Literal.Number.Float */
.highlight .mh { color: #009999 } /* Literal.Number.Hex */
.highlight .mi { color: #009999 } /* Literal.Number.Integer */
.highlight .mo { color: #009999 } /* Literal.Number.Oct */
.highlight .sb { color: #d14 } /* Literal.String.Backtick */
.highlight .sc { color: #d14 } /* Literal.String.Char */
.highlight .sd { color: #d14 } /* Literal.String.Doc */
.highlight .s2 { color: #d14 } /* Literal.String.Double */
.highlight .se { color: #d14 } /* Literal.String.Escape */
.highlight .sh { color: #d14 } /* Literal.String.Heredoc */
.highlight .si { color: #d14 } /* Literal.String.Interpol */
.highlight .sx { color: #d14 } /* Literal.String.Other */
.highlight .sr { color: #009926 } /* Literal.String.Regex */
.highlight .s1 { color: #d14 } /* Literal.String.Single */
.highlight .ss { color: #990073 } /* Literal.String.Symbol */
.highlight .bp { color: #999999 } /* Name.Builtin.Pseudo */
.highlight .vc { color: #008080 } /* Name.Variable.Class */
.highlight .vg { color: #008080 } /* Name.Variable.Global */
.highlight .vi { color: #008080 } /* Name.Variable.Instance */
.highlight .il { color: #009999 } /* Literal.Number.Integer.Long */


html {
    min-height:100%;
}

* {
  margin: 0;
}
* + * {
  margin-top: 0.75em;
}


body {
  padding:0px;
    counter-reset: footnotes;
    counter-reset: figure;
    margin:0px;
    font-size: 18px;
    background: white;
    color: #101010;

    font-variant: common-ligatures;
    -moz-font-feature-settings: "kern" on;
    -webkit-font-feature-settings: "kern" on;
    font-feature-settings: "kern" on;
}

#wrapper {
    margin: 0 auto;
    max-width: 630px;
    padding: 0.75em 15px;
    width: 100%;
    position:relative;
}

#no-ai {
    text-align: center;
    font-size: small;
}

.lazily-filled {
  position: relative;
}
.lazily-filled > * {
  z-index: 0;
}
.lazily-filled::before {
  position: absolute;
  top: 0;
  left: 0;
  content: "";
  width: 100%;
  height: 100%;
  display: block;
  background-color: rgb(229, 236, 246);
  z-index: 1;
}
.lazily-filled::after {
  position: absolute;
  top: 50%;
  left: 50%;
  content: "";
  display: block;
  width: 128px;
  height: 128px;
  margin-left: -64px;
  margin-top: -64px;
  border-radius: 50%;
  border: 12px solid;
  border-color: white transparent;
  animation: spinner 5s linear;
  /* eventually stop animating when it's hidden */
  animation-iteration-count: 10;
  z-index: 2;
}
.lazily-filled::before, .lazily-filled::after {
  opacity: 0;
  transition: all 0.5s ease;
  pointer-events: none;
}
.lazily-filled:empty::before, .lazily-filled:empty::after {
  opacity: 1;
  animation-iteration-count: infinite;
  visibility: visible;
}
@keyframes spinner {
  0% {
    transform: rotate(0deg);
  }
  100% {
    transform: rotate(360deg);
  }
}

.plotly-plot * + * {
  margin-top: 0;
}

/* wonky safari */
.plotly text[style*="white-space: pre"] {
  white-space: nowrap !important;
}


/* lists */
li + li {
  margin-top: 0.5em;
}
ul, ol {
  padding-left: 1.5em;
}

table {
  margin-left: auto;
  margin-right: auto;
  border-collapse: collapse;
  text-align: left;
}

/* ensure tables don't make the whole page scroll, NB. requires manual <div class="table-wrapper" markdown="1">...</div> due to https://github.com/gettalong/kramdown/issues/69 */
.table-wrapper {
  overflow-x: auto;
}

td, th {
  padding: 0.1em 0.75em;
}
@media (max-width: 500px) {
  td, th {
    padding-left: 0.375em;
    padding-right: 0.375em;
  }
}
tr:nth-child(even) {
  background: rgba(0, 0, 0, 5%);
}
thead {
  border-bottom: 1px solid grey;
  font-weight: bold;
}

header {
  margin-bottom: 1.5em;
}
header a:not(:hover) {
  text-decoration: none;
}
#blog-title {
  hyphens: none;
  font-variant: small-caps;
  font-size: 1.5em;
  font-weight: normal;
  text-align: center;
  line-height: 1em;
}
#info-list {
  list-style: none;
  padding: 0;
  display: flex;
  justify-content: center;
  flex-wrap: wrap;
  gap: 0.5em 2em;
}
#info-list li {
  margin: 0;
}

#page-footer {
  border-top: 1px solid lightgrey;
  padding-top: 0.75em;
  color: grey;
  text-align: right;
}

.clear { clear: both; margin: 0; }


main {
    line-height: 1.5em;

    position: relative;
    z-index: 10;
}

a[href] {
    color: inherit;
    text-decoration: underline;
}

/*  The authorship info */
#info-intro {
    font-style: italic;
    text-align: center;
}

/* code */

code, pre {
  font-family: monospace;
  font-variant: none;
  -moz-hyphens: none;
  -webkit-hyphens: none;
  -ms-hyphens: none;
  hyphens: none;
}

pre {
  background: #f0f0f0;
}
code {
    background: #f7f7f7;
    padding: 0 0.1em;
    font-size: 0.9em;
    border-radius: 3px;
    border: 1px solid lightgrey;
}
pre code {
    background: none;
    padding: 0;
    -moz-hyphens: none;
    -webkit-hyphens: none;
    -ms-hyphens: none;
    hyphens: none;
    border-radius: 0;
    border-width: 0;
}
h1 code, h2 code, h3 code, h4 code {
  background: rgba(255,255,255,0.1);
}

.break-all {
  word-break: break-all;
}

/* quotes and similar */

blockquote {
    border: solid #eee;
    border-width: 0 1px;
    padding: 0 1.2em;
    color: #444;
    position: relative;
    margin-left: 0;
    margin-right: 0;
}

aside {
  padding: 0 1.2em;
  color: #444;
  position: relative;
}
aside[data-icon] {
  padding-left: 2.4em;
}
aside[data-icon]:before {
  content: attr(data-icon);
  position: absolute;
  left: 0;
  text-align: center;
  width: 2.4em;
}

/* images/figures */
img, figure svg {
  max-width: 100%;
  height: auto;
}
figure svg {
  width: 100%;
}
img:not(.inline-image), figure svg {
    display: block;
    margin: 0 auto;
    clear: both;
}

.image-positioner {
  max-width: 800px;
  margin-left: auto;
  margin-right: auto;
}

img[data-caption]:before {
    content: attr(data-caption);
}
figure {
  clear: both;
}
figure.image {
  width: 100vw;
  position: relative;
  left: 50%;
  right: 50%;
  margin-left: -50vw;
  margin-right: -50vw;

  min-width: 100%;
}
figcaption {
  margin: 0 auto;
  max-width: 570px;
  padding: 0 10px;
  text-align: center;
  font-style: italic;
  font-size: 0.9em;
}
figcaption p {
  display: inline;
}
figcaption::before {
  counter-increment: figure;
  content: "Figure " counter(figure) ". ";
}

.highlight table {
  font-size: 0.9em;
  padding: 0em;
  width: 100%;
  table-layout: fixed;
  overflow-y: hidden;
  display: block;
  position: relative;
  z-index: 1;
}
[data-lang] {
  position: relative;
  display: block;
}
[data-lang]::before {
  content: attr(data-lang);
  text-transform: capitalize;
  top: 0;
  right: 0;
  position: absolute;
  font-size: 1.5em;
  color: #f3f3f3;
  z-index: 1;
}

.highlight pre {
  background: transparent;
}
.gutter {
  padding: 0;
  border: solid #ccc;
  border-width: 0 1px 0 0;
  color: #ccc;
}
.lineno {
  width: 25px;
  padding-right: 5px;
}
/* highlight/endhighlight code blocks */
figure.highlight td.code {
  overflow-x: auto;
  padding: 0;
  padding-left: 0.5em;
}
/* no-highlight/endhighlight code blocks (e.g. in footnotes) */
div.highlight {
  overflow-x: auto;
  padding: 0;
  padding-left: 0.5em;
}


/* HEADINGS */

h1, h2 {
    font-variant: small-caps;
}

h1, h2, h3, h4 {
  -moz-hyphens: none;
  -webkit-hyphens: none;
  -ms-hyphens: none;
  hyphens: none;
  text-align: left;
}

h1 {
  font-size: 2.2em;
  text-align: center;
  line-height: 1em;
}
h2 {
  font-size: 1.7em;
}
h3 {
  font-size: 1.4em;
}
h4 {
  font-size: 1.2em;
}

/* crates.io badges */

.lib-info {
  float: right;
  width: 150px;
  text-align: center;
  margin: 0 1em;
}
.lib-badge {
  vertical-align: middle;
}
.centered-libs {
  text-align: center;
}
.centered-libs .lib-info {
  float: none;
}

/* external links */

#external-links {
  margin-top: 2.25em;
  text-align: center;
}
.external-label {
  font-weight: bold;
}
#external-links ul {
  list-style: none;
  display: inline-block;
  padding: 0;
  margin: 0;
}
#external-links li {
  list-style: none;
  display: inline;
}

/* "Footnotes" */

/* the div that holds them */
.footnotes {
    margin-top: 2.25em;
    padding-top: 1.5em;
    border-top: 1px solid rgb(240,240,240);
    font-size: 0.9em;
}
.footnotes ol {
  padding: 0;
}
.footnotes li {
    list-style-position: outside;
    margin-left: 30px;
    margin-right: 10px;
    color: #333;
}

.footnotes li:target, .footnotes li:hover {
    color: black;
    background-color: lightyellow;
}

.footnotes .reversefootnote {
    text-decoration: none;
}

/* extra info after a post */
#more {
  margin-top: 3em;
  padding-top: 1.5em;
  border-top: 1px solid lightgray;
}
#me-icon {
  max-width: 150px;
  height: 150px;
  background: url("/img/me.jpg");
  background-size: cover;
  margin-left: auto;
  margin-right: auto;
  border-radius: 30px;
}
#by-line {
  font-size: 0.8em;
}
#latest-list {
  padding: 0;
  list-style: none;
}
#latest-heading {
  text-align: center;
}
#latest-heading a:not(:hover) {
  text-decoration: none;
}
#latest-list a:hover h3 {
  text-decoration: underline;
}
#latest-list a {
  text-decoration: none;
}
.latest-post {
  padding: 0;
  font-size: 0.8em;
}
.latest-post > h3 {
  font-weight: bold;
}
.latest-post * {
  margin: 0;
}

/* post series */

.post-series {
  font-size: 0.8em;
  border: 1px solid lightgray;
  padding: 0.2em;
  cursor: pointer;
}

.post-series-title {
  font-weight: bold;
  font-size: 1.1em;
}
.post-series-list {
  padding-left: 1.5em;
  margin: 0;
}
.post-series .current {
  font-style: italic;
}

/* archive pages */
ul.post-list {
  list-style: none;
  padding: 0;
}

.post-post + .post-post {
  margin-top: 2em;
}

.post-title {
  font-size: 1.2em;
}

.post-excerpt p {
  display: inline;
}

.post-date {
  font-style: italic;
  white-space: nowrap;
  float: right;
  margin: 0;
  margin-left: 3em;
  font-size: smaller;
}

.post-list .footnote, .post-list .footnotes, .post-list p:empty {
  display: none
}

.post-list-empty {
    text-align: center;
}

/* media queries */


@media only print {
    a {
      text-decoration: none !important;
    }
    header {
        display:none !important;
    }

    h1, h2, h3, h4 {
        padding-left: 0 !important;
    }

    #wrapper {
       max-width: none !important;
    }

    .no-print {
        display: none !important;
    }

    .footnotes .reversefootnote {
         display: none !important;
    }
    [data-lang]::before {
      content: "";
    }
}

    

    
  </style>
  
</head>

<body>
<div id="wrapper">
  <header>
    <h1 id="blog-title"><a href="/">Huon on the internet</a></h1>
    <nav>
      <ul id="info-list" class="no-print">
        <li><a href="/about">About</a></li>
        <li><a href="/blog">Blog</a></li>
        <li><a href="https://github.com/huonw">GitHub</a></li>
        <li><a href="https://bsky.app/profile/huonw.bsky.social">Bluesky</a></li>
      </ul>
    </nav>
  </header>
  <main>
    <article>
      
        <h1 id="title"> Take a break: Rust match has fallthrough</h1>
        
      
      
         <div id="info-intro">
           By <a href="/about">Huon Wilson</a>
           
             &mdash; <span class="date pub-date">05 Mar 2025</span>
           
           
         </div>
      
      <p>Rust’s <code class="language-plaintext highlighter-rouge">match</code> statement can do a lot of things, even C-style fallthough to the next branch, despite having no real support for it. It turns out to be a “shallow” feature, where the C to Rust translation is easily done, without needing to understand the code itself. The hardest part is coming to terms with writing it, and then convincing someone else to let you land it!</p>

<p>Here’s what the tail handling of the MurmurHash3 hash function could look like, in Rust, if you have enough courage<sup id="fnref:better"><a href="#fn:better" class="footnote" rel="footnote" role="doc-noteref">0</a></sup>:</p>

<figure class="highlight"><pre><code class="language-rust" data-lang="rust"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre></td><td class="code"><pre><span class="nv">'outer</span><span class="p">:</span> <span class="p">{</span>
  <span class="nv">'case1</span><span class="p">:</span> <span class="p">{</span>
    <span class="nv">'case2</span><span class="p">:</span> <span class="p">{</span>
      <span class="nv">'case3</span><span class="p">:</span> <span class="p">{</span>
        <span class="k">match</span> <span class="n">len</span> <span class="o">&amp;</span> <span class="mi">3</span> <span class="p">{</span>
          <span class="mi">3</span> <span class="k">=&gt;</span> <span class="k">break</span> <span class="nv">'case3</span><span class="p">,</span>
          <span class="mi">2</span> <span class="k">=&gt;</span> <span class="k">break</span> <span class="nv">'case2</span><span class="p">,</span>
          <span class="mi">1</span> <span class="k">=&gt;</span> <span class="k">break</span> <span class="nv">'case1</span><span class="p">,</span>
          <span class="n">_</span> <span class="k">=&gt;</span> <span class="k">break</span> <span class="nv">'outer</span><span class="p">,</span>
        <span class="p">}</span>
      <span class="p">}</span> <span class="c1">// 'case3:</span>
      <span class="n">k1</span> <span class="o">^=</span> <span class="p">(</span><span class="n">tail</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">as</span> <span class="nb">u32</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
    <span class="p">}</span> <span class="c1">// 'case2:</span>
    <span class="n">k1</span> <span class="o">^=</span> <span class="p">(</span><span class="n">tail</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">as</span> <span class="nb">u32</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
  <span class="p">}</span> <span class="c1">// case1:</span>
  <span class="n">k1</span> <span class="o">^=</span> <span class="n">tail</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">as</span> <span class="nb">u32</span><span class="p">;</span>
  <span class="n">k1</span> <span class="o">*=</span> <span class="n">c1</span><span class="p">;</span> <span class="n">k1</span> <span class="o">=</span> <span class="n">k1</span><span class="nf">.rotate_left</span><span class="p">(</span><span class="mi">15</span><span class="p">);</span> <span class="n">k1</span> <span class="o">*=</span> <span class="n">c2</span><span class="p">;</span> <span class="n">h1</span> <span class="o">^=</span> <span class="n">k1</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>This very occasionally matters and it’s not too hard to inflict it upon yourself, if required. Hopefully it isn’t required, because there’s no way to make it pretty.</p>

<aside data-icon="ℹ️">

This post is essentially a prose version of the 10-year-old <a href="https://github.com/pythonesque/fallthrough">pythonesque/fallthrough</a> macro. <a href="https://github.com/Jules-Bertholet/fallthrough">Jules-Bertholet/fallthrough</a> looks to be a more recent version of the same idea. I'm not associated with either, nor have I ever used them.

</aside>

<h2 id="breaking-the-ice">Breaking the ice</h2>

<p>In the  MurmurHash3 hash functions, there’s two interesting <a href="https://github.com/aappleby/smhasher/blob/0ff96f7835817a27d0487325b6c16033e2992eb5/src/MurmurHash3.cpp#L205-L229">snippets</a> of <a href="https://github.com/aappleby/smhasher/blob/0ff96f7835817a27d0487325b6c16033e2992eb5/src/MurmurHash3.cpp#L130-L136">code</a>. One is for computing 128-bit results and the other for 32-bit results. They have the same vibes, but the 32-bit one is smaller and serves as a better example. It uses various <code class="language-plaintext highlighter-rouge">uint32_t</code> variables (<code class="language-plaintext highlighter-rouge">c1</code>, <code class="language-plaintext highlighter-rouge">c2</code>, <code class="language-plaintext highlighter-rouge">k1</code>, <code class="language-plaintext highlighter-rouge">h1</code>), an <code class="language-plaintext highlighter-rouge">int</code> variable <code class="language-plaintext highlighter-rouge">len</code>, and a <code class="language-plaintext highlighter-rouge">uint8_t *</code> pointer <code class="language-plaintext highlighter-rouge">tail</code>:</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="code"><pre><span class="k">switch</span><span class="p">(</span><span class="n">len</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span>
<span class="p">{</span>
<span class="k">case</span> <span class="mi">3</span><span class="p">:</span> <span class="n">k1</span> <span class="o">^=</span> <span class="n">tail</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
<span class="k">case</span> <span class="mi">2</span><span class="p">:</span> <span class="n">k1</span> <span class="o">^=</span> <span class="n">tail</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
<span class="k">case</span> <span class="mi">1</span><span class="p">:</span> <span class="n">k1</span> <span class="o">^=</span> <span class="n">tail</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
        <span class="n">k1</span> <span class="o">*=</span> <span class="n">c1</span><span class="p">;</span> <span class="n">k1</span> <span class="o">=</span> <span class="n">ROTL32</span><span class="p">(</span><span class="n">k1</span><span class="p">,</span><span class="mi">15</span><span class="p">);</span> <span class="n">k1</span> <span class="o">*=</span> <span class="n">c2</span><span class="p">;</span> <span class="n">h1</span> <span class="o">^=</span> <span class="n">k1</span><span class="p">;</span>
<span class="p">};</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>It’s relying on the implicit fallthrough behaviour of C’s <code class="language-plaintext highlighter-rouge">switch</code> statement: if the CPU proceeds through a <code class="language-plaintext highlighter-rouge">case</code> arm without hitting a <code class="language-plaintext highlighter-rouge">break</code>, it happily continues executing the next arm. That’s a compact, <a href="https://en.wikipedia.org/wiki/Don't_repeat_yourself">“DRY”</a> and efficient way to write this equivalent code:</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre></td><td class="code"><pre><span class="k">if</span> <span class="p">((</span><span class="n">len</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// case 3:</span>
  <span class="n">k1</span> <span class="o">^=</span> <span class="n">tail</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
  <span class="c1">// case 2:</span>
  <span class="n">k1</span> <span class="o">^=</span> <span class="n">tail</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
  <span class="c1">// case 1:</span>
  <span class="n">k1</span> <span class="o">^=</span> <span class="n">tail</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
  <span class="n">k1</span> <span class="o">*=</span> <span class="n">c1</span><span class="p">;</span> <span class="n">k1</span> <span class="o">=</span> <span class="n">ROTL32</span><span class="p">(</span><span class="n">k1</span><span class="p">,</span><span class="mi">15</span><span class="p">);</span> <span class="n">k1</span> <span class="o">*=</span> <span class="n">c2</span><span class="p">;</span> <span class="n">h1</span> <span class="o">^=</span> <span class="n">k1</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">else</span> <span class="nf">if</span> <span class="p">((</span><span class="n">len</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// case 2:</span>
  <span class="n">k1</span> <span class="o">^=</span> <span class="n">tail</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
  <span class="c1">// case 1:</span>
  <span class="n">k1</span> <span class="o">^=</span> <span class="n">tail</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
  <span class="n">k1</span> <span class="o">*=</span> <span class="n">c1</span><span class="p">;</span> <span class="n">k1</span> <span class="o">=</span> <span class="n">ROTL32</span><span class="p">(</span><span class="n">k1</span><span class="p">,</span><span class="mi">15</span><span class="p">);</span> <span class="n">k1</span> <span class="o">*=</span> <span class="n">c2</span><span class="p">;</span> <span class="n">h1</span> <span class="o">^=</span> <span class="n">k1</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">else</span> <span class="nf">if</span> <span class="p">((</span><span class="n">len</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// case 1:</span>
  <span class="n">k1</span> <span class="o">^=</span> <span class="n">tail</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
  <span class="n">k1</span> <span class="o">*=</span> <span class="n">c1</span><span class="p">;</span> <span class="n">k1</span> <span class="o">=</span> <span class="n">ROTL32</span><span class="p">(</span><span class="n">k1</span><span class="p">,</span><span class="mi">15</span><span class="p">);</span> <span class="n">k1</span> <span class="o">*=</span> <span class="n">c2</span><span class="p">;</span> <span class="n">h1</span> <span class="o">^=</span> <span class="n">k1</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>Expressing the original <code class="language-plaintext highlighter-rouge">switch</code> in Rust is… a bit awkward. A nice(?) version might be spelling out individual <code class="language-plaintext highlighter-rouge">if</code> statements, carefully using <code class="language-plaintext highlighter-rouge">&gt;=</code> and avoiding <code class="language-plaintext highlighter-rouge">else if</code> to get the right fallthrough behaviour:</p>

<figure class="highlight"><pre><code class="language-rust" data-lang="rust"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="code"><pre><span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">3</span> <span class="p">{</span>
  <span class="n">k1</span> <span class="o">^=</span> <span class="p">(</span><span class="n">tail</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">as</span> <span class="nb">u32</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="p">{</span>
  <span class="n">k1</span> <span class="o">^=</span> <span class="p">(</span><span class="n">tail</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">as</span> <span class="nb">u32</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="p">{</span>
  <span class="n">k1</span> <span class="o">^=</span> <span class="n">tail</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">as</span> <span class="nb">u32</span><span class="p">;</span>
  <span class="n">k1</span> <span class="o">*=</span> <span class="n">c1</span><span class="p">;</span> <span class="n">k1</span> <span class="o">=</span> <span class="n">k1</span><span class="nf">.rotate_left</span><span class="p">(</span><span class="mi">15</span><span class="p">);</span> <span class="n">k1</span> <span class="o">*=</span> <span class="n">c2</span><span class="p">;</span> <span class="n">h1</span> <span class="o">^=</span> <span class="n">k1</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>But, it doesn’t so nicely scale to larger <code class="language-plaintext highlighter-rouge">switch</code>es like the 128-bit version of this example code: that one has 15 arms, instead of 3! And, especially for those larger versions, a <code class="language-plaintext highlighter-rouge">switch</code>/<code class="language-plaintext highlighter-rouge">match</code> statement seems to <strong>help the optimiser</strong> apply tricks like jump tables or computed-<code class="language-plaintext highlighter-rouge">goto</code> , whereas individual <code class="language-plaintext highlighter-rouge">if</code>s seem to end up with <strong>long sequential chains</strong> of compare-then-jump instead (<a href="https://godbolt.org/#z:OYLghAFBqd5QCxAYwPYBMCmBRdBLAF1QCcAaPECAMzwBtMA7AQwFtMQByARg9KtQYEAysib0QXACx8BBAKoBnTAAUAHpwAMvAFYTStJg1DIApACYAQuYukl9ZATwDKjdAGFUtAK4sGEgOykrgAyeAyYAHI%2BAEaYxBIAbKQADqgKhE4MHt6%2BASlpGQKh4VEssfFcSXaYDplCBEzEBNk%2BflyB1bUC9Y0ExZExcYm2DU0tue0jvf2l5YkAlLaoXsTI7BzmAMxhyN5YJptuCgT4ggB0CAfYJhoAgje3YbRhmADUXmEEm2YA%2BgSvxFQBFo31eEHen2%2Bf1eqlIr0%2BAA5ocRXvMHiZ/FY7q8AZgCCsGGDVK8Dm5SQD5iT/G4iSTNtd6WDQQBaClozZY%2B7%2BAAi6LMmywNHCNwAnAAlADyABVgt8ILCAJ5ojQiwHAuWK5X3O4fQRQ/4KADuhGQCB%2BEAeOJxuq%2Bv3%2B9AYcMtVpt%2BteAGsuKRndbIXaPWZvdiXX7oe7NkHblaIXr/e7pD6Y7boQgvYnXf6EIH06H/ggIznYymE8HfUX/sg06Wk27kNnqxnocgCw3c69kCWoyHBEj/gAqBp0SkYzk4o0mhAQB0kswJV5cACsWpxI%2BdoiU84XIA9khJC4Z3Neg9oJgXFikp8PpPJlQOo/bTA3Um38b3B6PTDop/Pm0vdLJhyvAid5ro%2BbxcJsL67qe77Ht%2BXBmH%2B16ARoIHVtGVqvn2ByHh2d47iumyHpKMpyvGpBcAi7IWAR2FEe2XD4Qg0H7jhO5odqXbruBZgvpsb5sXBZ5cIxC5Xoc5JmJIHE4tx85cHxAn0UJ56oWJ/43gkMkPk%2BGiKTBgmfieZ6vCKSESYBwEcqBG6mfprHKUZ35AeZAE0qh1noRhHr8XRuG/hyPmEcR0qymYEDhhR/jUUFfnttJgX5kph7hhxNlvEBL5mMlH5fiZ/iuZJCX3nJrz%2BFlOUqa8WnqchNK3p5XFgTiCQVQZjl5TRC6FZZ2mlVuAaVU5JnSbVFnudp3mYdlcV1vh7rZXSIWkeFC0UQkMULa8s0BTRWY5QtaXBqVkgvlwQ2da8v5jW5rxSX1zVXWdF3GTRiE3ZpD22bxHrne1h5VaJ4m3VZJWPQpv0vc5anA%2BSHn3lNOKettbGVvN51La8JFhRFXqLpt52zYhiV/Q5KWMY1K48kdXYAPS068jAKCsbxiLQrwAG6NHgTDRPQCivI0bxeEo6DOsQeIEq8qYznt2XWNL/EK8xaXU3c6I6m2eBUAoFqtuWrwOk6%2BvJv8nqRtGjZm/WXZlqbPkW929vkYW9upo7dtulmHs1pmLa277xY%2B1bDHB22dZhwbzaR/bHYx7223HsOmLOtrYJTowM5zvjdLvjnI4ktWr7/blr0Xh9gENfeGJXsGadQNO5jZ0uudsVIycI0jLGwcNP49TSoPOjXhddvXGeEk3m7DvSbebB3ibF2Tpfwe9sMoZNtGo8VBGY9jZHSJRm27rNFN7d3bHxtpw%2Bp1Q6eN7OU%2Bt/RCHz0XStLypIn93dxVDzyI84jHvfZu0885cFfgHcMUNhIww0pXLSlMqS11HrfBumdJ75xns/DQEDoxQJLlVMyFcB5X3/jfO%2B6CH6YPfCKXBmF3490usBYhrx4YL18qjXaQVd6hTIhGdom0OH0TwolBhF9dp/2QYA1B48s6PyuGxKiVIaIL3lh/XuZVv73UQdfOuMjgHyKwYeaKyiAHTWgTRGqa96oIOrmQvRFCJ5UJbgo%2BiG1TGqIsa8bqLDB7Bl0SgxxcjqFsRcZiMxSM1GMNeq8Ua1jWEby2kTeai02J71WoGSom0ZqcKYlEi%2BxM7FSPhPoyhICn6HkkHQpGpNonOWuvE7RRSzFALKYY98c9lEL1qYZS6q84E2NIcU1pTjymuMPGYapkMCEaKBgMlyOj7GBLQaM9pbcpnIxmZdWBdUEmIJqSjYRp9IY8JWrjCiS50aHNwoU6WPT6KeiGTTHE9NGYMGZhLQWtB2Zc2IDzPmmABZC3eKLcWktiCEhlsreWlhFay2lr/dWPIOCLFoJwBcvA/AcC0KQVAnAySWAVgoZYqw3hbB4KQAgmgUWLHdCABcGh9CcEkJi6luLOC8AUCARlVLsUotIHAWASA0AsGSHQOI5BKAirFfQeIuxDDAC4CKLgjKaC0AIHELlEBohsuiGERoCpOAUr1cwYgCoJTRG0DUXlFKRVsEEBKBgtBDV8tIFgaIXhgBuDZly7gvAsAsAVeIV1%2BAJa1A5oCtlmBVA1C8Bqo1vBPiYDRa6540RiAGo8FgNlBA/ksATaQCNxBohpEwNyTAgajDPCMNSxYVADDAAUAANTwJgQ0EpkiMALfwQQIgxDsCkDIQQigVDqFdboL0Bga2mEJZYfQeBohcsgIsVAyRHACF9cyCUmxeCoCLX8rAS6ICLE6OuvwEBXDjDaEEBg6AZiDAqPkdIZ6r16FSM%2BzI96yhDC9KeuooxmieFaHoP93QANfrmL%2BgDr6oPTBeLMH9J6SVrAkKi9FrLXV4o4DCBECRmQJF3PKow84RRnC4GcDQYJcCEBIDOTY4DeC8q0PMWl9LGUppZaQLFOKsOcu5ZS2taGOBmAwzxjlAm%2BUscLZqzIIBJBAA%3D">compiler explorer</a>).</p>

<p>Worst of all, that’s boring!</p>

<p>Instead, it’s possible to <strong>translate</strong> the original C code directly, <strong>fallthrough and all</strong>. All you need is more <code class="language-plaintext highlighter-rouge">break</code>, like we saw before:</p>

<figure class="highlight"><pre><code class="language-rust" data-lang="rust"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre></td><td class="code"><pre><span class="nv">'outer</span><span class="p">:</span> <span class="p">{</span>
  <span class="nv">'case1</span><span class="p">:</span> <span class="p">{</span>
    <span class="nv">'case2</span><span class="p">:</span> <span class="p">{</span>
      <span class="nv">'case3</span><span class="p">:</span> <span class="p">{</span>
        <span class="k">match</span> <span class="n">len</span> <span class="o">&amp;</span> <span class="mi">3</span> <span class="p">{</span>
          <span class="mi">3</span> <span class="k">=&gt;</span> <span class="k">break</span> <span class="nv">'case3</span><span class="p">,</span>
          <span class="mi">2</span> <span class="k">=&gt;</span> <span class="k">break</span> <span class="nv">'case2</span><span class="p">,</span>
          <span class="mi">1</span> <span class="k">=&gt;</span> <span class="k">break</span> <span class="nv">'case1</span><span class="p">,</span>
          <span class="n">_</span> <span class="k">=&gt;</span> <span class="k">break</span> <span class="nv">'outer</span><span class="p">,</span>
        <span class="p">}</span>
      <span class="p">}</span> <span class="c1">// 'case3:</span>
      <span class="n">k1</span> <span class="o">^=</span> <span class="p">(</span><span class="n">tail</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">as</span> <span class="nb">u32</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
    <span class="p">}</span> <span class="c1">// 'case2:</span>
    <span class="n">k1</span> <span class="o">^=</span> <span class="p">(</span><span class="n">tail</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">as</span> <span class="nb">u32</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
  <span class="p">}</span> <span class="c1">// case1:</span>
  <span class="n">k1</span> <span class="o">^=</span> <span class="n">tail</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">as</span> <span class="nb">u32</span><span class="p">;</span>
  <span class="n">k1</span> <span class="o">*=</span> <span class="n">c1</span><span class="p">;</span> <span class="n">k1</span> <span class="o">=</span> <span class="n">k1</span><span class="nf">.rotate_left</span><span class="p">(</span><span class="mi">15</span><span class="p">);</span> <span class="n">k1</span> <span class="o">*=</span> <span class="n">c2</span><span class="p">;</span> <span class="n">h1</span> <span class="o">^=</span> <span class="n">k1</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>Perfect! But.. you might need to bribe someone to get it past code review.</p>

<h2 id="break-it-down-for-me">Break it down for me</h2>

<p>What’s going on here?</p>

<p>This is relying on Rust’s <a href="https://rust-lang.github.io/rfcs/2046-label-break-value.html"><strong>labelled blocks &amp; breaks</strong></a> acting as a “<strong>forward <code class="language-plaintext highlighter-rouge">goto</code></strong>”. When we write <code class="language-plaintext highlighter-rouge">'a: { ... break 'a; ... }</code> that <code class="language-plaintext highlighter-rouge">break 'a</code> is jumping to the end of the block labelled <code class="language-plaintext highlighter-rouge">'a</code>. We can use that to jump into the middle of a sequence of instructions.</p>

<p>Here’s a strangely-indented version of that same Rust code, which only has whitespace changes from the more conventional formatting just above:</p>

<figure class="highlight"><pre><code class="language-rust" data-lang="rust"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td><td class="code"><pre><span class="nv">'outer</span><span class="p">:</span> <span class="p">{</span> <span class="nv">'case1</span><span class="p">:</span> <span class="p">{</span><span class="nv">'case2</span><span class="p">:</span> <span class="p">{</span> <span class="nv">'case3</span><span class="p">:</span> <span class="p">{</span>

<span class="k">match</span> <span class="n">len</span> <span class="o">&amp;</span> <span class="mi">3</span> <span class="p">{</span>
  <span class="mi">3</span> <span class="k">=&gt;</span> <span class="k">break</span> <span class="nv">'case3</span><span class="p">,</span>
  <span class="mi">2</span> <span class="k">=&gt;</span> <span class="k">break</span> <span class="nv">'case2</span><span class="p">,</span>
  <span class="mi">1</span> <span class="k">=&gt;</span> <span class="k">break</span> <span class="nv">'case1</span><span class="p">,</span>
  <span class="n">_</span> <span class="k">=&gt;</span> <span class="k">break</span> <span class="nv">'outer</span><span class="p">,</span>
<span class="p">}</span>

<span class="p">}</span> <span class="c1">// 'case3:</span>
<span class="n">k1</span> <span class="o">^=</span> <span class="p">(</span><span class="n">tail</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">as</span> <span class="nb">u32</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>

<span class="p">}</span> <span class="c1">// 'case2:</span>
<span class="n">k1</span> <span class="o">^=</span> <span class="p">(</span><span class="n">tail</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">as</span> <span class="nb">u32</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>

<span class="p">}</span> <span class="c1">// 'case1:</span>
<span class="n">k1</span> <span class="o">^=</span> <span class="n">tail</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">as</span> <span class="nb">u32</span><span class="p">;</span>
<span class="n">k1</span> <span class="o">*=</span> <span class="n">c1</span><span class="p">;</span> <span class="n">k1</span> <span class="o">=</span> <span class="n">k1</span><span class="nf">.rotate_left</span><span class="p">(</span><span class="mi">15</span><span class="p">);</span> <span class="n">k1</span> <span class="o">*=</span> <span class="n">c2</span><span class="p">;</span> <span class="n">h1</span> <span class="o">^=</span> <span class="n">k1</span><span class="p">;</span>

<span class="p">}</span> <span class="c1">// 'outer:</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>We can pretend the core functionality—all the updates to <code class="language-plaintext highlighter-rouge">k1</code>—is “straight-line” code, and then the <code class="language-plaintext highlighter-rouge">match</code> entrypoint is just <strong>choosing where to start executing</strong> within that code. (Maybe that presentation above is clearer to you, or the more conventional one is: the behaviour is the same.)</p>

<p>For instance, if <code class="language-plaintext highlighter-rouge">len &amp; 3</code> is 2, then the <code class="language-plaintext highlighter-rouge">match</code> runs <code class="language-plaintext highlighter-rouge">break 'case2</code>, and jumps to the end of the <code class="language-plaintext highlighter-rouge">'case2</code> block. That’s exactly the <code class="language-plaintext highlighter-rouge">} // 'case2:</code> line, skipping over <code class="language-plaintext highlighter-rouge">k1 ^= (tail[2] as u32) &lt;&lt; 16;</code>, as desired. Thus, <code class="language-plaintext highlighter-rouge">k1 ^= (tail[1] as u32) &lt;&lt; 8;</code> will run.</p>

<p>Once that update has run, execution continues through the <code class="language-plaintext highlighter-rouge">} // 'case1</code> (that is, leaving the block labelled <code class="language-plaintext highlighter-rouge">'case1</code>), on to executing <code class="language-plaintext highlighter-rouge">k1 ^= tail[0] as u32;</code>: <strong>fallthrough</strong>! Also exactly what’s desired!</p>

<p>This is just a unwrapping of the original C code, with an extra “jump” in it (that the optimiser simplifies away).</p>

<h2 id="i-want-to-break-things-too">I want to break things too</h2>

<p>The transformation from C <code class="language-plaintext highlighter-rouge">switch</code> to Rust <code class="language-plaintext highlighter-rouge">match</code> is <strong>mechanical</strong> and easy to execute:</p>

<ol>
  <li>Configure the blocks</li>
  <li>Arrange the <code class="language-plaintext highlighter-rouge">match</code></li>
  <li>Insert the code</li>
</ol>

<p>Here’s a C example that demonstrates more <code class="language-plaintext highlighter-rouge">switch</code> features:</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="code"><pre><span class="k">switch</span> <span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="p">{</span>
<span class="k">case</span> <span class="mi">12</span><span class="p">:</span>
  <span class="n">f1</span><span class="p">();</span>
  <span class="c1">// fallthrough</span>
<span class="k">case</span> <span class="mi">56</span><span class="p">:</span>
  <span class="n">f2</span><span class="p">();</span>
  <span class="c1">// no fallthrough</span>
  <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mi">34</span><span class="p">:</span>
  <span class="n">f3</span><span class="p">();</span>
  <span class="c1">// conditional fallthrough</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">f4</span><span class="p">())</span> <span class="k">break</span><span class="p">;</span>
<span class="nl">default:</span>
  <span class="n">f5</span><span class="p">();</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>First, start with a <code class="language-plaintext highlighter-rouge">'outer: { ... }</code> block. For each <code class="language-plaintext highlighter-rouge">case</code> or <code class="language-plaintext highlighter-rouge">default</code> statement, create a <code class="language-plaintext highlighter-rouge">'...: { ... }</code> block nested within <code class="language-plaintext highlighter-rouge">'outer</code> and within each other. Put the <strong>last</strong> <code class="language-plaintext highlighter-rouge">case</code>/<code class="language-plaintext highlighter-rouge">default</code> <strong>outermost</strong>, and the <strong>first</strong> one (immediately after <code class="language-plaintext highlighter-rouge">switch</code>) <strong>innermost</strong>, with the rest in order between the two.</p>

<figure class="highlight"><pre><code class="language-rust" data-lang="rust"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="code"><pre><span class="nv">'outer</span><span class="p">:</span> <span class="p">{</span>
  <span class="nv">'default</span><span class="p">:</span> <span class="p">{</span>
    <span class="nv">'case34</span><span class="p">:</span> <span class="p">{</span>
      <span class="nv">'case56</span><span class="p">:</span> <span class="p">{</span>
        <span class="nv">'case12</span><span class="p">:</span> <span class="p">{</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>Next, within all of the blocks, create a <code class="language-plaintext highlighter-rouge">match</code> with an arm for each <code class="language-plaintext highlighter-rouge">case</code>/<code class="language-plaintext highlighter-rouge">default</code>, and contents <code class="language-plaintext highlighter-rouge">break '...</code>:</p>

<figure class="highlight"><pre><code class="language-rust" data-lang="rust"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="code"><pre><span class="nv">'outer</span><span class="p">:</span> <span class="p">{</span>
  <span class="nv">'default</span><span class="p">:</span> <span class="p">{</span>
    <span class="nv">'case34</span><span class="p">:</span> <span class="p">{</span>
      <span class="nv">'case56</span><span class="p">:</span> <span class="p">{</span>
        <span class="nv">'case12</span><span class="p">:</span> <span class="p">{</span>
          <span class="k">match</span> <span class="n">x</span> <span class="p">{</span>
            <span class="mi">12</span> <span class="k">=&gt;</span> <span class="k">break</span> <span class="nv">'case12</span><span class="p">,</span>
            <span class="mi">56</span> <span class="k">=&gt;</span> <span class="k">break</span> <span class="nv">'case56</span><span class="p">,</span>
            <span class="mi">34</span> <span class="k">=&gt;</span> <span class="k">break</span> <span class="nv">'case34</span><span class="p">,</span>
            <span class="n">_</span> <span class="k">=&gt;</span> <span class="k">break</span> <span class="nv">'default</span><span class="p">,</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>Finally, put the code for each arm <strong>immediately after</strong> the matching labelled block (this is slightly unintuitive: code for case “X” should <strong>not</strong> be nested within the <code class="language-plaintext highlighter-rouge">'caseX</code> block). Replace any <code class="language-plaintext highlighter-rouge">break</code> statements in C with <code class="language-plaintext highlighter-rouge">break 'outer</code> in Rust.</p>

<figure class="highlight"><pre><code class="language-rust" data-lang="rust"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre></td><td class="code"><pre><span class="nv">'outer</span><span class="p">:</span> <span class="p">{</span>
  <span class="nv">'default</span><span class="p">:</span> <span class="p">{</span>
    <span class="nv">'case34</span><span class="p">:</span> <span class="p">{</span>
      <span class="nv">'case56</span><span class="p">:</span> <span class="p">{</span>
        <span class="nv">'case12</span><span class="p">:</span> <span class="p">{</span>
          <span class="k">match</span> <span class="n">x</span> <span class="p">{</span>
            <span class="mi">12</span> <span class="k">=&gt;</span> <span class="k">break</span> <span class="nv">'case12</span><span class="p">,</span>
            <span class="mi">56</span> <span class="k">=&gt;</span> <span class="k">break</span> <span class="nv">'case56</span><span class="p">,</span>
            <span class="mi">34</span> <span class="k">=&gt;</span> <span class="k">break</span> <span class="nv">'case34</span><span class="p">,</span>
            <span class="n">_</span> <span class="k">=&gt;</span> <span class="k">break</span> <span class="nv">'default</span><span class="p">,</span>
          <span class="p">}</span>
        <span class="p">}</span>
        <span class="nf">f1</span><span class="p">();</span>
        <span class="c1">// fallthrough</span>
      <span class="p">}</span>
      <span class="nf">f2</span><span class="p">();</span>
      <span class="c1">// no fallthrough</span>
      <span class="k">break</span> <span class="nv">'outer</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nf">f3</span><span class="p">();</span>
    <span class="c1">// conditional fallthrough</span>
    <span class="k">if</span> <span class="nf">f4</span><span class="p">()</span> <span class="p">{</span> <span class="k">break</span> <span class="nv">'outer</span><span class="p">;</span> <span class="p">}</span>
  <span class="p">}</span>
  <span class="nf">f5</span><span class="p">()</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>That’s the whole process.</p>

<h2 id="why-break-rust-like-this">Why break Rust like this?</h2>

<p>There’s a few places where C’s <code class="language-plaintext highlighter-rouge">switch</code> fallthrough behaviour is particularly useful, often numeric-related “tight” code, like: hash functions like MurmurHash3 above, and <a href="https://github.com/kimwalisch/primesieve/blob/fa952ab19642b00687513d26e668d238180cb67c/src/EratSmall.cpp#L102-L127">prime sieves</a>. Using fallthrough leads to simpler code that’s well optimised by the compiler.</p>

<p>The same logic applies to Rust: in the rare case it’s helpful, it can be very helpful… except it’s so awkward to express in Rust, that there’s no defining this as “simpler”. This only makes sense if <strong>benchmarks prove it</strong> .</p>

<p>(This is a quick article so I haven’t done the legwork to construct an example microbenchmark that demonstrates the performance impact of appropriate use of fallthrough: walking through that would be an article itself. Now you know about this idiosyncratic technique you can experiment… and maybe even write that article yourself!)</p>

<p>This labelled-break techinque is also a special case of a more general possibility: labelled breaks can be used to implement <strong>any directed acyclic graph</strong> of C <code class="language-plaintext highlighter-rouge">goto</code>s. The <code class="language-plaintext highlighter-rouge">switch</code> fallthrough is a simple linked-list graph (each case/state goes to one other case), but the technique can be used for more complicated graphs too:</p>

<ol>
  <li>create a nested labelled block for each state, in <strong>reverse topological order</strong>, then</li>
  <li>use <code class="language-plaintext highlighter-rouge">break '...</code> to jump to the appropriate less-deeply-nested block when transitioning states.</li>
</ol>

<p>This “feature” should be used… carefully. It’s clearly hard to understand, and would be hard to maintain by hand, especially as the number of cases grow larger. However, it may be a good trick to use within a macro or other code-generation.</p>

<h2 id="short-breakdown">Short breakdown</h2>

<p>One can (ab)use labelled breaks in Rust to support fallthrough-like behaviour in <code class="language-plaintext highlighter-rouge">match</code>. Not at all pretty, not at all advisable, but it works, and sometimes that’s as much as we can hope for.</p>

<p>The <a href="https://github.com/pythonesque/fallthrough">pythonesque/fallthrough</a> and <a href="https://github.com/Jules-Bertholet/fallthrough">Jules-Bertholet/fallthrough</a> macros appear to automate the transformation and seem to make it prettier… although I haven’t used them.</p>

<section id="external-links" class="no-print">
  
  <div id="external-page">
    <span class="external-label">Share this on</span>
    <ul class="external-list">
      <li class="external-link"><a href="https://bsky.app/intent/compose?text=Take%20a%20break:%20Rust%20match%20has%20fallthrough%20by%20@huonw.bsky.social%20https://huonw.github.io/blog/2025/03/rust-fallthrough/" target="_blank" rel="nofollow noopener" title="Share on Bluesky">Bluesky</a></li>
      <li class="external-link"><a href="https://twitter.com/intent/tweet?text=Take%20a%20break:%20Rust%20match%20has%20fallthrough%20%23rustlang&amp;url=https://huonw.github.io/blog/2025/03/rust-fallthrough/&amp;via=huon_w" target="_blank" rel="nofollow noopener" title="Share on Twitter">Twitter</a></li>
      <li class="external-link"><a href="https://facebook.com/sharer.php?u=https://huonw.github.io/blog/2025/03/rust-fallthrough/" rel="nofollow noopener" target="_blank" title="Share on Facebook">Facebook</a></li>
      <li class="external-link"><a href="https://www.reddit.com/submit?url=https://huonw.github.io/blog/2025/03/rust-fallthrough/&amp;title=Take%20a%20break:%20Rust%20match%20has%20fallthrough" rel="nofollow noopener" target="_blank" title="Share on Reddit">Reddit</a></li>
    </ul>
  </div>
</section>

<div class="footnotes" role="doc-endnotes">
  <ol start="0">
    <li id="fn:better">
      <p>There may be fundamentally-better ways to approach computing this value, completely different to the C-inspired versions in this post. <a href="#fnref:better" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
  </ol>
</div>

    </article>

    
    <div id="no-ai">This article is from a human: I used no AI to write it.</div>
    <footer id="more" class="no-print">
      <div id="by-line">
  <a href="/about"><div class="no-print" id="me-icon"></div></a>

<p>I'm <a href="https://bsky.app/profile/huonw.bsky.social"><strong>Huon Wilson</strong></a>, a
 mathematically and statistically inclined software engineer.
 I have been a long-term volunteer
 on <a href="http://rust-lang.org">Rust</a>'s core team, a
 compiler engineer on the <a href="https://swift.org/">Swift</a> team
 at Apple, and a senior software engineer at CSIRO's Data61, working on the <a href="https://github.com/stellargraph/stellargraph">StellarGraph
 graph machine learning library</a>.
</p>
</div>
      <h2 id="latest-heading"><a href="/blog">Latest posts</a></h2>
      
      <nav>
        <ul id="latest-list"><!--
           
           --><li class="latest-post">
                <a href="/blog/2025/12/magit-insert-worktrees/">
                   <h3>magit-insert-worktrees improves status buffers</h3>
                     <p>When using Emacs’ Magit and Git worktrees, adding the magit-insert-worktrees section inserter gives an nice overview of them in the status buffer.
</p>
                   
                 </a>
            </li><!--
          
           --><li class="latest-post">
                <a href="/blog/2025/12/typescript-monotonic/">
                   <h3>TypeScript strictness is non-monotonic: strict-null-checks and no-implicit-any interact</h3>
                     <p>A curiosity about the interaction between two TypeScript compiler settings, that lead to errors that appear and disappear, as one increases strictness.
</p>
                   
                 </a>
            </li><!--
          
           --><li class="latest-post">
                <a href="/blog/2025/11/piraite/">
                   <h3>Context privateering: debugging custom instructions like a pirate</h3>
                     <p>Adding “always speak like a pirate” to instructions for an AI tool is a helpful generic trick for debugging whether those instructions are being read correctly.
</p>
                   
                 </a>
            </li><!--
          
      --></ul>
      </nav>
    </footer>
    
  </main>

  <footer id="page-footer">
    <span>Huon Wilson &mdash; <span class="date">2026</span></span>
  </footer>
</div>



<!-- Default Statcounter code for huonw.github.io
http://huonw.github.io -->
<script type="text/javascript">
var sc_project=7439209;
var sc_invisible=1;
var sc_security="b96244c7";
</script>
<script type="text/javascript"
src="https://www.statcounter.com/counter/counter.js"
async></script>
<noscript><div class="statcounter"><a title="hit counter"
href="https://statcounter.com/" target="_blank"><img
class="statcounter"
src="https://c.statcounter.com/7439209/0/b96244c7/1/"
alt="hit counter"
referrerPolicy="no-referrer-when-downgrade"></a></div></noscript>
<!-- End of Statcounter Code -->

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-62534856-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-62534856-1');
</script>



</body> </html>
