<!DOCTYPE HTML>
<html lang="en">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>  Git worktrees and pyenv: developing Python libraries faster |  Huon on the internet</title>

  <link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Atom feed">
  <link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="RSS feed">
  
  <link rel="canonical" href="https://huonw.github.io/blog/2020/04/worktrees-and-pyenv/">

  <meta name="viewport" content="width=device-width; initial-scale=1.0;" />
  

  
  <meta name="description" content="Git worktrees and pyenv are effective tools to minimise the cost of a mental context switch when working on a Python library.
" />

  
  <meta name="twitter:card" content="summary" />
  
  <meta name="twitter:site" content="@huon_w" />
  <meta name="twitter:title" content="Git worktrees and pyenv: developing Python libraries faster" />
  <meta name="twitter:description" content="Git worktrees and pyenv are effective tools to minimise the cost of a mental context switch when working on a Python library.
" />
  <meta name="twitter:url" content="https://huonw.github.io/blog/2020/04/worktrees-and-pyenv/">

  <!-- facebook -->
  <meta property="og:url" content="https://huonw.github.io/blog/2020/04/worktrees-and-pyenv/" />
  <meta property="og:title" content="Git worktrees and pyenv: developing Python libraries faster" />
  <meta property="og:description" content="Git worktrees and pyenv are effective tools to minimise the cost of a mental context switch when working on a Python library.
" />
  
  <meta property="og:type" content="article" />
  
  
  
  <style>
    /*! modern-normalize v1.1.0 | MIT License | https://github.com/sindresorhus/modern-normalize */
*,::after,::before{box-sizing:border-box}html{line-height:1.15;-webkit-text-size-adjust:100%;-moz-tab-size:4;tab-size:4}body{margin:0;font-family:system-ui, -apple-system,'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji'}hr{height:0;color:inherit}abbr[title]{text-decoration:underline dotted}b,strong{font-weight:bolder}code,kbd,pre,samp{font-family:ui-monospace, SFMono-Regular, Consolas, 'Liberation Mono', Menlo, monospace;font-size:1em}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-0.25em}sup{top:-0.5em}table{text-indent:0;border-color:inherit}button,input,optgroup,select,textarea{font-family:inherit;font-size:100%;line-height:1.15;margin:0}button,select{text-transform:none}[type='button'],[type='reset'],[type='submit'],button{-webkit-appearance:button}::-moz-focus-inner{border-style:none;padding:0}:-moz-focusring{outline:1px dotted ButtonText}:-moz-ui-invalid{box-shadow:none}legend{padding:0}progress{vertical-align:baseline}::-webkit-inner-spin-button,::-webkit-outer-spin-button{height:auto}[type='search']{-webkit-appearance:textfield;outline-offset:-2px}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}summary{display:list-item}


    
      /* Borrowed from mojombo: https://github.com/mojombo/mojombo.github.com/blob/master/css/syntax.css */

.lineno { width: 2em; text-align:right; }
.highlight pre {
  white-space: pre;
}
.highlight .c { color: #777; font-style: italic; } /* Comment */
.highlight .err { color: #a61717; background-color: #e3d2d2 } /* Error */
.highlight .k { font-weight: bold } /* Keyword */
.highlight .o { font-weight: bold } /* Operator */
.highlight .cm { color: #999988; font-style: italic } /* Comment.Multiline */
.highlight .cp { color: #999999; font-weight: bold } /* Comment.Preproc */
.highlight .c1 { color: #999988; font-style: italic } /* Comment.Single */
.highlight .cs { color: #999999; font-weight: bold; font-style: italic } /* Comment.Special */
.highlight .gd { color: #000000; background-color: #ffdddd } /* Generic.Deleted */
.highlight .gd .x { color: #000000; background-color: #ffaaaa } /* Generic.Deleted.Specific */
.highlight .ge { font-style: italic } /* Generic.Emph */
.highlight .gr { color: #aa0000 } /* Generic.Error */
.highlight .gh { color: #999999 } /* Generic.Heading */
.highlight .gi { color: #000000; background-color: #ddffdd } /* Generic.Inserted */
.highlight .gi .x { color: #000000; background-color: #aaffaa } /* Generic.Inserted.Specific */
.highlight .go { color: #888888 } /* Generic.Output */
.highlight .gp { color: #555555 } /* Generic.Prompt */
.highlight .gs { font-weight: bold } /* Generic.Strong */
.highlight .gu { color: #aaaaaa } /* Generic.Subheading */
.highlight .gt { color: #aa0000 } /* Generic.Traceback */
.highlight .kc { font-weight: bold } /* Keyword.Constant */
.highlight .kd { font-weight: bold } /* Keyword.Declaration */
.highlight .kp { font-weight: bold } /* Keyword.Pseudo */
.highlight .kr { font-weight: bold } /* Keyword.Reserved */
.highlight .kt { color: #445588; font-weight: bold } /* Keyword.Type */
.highlight .m { color: #009999 } /* Literal.Number */
.highlight .s { color: #d14 } /* Literal.String */
.highlight .na { color: #008080 } /* Name.Attribute */
.highlight .nb { color: #0086B3 } /* Name.Builtin */
.highlight .nc { color: #445588; font-weight: bold } /* Name.Class */
.highlight .no { color: #008080 } /* Name.Constant */
.highlight .ni { color: #800080 } /* Name.Entity */
.highlight .ne { color: #990000; font-weight: bold } /* Name.Exception */
.highlight .nf { color: #990000; font-weight: bold } /* Name.Function */
.highlight .nn { color: #555555 } /* Name.Namespace */
.highlight .nt { color: #000080 } /* Name.Tag */
.highlight .nv { color: #008080 } /* Name.Variable */
.highlight .ow { font-weight: bold } /* Operator.Word */
.highlight .w { color: #bbbbbb } /* Text.Whitespace */
.highlight .mf { color: #009999 } /* Literal.Number.Float */
.highlight .mh { color: #009999 } /* Literal.Number.Hex */
.highlight .mi { color: #009999 } /* Literal.Number.Integer */
.highlight .mo { color: #009999 } /* Literal.Number.Oct */
.highlight .sb { color: #d14 } /* Literal.String.Backtick */
.highlight .sc { color: #d14 } /* Literal.String.Char */
.highlight .sd { color: #d14 } /* Literal.String.Doc */
.highlight .s2 { color: #d14 } /* Literal.String.Double */
.highlight .se { color: #d14 } /* Literal.String.Escape */
.highlight .sh { color: #d14 } /* Literal.String.Heredoc */
.highlight .si { color: #d14 } /* Literal.String.Interpol */
.highlight .sx { color: #d14 } /* Literal.String.Other */
.highlight .sr { color: #009926 } /* Literal.String.Regex */
.highlight .s1 { color: #d14 } /* Literal.String.Single */
.highlight .ss { color: #990073 } /* Literal.String.Symbol */
.highlight .bp { color: #999999 } /* Name.Builtin.Pseudo */
.highlight .vc { color: #008080 } /* Name.Variable.Class */
.highlight .vg { color: #008080 } /* Name.Variable.Global */
.highlight .vi { color: #008080 } /* Name.Variable.Instance */
.highlight .il { color: #009999 } /* Literal.Number.Integer.Long */


html {
    min-height:100%;
}

* {
  margin: 0;
}
* + * {
  margin-top: 0.75em;
}


body {
  padding:0px;
    counter-reset: footnotes;
    counter-reset: figure;
    margin:0px;
    font-size: 18px;
    background: white;
    color: #101010;

    font-variant: common-ligatures;
    -moz-font-feature-settings: "kern" on;
    -webkit-font-feature-settings: "kern" on;
    font-feature-settings: "kern" on;
}

#wrapper {
    margin: 0 auto;
    max-width: 630px;
    padding: 0.75em 15px;
    width: 100%;
    position:relative;
}

#no-ai {
    text-align: center;
    font-size: small;
}

.lazily-filled {
  position: relative;
}
.lazily-filled > * {
  z-index: 0;
}
.lazily-filled::before {
  position: absolute;
  top: 0;
  left: 0;
  content: "";
  width: 100%;
  height: 100%;
  display: block;
  background-color: rgb(229, 236, 246);
  z-index: 1;
}
.lazily-filled::after {
  position: absolute;
  top: 50%;
  left: 50%;
  content: "";
  display: block;
  width: 128px;
  height: 128px;
  margin-left: -64px;
  margin-top: -64px;
  border-radius: 50%;
  border: 12px solid;
  border-color: white transparent;
  animation: spinner 5s linear;
  /* eventually stop animating when it's hidden */
  animation-iteration-count: 10;
  z-index: 2;
}
.lazily-filled::before, .lazily-filled::after {
  opacity: 0;
  transition: all 0.5s ease;
  pointer-events: none;
}
.lazily-filled:empty::before, .lazily-filled:empty::after {
  opacity: 1;
  animation-iteration-count: infinite;
  visibility: visible;
}
@keyframes spinner {
  0% {
    transform: rotate(0deg);
  }
  100% {
    transform: rotate(360deg);
  }
}

.plotly-plot * + * {
  margin-top: 0;
}

/* wonky safari */
.plotly text[style*="white-space: pre"] {
  white-space: nowrap !important;
}


/* lists */
li + li {
  margin-top: 0.5em;
}
ul, ol {
  padding-left: 1.5em;
}

table {
  margin-left: auto;
  margin-right: auto;
  border-collapse: collapse;
  text-align: left;
}

/* ensure tables don't make the whole page scroll, NB. requires manual <div class="table-wrapper" markdown="1">...</div> due to https://github.com/gettalong/kramdown/issues/69 */
.table-wrapper {
  overflow-x: auto;
}

td, th {
  padding: 0.1em 0.75em;
}
@media (max-width: 500px) {
  td, th {
    padding-left: 0.375em;
    padding-right: 0.375em;
  }
}
tr:nth-child(even) {
  background: rgba(0, 0, 0, 5%);
}
thead {
  border-bottom: 1px solid grey;
  font-weight: bold;
}

header {
  margin-bottom: 1.5em;
}
header a:not(:hover) {
  text-decoration: none;
}
#blog-title {
  hyphens: none;
  font-variant: small-caps;
  font-size: 1.5em;
  font-weight: normal;
  text-align: center;
  line-height: 1em;
}
#info-list {
  list-style: none;
  padding: 0;
  display: flex;
  justify-content: center;
  flex-wrap: wrap;
  gap: 0.5em 2em;
}
#info-list li {
  margin: 0;
}

#page-footer {
  border-top: 1px solid lightgrey;
  padding-top: 0.75em;
  color: grey;
  text-align: right;
}

.clear { clear: both; margin: 0; }


main {
    line-height: 1.5em;

    position: relative;
    z-index: 10;
}

a[href] {
    color: inherit;
    text-decoration: underline;
}

/*  The authorship info */
#info-intro {
    font-style: italic;
    text-align: center;
}

/* code */

code, pre {
  font-family: monospace;
  font-variant: none;
  -moz-hyphens: none;
  -webkit-hyphens: none;
  -ms-hyphens: none;
  hyphens: none;
}

pre {
  background: #f0f0f0;
}
code {
    background: #f7f7f7;
    padding: 0 0.1em;
    font-size: 0.9em;
    border-radius: 3px;
    border: 1px solid lightgrey;
}
pre code {
    background: none;
    padding: 0;
    -moz-hyphens: none;
    -webkit-hyphens: none;
    -ms-hyphens: none;
    hyphens: none;
    border-radius: 0;
    border-width: 0;
}
h1 code, h2 code, h3 code, h4 code {
  background: rgba(255,255,255,0.1);
}

.break-all {
  word-break: break-all;
}

/* quotes and similar */

blockquote {
    border: solid #eee;
    border-width: 0 1px;
    padding: 0 1.2em;
    color: #444;
    position: relative;
    margin-left: 0;
    margin-right: 0;
}

aside {
  padding: 0 1.2em;
  color: #444;
  position: relative;
}
aside[data-icon] {
  padding-left: 2.4em;
}
aside[data-icon]:before {
  content: attr(data-icon);
  position: absolute;
  left: 0;
  text-align: center;
  width: 2.4em;
}

/* images/figures */
img, figure svg {
  max-width: 100%;
  height: auto;
}
figure svg {
  width: 100%;
}
img:not(.inline-image), figure svg {
    display: block;
    margin: 0 auto;
    clear: both;
}

.image-positioner {
  max-width: 800px;
  margin-left: auto;
  margin-right: auto;
}

img[data-caption]:before {
    content: attr(data-caption);
}
figure {
  clear: both;
}
figure.image {
  width: 100vw;
  position: relative;
  left: 50%;
  right: 50%;
  margin-left: -50vw;
  margin-right: -50vw;

  min-width: 100%;
}
figcaption {
  margin: 0 auto;
  max-width: 570px;
  padding: 0 10px;
  text-align: center;
  font-style: italic;
  font-size: 0.9em;
}
figcaption p {
  display: inline;
}
figcaption::before {
  counter-increment: figure;
  content: "Figure " counter(figure) ". ";
}

.highlight table {
  font-size: 0.9em;
  padding: 0em;
  width: 100%;
  table-layout: fixed;
  overflow-y: hidden;
  display: block;
  position: relative;
  z-index: 1;
}
[data-lang] {
  position: relative;
  display: block;
}
[data-lang]::before {
  content: attr(data-lang);
  text-transform: capitalize;
  top: 0;
  right: 0;
  position: absolute;
  font-size: 1.5em;
  color: #f3f3f3;
  z-index: 1;
}

.highlight pre {
  background: transparent;
}
.gutter {
  padding: 0;
  border: solid #ccc;
  border-width: 0 1px 0 0;
  color: #ccc;
}
.lineno {
  width: 25px;
  padding-right: 5px;
}
/* highlight/endhighlight code blocks */
figure.highlight td.code {
  overflow-x: auto;
  padding: 0;
  padding-left: 0.5em;
}
/* no-highlight/endhighlight code blocks (e.g. in footnotes) */
div.highlight {
  overflow-x: auto;
  padding: 0;
  padding-left: 0.5em;
}


/* HEADINGS */

h1, h2 {
    font-variant: small-caps;
}

h1, h2, h3, h4 {
  -moz-hyphens: none;
  -webkit-hyphens: none;
  -ms-hyphens: none;
  hyphens: none;
  text-align: left;
}

h1 {
  font-size: 2.2em;
  text-align: center;
  line-height: 1em;
}
h2 {
  font-size: 1.7em;
}
h3 {
  font-size: 1.4em;
}
h4 {
  font-size: 1.2em;
}

/* crates.io badges */

.lib-info {
  float: right;
  width: 150px;
  text-align: center;
  margin: 0 1em;
}
.lib-badge {
  vertical-align: middle;
}
.centered-libs {
  text-align: center;
}
.centered-libs .lib-info {
  float: none;
}

/* external links */

#external-links {
  margin-top: 2.25em;
  text-align: center;
}
.external-label {
  font-weight: bold;
}
#external-links ul {
  list-style: none;
  display: inline-block;
  padding: 0;
  margin: 0;
}
#external-links li {
  list-style: none;
  display: inline;
}

/* "Footnotes" */

/* the div that holds them */
.footnotes {
    margin-top: 2.25em;
    padding-top: 1.5em;
    border-top: 1px solid rgb(240,240,240);
    font-size: 0.9em;
}
.footnotes ol {
  padding: 0;
}
.footnotes li {
    list-style-position: outside;
    margin-left: 30px;
    margin-right: 10px;
    color: #333;
}

.footnotes li:target, .footnotes li:hover {
    color: black;
    background-color: lightyellow;
}

.footnotes .reversefootnote {
    text-decoration: none;
}

/* extra info after a post */
#more {
  margin-top: 3em;
  padding-top: 1.5em;
  border-top: 1px solid lightgray;
}
#me-icon {
  max-width: 150px;
  height: 150px;
  background: url("/img/me.jpg");
  background-size: cover;
  margin-left: auto;
  margin-right: auto;
  border-radius: 30px;
}
#by-line {
  font-size: 0.8em;
}
#latest-list {
  padding: 0;
  list-style: none;
}
#latest-heading {
  text-align: center;
}
#latest-heading a:not(:hover) {
  text-decoration: none;
}
#latest-list a:hover h3 {
  text-decoration: underline;
}
#latest-list a {
  text-decoration: none;
}
.latest-post {
  padding: 0;
  font-size: 0.8em;
}
.latest-post > h3 {
  font-weight: bold;
}
.latest-post * {
  margin: 0;
}

/* post series */

.post-series {
  font-size: 0.8em;
  border: 1px solid lightgray;
  padding: 0.2em;
  cursor: pointer;
}

.post-series-title {
  font-weight: bold;
  font-size: 1.1em;
}
.post-series-list {
  padding-left: 1.5em;
  margin: 0;
}
.post-series .current {
  font-style: italic;
}

/* archive pages */
ul.post-list {
  list-style: none;
  padding: 0;
}

.post-post + .post-post {
  margin-top: 2em;
}

.post-title {
  font-size: 1.2em;
}

.post-excerpt p {
  display: inline;
}

.post-date {
  font-style: italic;
  white-space: nowrap;
  float: right;
  margin: 0;
  margin-left: 3em;
  font-size: smaller;
}

.post-list .footnote, .post-list .footnotes, .post-list p:empty {
  display: none
}

.post-list-empty {
    text-align: center;
}

/* media queries */


@media only print {
    a {
      text-decoration: none !important;
    }
    header {
        display:none !important;
    }

    h1, h2, h3, h4 {
        padding-left: 0 !important;
    }

    #wrapper {
       max-width: none !important;
    }

    .no-print {
        display: none !important;
    }

    .footnotes .reversefootnote {
         display: none !important;
    }
    [data-lang]::before {
      content: "";
    }
}

    

    
  </style>
  
</head>

<body>
<div id="wrapper">
  <header>
    <h1 id="blog-title"><a href="/">Huon on the internet</a></h1>
    <nav>
      <ul id="info-list" class="no-print">
        <li><a href="/about">About</a></li>
        <li><a href="/blog">Blog</a></li>
        <li><a href="https://github.com/huonw">GitHub</a></li>
        <li><a href="https://bsky.app/profile/huonw.bsky.social">Bluesky</a></li>
      </ul>
    </nav>
  </header>
  <main>
    <article>
      
        <h1 id="title"> Git worktrees and pyenv: developing Python libraries faster</h1>
        
      
      
         <div id="info-intro">
           By <a href="/about">Huon Wilson</a>
           
             &mdash; <span class="date pub-date">15 Apr 2020</span>
           
           
         </div>
      
      <p>It’s glorious to work on one task at a time, to be able to take it from start to finish completely, and then move onto the next one. Sounds great, but reality is messier than that and context switches are common. Doing so can be annoying and inefficient, but <em>not</em> switching means tasks and colleagues are delayed. I combine <a href="https://git-scm.com/docs/git-worktree">git worktrees</a> and <a href="https://github.com/pyenv/pyenv">pyenv</a> (and plugins) to reduce the overhead of a context switch and keep development and collaboration as smooth as possible when working on a Python library.</p>

<p>Reducing the pain of a context switch allows me to work on many tasks concurrently: usually one or two large features with a few medium ones and a variety of small ones. My day typically involves working on the larger features for hours consecutively, and then either getting blocked or needing some time to think subconsciously, and thus pick up one of the smaller tasks.</p>

<h2 id="context">Context</h2>

<p>This post talks about how I use these tools in practice, in my work on the <a href="https://github.com/stellargraph/stellargraph">StellarGraph library</a> for <a href="https://medium.com/stellargraph/knowing-your-neighbours-machine-learning-on-graphs-9b7c3d0d5896?source=collection_home---6------7-----------------------">machine learning on graphs</a>. StellarGraph is a Python library built using TensorFlow 2, Keras and other common data science tools.</p>

<p>We take a fairly standard approach to developing and distributing the code, which means promptness and collaboration are important:</p>

<ul>
  <li><a href="https://github.com/stellargraph/stellargraph/tree/develop/demos">extensive demos</a> and documentation</li>
  <li>supporting multiple versions of Python (3.6 and 3.7)</li>
  <li>all changes happen via pull request (with <a href="https://github.com/stellargraph/stellargraph/pulse/monthly">70-100 per month</a>)
    <ul>
      <li>code review is required: a pull request cannot be merged without at least one approving review</li>
      <li>testing is also required: a pull request cannot be merged without passing <a href="https://buildkite.com/stellar/stellargraph-public/">continuous integration</a>, including <a href="https://medium.com/stellargraph/better-notebooks-through-ci-automatically-testing-documentation-for-graph-machine-learning-5789e277e597">validating the demos</a> (which all adds up to take a few minutes)</li>
    </ul>
  </li>
</ul>

<p>The <a href="https://www.stellargraph.io/">StellarGraph team</a> is a project of CSIRO’s Data61 that brings together engineers, data scientists, UX designers and researchers. I mostly fit into the first of those boxes and part of my role as an engineer on a mixed team is being a force multiplier: optimising or otherwise making the code more reliable, and improving the tooling &amp; processes listed above (and others), all so that others with less engineering experience or more research interest can use their strengths best.</p>

<p>This means my day is often broken up with:</p>

<ul>
  <li>reviewing others’ pull requests, so they’re not waiting for approvals and feedback; this sometimes involves checking out the pull request’s code locally to run it</li>
  <li>responding to code reviews on my own pull requests, to try to keep the “review cycle” as tight as possible; this usually involves editing the code in response</li>
  <li>doing small fixes for annoying <a href="https://en.wikipedia.org/wiki/Paper_cut_bug">paper cuts</a></li>
  <li>validating requirements and expectations for larger or more complicated features and bug fixes; this often involves doing a proof-of-concept implementation as a draft pull request</li>
</ul>

<p>All of these involve working with the repository’s code on my local machine, and all of them are typically short tasks, ranging from minutes to hours, not days like a new feature.</p>

<p>In addition to all of these code tasks, when I do finish a feature or bug fix, I then have to wait for code review from one of my colleagues: this is usually fast (at most a day or two), but, if I was trying to avoid context switching, it’s a long time to do no other work.</p>

<h2 id="sequential-development">Sequential development</h2>

<p>Suppose I’m working on feature A, but then notice paper cut B that would take a minute or two to fix, maybe a typo in documentation or a minor bug. This is something like the third situation above.</p>

<p>One approach is to just do the fix in the changes for feature A, so that the eventual pull request and code that lands combines both A and B. This is suboptimal, as it leads to:</p>
<ul>
  <li><strong>Slower code reviews</strong>: each review is larger, and it’s unclear what change was for what purpose so more detangling is required.</li>
  <li><strong>Less useful git history</strong>: if the combined A+B change appears in a <code class="language-plaintext highlighter-rouge">git blame</code> investigation, it’s just like looking at it in a code review except the author likely can’t answer questions about it, because they no longer remember (I certainly forget these sort of details quickly).</li>
  <li><strong>Slower landing</strong> of the useful small fixes: the fix for B gets caught up and delayed by the lengthier review of the A’s pull request.</li>
</ul>

<p>A better approach is to do this work on a separate branch, and thus in a separate pull request. Doing this concurrent work with a single copy of a repository is frustrating, because the book-keeping work required to do the fix dwarfs the actual effort to fix:</p>

<ol>
  <li>Save the state of my work-in-progress work on A’s branch <code class="language-plaintext highlighter-rouge">feature/A</code>, which means both:
    <ul>
      <li>the actual changes to files on disk (either with a “WIP” commit or <a href="https://www.git-scm.com/docs/git-stash">stash</a>, taking care to manage any relevant temporary or new files)</li>
      <li>any context that’s not directly stored in version control (such as where I’m editing in each file, or what I’m planning to do next)</li>
    </ul>
  </li>
  <li>Create and switch a new branch <code class="language-plaintext highlighter-rouge">bugfix/B</code>, do the fix for B, create a pull request for it</li>
  <li>Restore the A work, by switching back to the <code class="language-plaintext highlighter-rouge">feature/A</code> branch and then reapplying/remembering any other state from step 1</li>
</ol>

<p>The actual fix, step 2, is much easier and even faster than either of steps 1 or 3, which require remembering things about the code base while also remembering things about git (hard work!).</p>

<h2 id="concurrent-development">Concurrent development</h2>

<p>The list is much simpler if I have multiple parallel copies of the source code, each of which can be changed independently:</p>

<ol>
  <li>Change from the directory that has <code class="language-plaintext highlighter-rouge">feature/A</code> checked out to one that doesn’t have any work-in-progress work (or create a new copy)</li>
  <li>Create a new branch <code class="language-plaintext highlighter-rouge">bugfix/B</code>, do the fix for B, create a pull request for it</li>
  <li>Change back to the directory for <code class="language-plaintext highlighter-rouge">feature/A</code>, picking up where I left off (including things like the exact position for each file in my editor)</li>
</ol>

<p>The whole process takes about as long as step 2 itself because there’s little book-keeping. It doesn’t directly fix the “remember what I’m planning to do next” problem from the first version, but it does dramatically improve it: I find there’s minimal context switching from a “work on the code” mindset to a “manage git” one, and there’s less time to forget or get distracted because the whole process is faster.</p>

<p>Using separate directories has other benefits over switching branches too: it makes it easier for incremental compilation (and other tooling) to reduce work, although this doesn’t apply to Python so much<sup id="fnref:incremental-compilation"><a href="#fn:incremental-compilation" class="footnote" rel="footnote" role="doc-noteref">0</a></sup>;  and, I find it’s easier for me to find my code<sup id="fnref:branches"><a href="#fn:branches" class="footnote" rel="footnote" role="doc-noteref">1</a></sup>.</p>

<p>One way to implement this is to clone the repository multiple times into separate directories, like <code class="language-plaintext highlighter-rouge">...-1</code>, <code class="language-plaintext highlighter-rouge">...-2</code> and so on:</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="code"><pre>git clone <span class="s1">'git@github.com:stellargraph/stellargraph.git'</span> stellargraph-1
git clone <span class="s1">'git@github.com:stellargraph/stellargraph.git'</span> stellargraph-2
git clone <span class="s1">'git@github.com:stellargraph/stellargraph.git'</span> stellargraph-3
</pre></td></tr></tbody></table></code></pre></figure>

<p>I used this effectively for many years for a few different projects.</p>

<figure class="image has-caption">
  <div class="image-positioner">
    
    <a href="many_copies.png">
      <img src="many_copies.png" alt="a diagram showing four repositories: one labelled remote repository with the .git subdirectories of three local repositories pointing to it, labelled 1, 2, 3" />
    </a>
    
  </div>
  <figcaption><p>A stylised view of the structure of multiple clones of a single repository shows they are isolated from each other.</p>
</figcaption>
</figure>

<p>However, each copy is isolated, which leads to some problems in practice:</p>
<ul>
  <li>They each require the full git state, which is potentially large.</li>
  <li>They can end up with inconsistent state, especially about remote branches: <code class="language-plaintext highlighter-rouge">origin/master</code> in <code class="language-plaintext highlighter-rouge">stellargraph-1</code> may be different to <code class="language-plaintext highlighter-rouge">origin/master</code> in <code class="language-plaintext highlighter-rouge">stellargraph-2</code>, depending on when <code class="language-plaintext highlighter-rouge">git pull</code> or <code class="language-plaintext highlighter-rouge">git fetch</code> was run.</li>
  <li>There can be confusion about “where was that branch”, whenever I do switch away from a branch, because, by default, each branch only exists in the copy where it was created.</li>
</ul>

<h2 id="concurrent-development-with-worktrees">Concurrent development with worktrees</h2>

<p>A better way is to use <a href="https://git-scm.com/docs/git-worktree">multiple worktrees</a>. These behave almost identically to multiple independent clones, except they share a single <code class="language-plaintext highlighter-rouge">.git</code> directory with all its metadata. Therefore, each one has access to all branches (local or remote) and the state of each of those branches is the same in every copy.</p>

<p>A worktree can be created in a single command<sup id="fnref:magit"><a href="#fn:magit" class="footnote" rel="footnote" role="doc-noteref">2</a></sup>, similar to a <code class="language-plaintext highlighter-rouge">git clone</code>:</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="code"><pre><span class="nb">cd</span> /path/to/stellargraph-1
<span class="c"># now inside the repository that needs multiple copies</span>

git worktree add ../stellargraph-2 <span class="s1">'some-existing-branch'</span>
git worktree add ../stellargraph-3 <span class="nt">-b</span> <span class="s1">'some-new-branch'</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>The first argument to <code class="language-plaintext highlighter-rouge">add</code> is the (sibling) directory for the new worktree, and the second optional one is the name of the branch to checkout there (to start with). Each of these <code class="language-plaintext highlighter-rouge">stellargraph-...</code> directories acts like a normal git repository, and all the usual operations like creating or switching branches, committing and stashing work just fine.</p>

<figure class="image has-caption">
  <div class="image-positioner">
    
    <a href="worktrees.png">
      <img src="worktrees.png" alt="a diagram showing the same four repositories as before, except now the remote repository has an arrow only from the .git directory of the local repository 1, while 2 and 3 point to that .git directory" />
    </a>
    
  </div>
  <figcaption><p>The stylised view of worktrees shows that they all share a single main <code class="language-plaintext highlighter-rouge">.git</code> folder.</p>
</figcaption>
</figure>

<p>I use a fixed set of worktrees, numbered from 1 to 5 (at the moment).</p>

<p>An alternative (that I’ve never tried) is to have a worktree for individual branches. If we’re starting a new feature in a new branch <code class="language-plaintext highlighter-rouge">foo</code>, the system might look something like the following:</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="code"><pre>git worktree add ../stellargraph-foo <span class="nt">-b</span> foo
<span class="nb">cd</span> ../stellargraph-foo

<span class="c"># edit code...</span>
git push
<span class="c"># (repeat from 4 until finished)</span>

<span class="c"># finished, so the worktree isn't needed any more</span>
<span class="nb">cd</span> ..
<span class="nb">rm </span>stellargraph-foo
</pre></td></tr></tbody></table></code></pre></figure>

<p>I’ve used worktrees on all sorts of projects, including Scala, C++ and Rust. Python brings some special challenges.</p>

<h2 id="parallel-python-dependency-management">Parallel Python dependency management</h2>

<p>Multiple copies of a source tree is great, but also leads to some confusing circumstances if the state is mixed up. It can be easy to edit a file in the wrong directory, and then not understand why it’s not applying. I know I’ve spent time tracking down incorrect-location edits whenever there’s multiple copies of anything (functions, files, directories, …)!</p>

<figure class="image has-caption">
  <div class="image-positioner">
    
    <a href="https://xkcd.com/754/">
      <img src="dependencies.png" alt="an xkcd cartoon showing a stylised screenshot of a college course description. Course: CPSC 432. Description: intermediate compiler design, with a focus on dependency resolution. Prereqs: CPSC 432" />
    </a>
    
  </div>
  <figcaption><p>Dependency management is hard enough, without having to do 5 times at once</p>
</figcaption>
</figure>

<p>Python’s common approach to dependencies makes this worse: code needs to be run in the correct <a href="https://packaging.python.org/tutorials/installing-packages/#creating-virtual-environments">virtual environment</a>, which is, by default, managed separately to the current directory. Typically, each checkout would have its own virtual environment, in case there’s differences in the exact set of dependencies used, and to allow each copy to install its exact on-disk version of StellarGraph <a href="https://stackoverflow.com/a/35064498/1256624">with <code class="language-plaintext highlighter-rouge">--editable</code></a>.</p>

<p>A sequence in a terminal might look like:</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="code"><pre><span class="nb">cd</span> .../stellargraph-1
<span class="nb">.</span> venv/bin/activate
<span class="c"># do work, like running tests:</span>
pytest tests/

<span class="c"># finished there, let's move</span>
<span class="nb">cd</span> ../stellargraph-2
<span class="c"># run tests again</span>
pytest tests/
</pre></td></tr></tbody></table></code></pre></figure>

<p>Unfortunately, I’ve made a mistake there: the <code class="language-plaintext highlighter-rouge">pytest</code> run on line 9 is running with the virtual environment from the <code class="language-plaintext highlighter-rouge">stellargraph-1</code> worktree, not properly reflecting the state of the <code class="language-plaintext highlighter-rouge">stellargraph-2</code> source tree. I needed to run <code class="language-plaintext highlighter-rouge">. venv/bin/activate</code> again after the <code class="language-plaintext highlighter-rouge">cd</code> on line 7, using the <code class="language-plaintext highlighter-rouge">venv</code> directory in <code class="language-plaintext highlighter-rouge">stellargraph-2</code>.</p>

<h2 id="pyenv-to-the-rescue">pyenv to the rescue</h2>

<p>I solve this by using <a href="https://github.com/pyenv/pyenv">pyenv</a> and <a href="https://github.com/pyenv/pyenv-virtualenv">pyenv-virtualenv</a>. Instead of creating a virtual environment in each worktree (such as in a <code class="language-plaintext highlighter-rouge">venv</code> subdirectory), I create a pyenv virtual environment for each one and associate them using <code class="language-plaintext highlighter-rouge">pyenv local</code>. For example, for the <code class="language-plaintext highlighter-rouge">stellargraph-1</code> worktree, I ran something like:</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
</pre></td><td class="code"><pre>pyenv virtualenv 3.6.10 <span class="s1">'stellargraph-1'</span>
pyenv <span class="nb">local</span> <span class="s1">'stellargraph-1'</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>After doing this, any command that uses <code class="language-plaintext highlighter-rouge">python</code> or <code class="language-plaintext highlighter-rouge">pip</code> (like <code class="language-plaintext highlighter-rouge">pip install --editable .</code> or <code class="language-plaintext highlighter-rouge">pytest</code>) anywhere within the <code class="language-plaintext highlighter-rouge">stellargraph-1</code> worktree will automatically use the <code class="language-plaintext highlighter-rouge">stellargraph-1</code> virtual environment<sup id="fnref:other-libraries"><a href="#fn:other-libraries" class="footnote" rel="footnote" role="doc-noteref">3</a></sup>: I don’t need to manually activate or deactivate the virtual environments, cutting out a major piece of human error.</p>

<p>Using pyenv for version management has other benefits too:</p>

<ul>
  <li><a href="https://github.com/aiguofer/pyenv-jupyter-kernel">pyenv-jupyter-kernel</a> allows for automatically registering each virtual environments with <a href="https://jupyter.org/">Jupyter</a>, making it easy to test features and bug fixes in a notebook, and, more importantly, work on <a href="https://github.com/stellargraph/stellargraph/tree/develop/demos">StellarGraph’s demos</a>.</li>
  <li>virtual environments can be easily created for different versions of Python (replace <code class="language-plaintext highlighter-rouge">3.6.10</code> with <code class="language-plaintext highlighter-rouge">3.7.7</code>). For instance, I have <code class="language-plaintext highlighter-rouge">stellargraph-1-3_7</code> to also test/compare with Python 3.7 in the <code class="language-plaintext highlighter-rouge">stellargraph-1</code> worktree (I do not use these ones with <code class="language-plaintext highlighter-rouge">pyenv local</code>, just <code class="language-plaintext highlighter-rouge">pyenv shell</code>, which does require manual activation and deactivation).</li>
</ul>

<h2 id="wrapping-up">Wrapping up</h2>

<p>I use git worktrees to have parallel copies of the StellarGraph Python library that share git metadata, and pyenv &amp; pyenv-virtualenv to manage the Python virtual environments for each. This reduces the overhead of switching contexts, and so makes it easier for me to do more work and collaborate efficiently, by fitting small fixes into the gaps around big features.</p>

<section id="external-links" class="no-print">
  
  <div id="external-page">
    <span class="external-label">Share this on</span>
    <ul class="external-list">
      <li class="external-link"><a href="https://bsky.app/intent/compose?text=Git%20worktrees%20and%20pyenv:%20developing%20Python%20libraries%20faster%20by%20@huonw.bsky.social%20https://huonw.github.io/blog/2020/04/worktrees-and-pyenv/" target="_blank" rel="nofollow noopener" title="Share on Bluesky">Bluesky</a></li>
      <li class="external-link"><a href="https://twitter.com/intent/tweet?text=Git%20worktrees%20and%20pyenv:%20developing%20Python%20libraries%20faster%20%23rustlang&amp;url=https://huonw.github.io/blog/2020/04/worktrees-and-pyenv/&amp;via=huon_w" target="_blank" rel="nofollow noopener" title="Share on Twitter">Twitter</a></li>
      <li class="external-link"><a href="https://facebook.com/sharer.php?u=https://huonw.github.io/blog/2020/04/worktrees-and-pyenv/" rel="nofollow noopener" target="_blank" title="Share on Facebook">Facebook</a></li>
      <li class="external-link"><a href="https://www.reddit.com/submit?url=https://huonw.github.io/blog/2020/04/worktrees-and-pyenv/&amp;title=Git%20worktrees%20and%20pyenv:%20developing%20Python%20libraries%20faster" rel="nofollow noopener" target="_blank" title="Share on Reddit">Reddit</a></li>
    </ul>
  </div>
</section>

<div class="footnotes" role="doc-endnotes">
  <ol start="0">
    <li id="fn:incremental-compilation">
      <p>Switching branches will update the contents of files on disk, which looks like a modification of those files, even if all of those changes were undone when restoring the original files in step 3. Tools that monitor for modifications to reduce work will get confused by the “switch, …, switch back” and spuriously do more work: separate directories avoids this entirely</p>

      <p>Many Python projects (including StellarGraph) don’t need to worrying about to refreshing/rebuilding state associated a source tree, because they often don’t have any compiled artifacts or other generated state associated with a branch. The code runs directly from the source files, without any compilation or preprocessing.</p>

      <p>In a compiled languages like Scala or C++, I’ve found this benefit much more important: builds are much faster when they can be incremental, just updating the artifacts associated with the (small number of) source files that I actually changed. If switching branches and then back spuriously modifies-then-unmodifies a lot of files (or a file with a lot of dependents), the first build after doing that may be much slower than an incremental build for the real changes, without any branch switching. <a href="#fnref:incremental-compilation" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:branches">
      <p>I always forget to delete branches after finishing with them, so I end up with dozens (or hundreds…) of local branches associated with closed and merge pull requests. These interfere with tab completion, requiring me to remember a significant amount of the name for <code class="language-plaintext highlighter-rouge">git checkout ...</code>. I find it’s easier to remember which of a handful of checkouts holds the relevant code, and even when I do forget, a brute-force approach of checking every copy is fast (skipping ahead, this is even faster with worktrees, with <code class="language-plaintext highlighter-rouge">git worktree list</code>). In some ways, this benefit is treating a symptom, not the disease… but it works for me. <a href="#fnref:branches" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:magit">
      <p>I usually use git via <a href="https://magit.vc/">magit</a> in Emacs, where these creation commands are <code class="language-plaintext highlighter-rouge">% b</code> or <code class="language-plaintext highlighter-rouge">% c</code> in the magit status buffer, and jumping between worktrees is <code class="language-plaintext highlighter-rouge">% g</code> (<a href="https://magit.vc/manual/magit.html#Worktree">relevant docs</a>). <a href="#fnref:magit" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:other-libraries">
      <p>Using pyenv for virtual environments is great for working on multiple separate libraries/code bases, even without multiple copies. The process is exactly the same: <code class="language-plaintext highlighter-rouge">pyenv virtualenv ...</code> to initialise the environment, and <code class="language-plaintext highlighter-rouge">pyenv local</code> to associate a directory with the virtual environment. <a href="#fnref:other-libraries" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
  </ol>
</div>

    </article>

    
    <div id="no-ai">This article is from a human: I used no AI to write it.</div>
    <footer id="more" class="no-print">
      <div id="by-line">
  <a href="/about"><div class="no-print" id="me-icon"></div></a>

<p>I'm <a href="https://bsky.app/profile/huonw.bsky.social"><strong>Huon Wilson</strong></a>, a
 mathematically and statistically inclined software engineer.
 I have been a long-term volunteer
 on <a href="http://rust-lang.org">Rust</a>'s core team, a
 compiler engineer on the <a href="https://swift.org/">Swift</a> team
 at Apple, and a senior software engineer at CSIRO's Data61, working on the <a href="https://github.com/stellargraph/stellargraph">StellarGraph
 graph machine learning library</a>.
</p>
</div>
      <h2 id="latest-heading"><a href="/blog">Latest posts</a></h2>
      
      <nav>
        <ul id="latest-list"><!--
           
           --><li class="latest-post">
                <a href="/blog/2025/12/magit-insert-worktrees/">
                   <h3>magit-insert-worktrees improves status buffers</h3>
                     <p>When using Emacs’ Magit and Git worktrees, adding the magit-insert-worktrees section inserter gives an nice overview of them in the status buffer.
</p>
                   
                 </a>
            </li><!--
          
           --><li class="latest-post">
                <a href="/blog/2025/12/typescript-monotonic/">
                   <h3>TypeScript strictness is non-monotonic: strict-null-checks and no-implicit-any interact</h3>
                     <p>A curiosity about the interaction between two TypeScript compiler settings, that lead to errors that appear and disappear, as one increases strictness.
</p>
                   
                 </a>
            </li><!--
          
           --><li class="latest-post">
                <a href="/blog/2025/11/piraite/">
                   <h3>Context privateering: debugging custom instructions like a pirate</h3>
                     <p>Adding “always speak like a pirate” to instructions for an AI tool is a helpful generic trick for debugging whether those instructions are being read correctly.
</p>
                   
                 </a>
            </li><!--
          
      --></ul>
      </nav>
    </footer>
    
  </main>

  <footer id="page-footer">
    <span>Huon Wilson &mdash; <span class="date">2026</span></span>
  </footer>
</div>



<!-- Default Statcounter code for huonw.github.io
http://huonw.github.io -->
<script type="text/javascript">
var sc_project=7439209;
var sc_invisible=1;
var sc_security="b96244c7";
</script>
<script type="text/javascript"
src="https://www.statcounter.com/counter/counter.js"
async></script>
<noscript><div class="statcounter"><a title="hit counter"
href="https://statcounter.com/" target="_blank"><img
class="statcounter"
src="https://c.statcounter.com/7439209/0/b96244c7/1/"
alt="hit counter"
referrerPolicy="no-referrer-when-downgrade"></a></div></noscript>
<!-- End of Statcounter Code -->

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-62534856-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-62534856-1');
</script>



</body> </html>
